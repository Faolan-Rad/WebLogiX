(()=>{var t={842:function(t,e,s){var o=s(155);!function(t){var e=t.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,registerNodeType:function(t,i){if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,e.debug&&console.log("Node registered: "+t),t.split("/");var s=i.name,o=t.lastIndexOf("/");if(i.category=t.substr(0,o),i.title||(i.title=s),i.prototype)for(var n in r.prototype)i.prototype[n]||(i.prototype[n]=r.prototype[n]);var a=this.registered_node_types[t];if(a)console.log("replacing node type: "+t);else if(Object.hasOwnProperty(i.prototype,"shape")||Object.defineProperty(i.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=e.BOX_SHAPE;break;case"round":this._shape=e.ROUND_SHAPE;break;case"circle":this._shape=e.CIRCLE_SHAPE;break;case"card":this._shape=e.CARD_SHAPE;break;default:this._shape=t}},get:function(t){return this._shape},enumerable:!0,configurable:!0}),i.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),i.supported_extensions)for(var n in i.supported_extensions)(u=i.supported_extensions[n])&&u.constructor===String&&(this.node_types_by_file_extension[u.toLowerCase()]=i);if(this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[s]=i),e.onNodeTypeRegistered&&e.onNodeTypeRegistered(t,i),a&&e.onNodeTypeReplaced&&e.onNodeTypeReplaced(t,i,a),i.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),i.supported_extensions)for(n=0;n<i.supported_extensions.length;n++){var u;(u=i.supported_extensions[n])&&u.constructor===String&&(this.node_types_by_file_extension[u.toLowerCase()]=i)}},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},wrapFunctionAsNode:function(t,i,s,o,r){for(var n=Array(i.length),a="",u=e.getParameterNames(i),h=0;h<u.length;++h)a+="this.addInput('"+u[h]+"',"+(s&&s[h]?"'"+s[h]+"'":"0")+");\n";a+="this.addOutput('out',"+(o?"'"+o+"'":0)+");\n",r&&(a+="this.properties = "+JSON.stringify(r)+";\n");var p=Function(a);p.title=t.split("/").pop(),p.desc="Generated from "+i.name,p.prototype.onExecute=function(){for(var t=0;t<n.length;++t)n[t]=this.getInputData(t);var e=i.apply(this,n);this.setOutputData(0,e)},this.registerNodeType(t,p)},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var i in r.prototype[t]=e,this.registered_node_types){var s=this.registered_node_types[i];s.prototype[t]&&(s.prototype["_"+t]=s.prototype[t]),s.prototype[t]=e}},createNode:function(t,i,s){var o=this.registered_node_types[t];if(!o)return e.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;o.prototype,i=i||o.title||t;var r=null;if(e.catch_exceptions)try{r=new o(i)}catch(t){return console.error(t),null}else r=new o(i);if(r.type=t,!r.title&&i&&(r.title=i),r.properties||(r.properties={}),r.properties_info||(r.properties_info=[]),r.flags||(r.flags={}),r.size||(r.size=r.computeSize()),r.pos||(r.pos=e.DEFAULT_POSITION.concat()),r.mode||(r.mode=e.ALWAYS),s)for(var n in s)r[n]=s[n];return r},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var i=[];for(var s in this.registered_node_types){var o=this.registered_node_types[s];o.filter==e&&(""==t?null==o.category&&i.push(o):o.category==t&&i.push(o))}return this.auto_sort_node_types?i.sort():i},getNodeTypesCategories:function(t){var e={"":1};for(var i in this.registered_node_types){var s=this.registered_node_types[i];if(s.category&&!s.skip_list){if(s.filter!=t)continue;e[s.category]=1}}var o=[];for(var i in e)o.push(i);return this.auto_sort_node_types?o.sort():o},reloadNodes:function(t){for(var i=document.getElementsByTagName("script"),s=[],o=0;o<i.length;o++)s.push(i[o]);var r=document.getElementsByTagName("head")[0];for(t=document.location.href+t,o=0;o<s.length;o++){var n=s[o].src;if(n&&n.substr(0,t.length)==t)try{e.debug&&console.log("Reloading: "+n);var a=document.createElement("script");a.type="text/javascript",a.src=n,r.appendChild(a),r.removeChild(s[o])}catch(t){if(e.throw_errors)throw t;e.debug&&console.log("Error while reloading "+n)}}e.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var i=JSON.parse(JSON.stringify(t));if(!e)return i;for(var s in i)e[s]=i[s];return e},isValidConnection:function(t,i){if(!t||!i||t==i||t==e.EVENT&&i==e.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),-1==t.indexOf(",")&&-1==i.indexOf(","))return t==i;for(var s=t.split(","),o=i.split(","),r=0;r<s.length;++r)for(var n=0;n<o.length;++n)if(s[r]==o[n])return!0;return!1},registerSearchboxExtra:function(t,e,i){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:i}},fetchFile:function(t,i,s,o){if(!t)return null;if(i=i||"text",t.constructor===String)return"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then((function(t){if(!t.ok)throw new Error("File not found");return"arraybuffer"==i?t.arrayBuffer():"text"==i||"string"==i?t.text():"json"==i?t.json():"blob"==i?t.blob():void 0})).then((function(t){s&&s(t)})).catch((function(e){console.error("error fetching file:",t),o&&o(e)}));if(t.constructor===File||t.constructor===Blob){var r=new FileReader;if(r.onload=function(t){var e=t.target.result;"json"==i&&(e=JSON.parse(e)),s&&s(e)},"arraybuffer"==i)return r.readAsArrayBuffer(t);if("text"==i||"json"==i)return r.readAsText(t);if("blob"==i)return r.readAsBinaryString(t)}return null}};function i(t){e.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function s(t,e,i,s,o,r){this.id=t,this.type=e,this.origin_id=i,this.origin_slot=s,this.target_id=o,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}function r(t){this._ctor(t)}function n(t){this._ctor(t)}function a(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function u(t,i,s){s=s||{},this.background_image=u.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new a,this.zoom_modify_alpha=!0,this.title_text_font=e.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+e.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=e.NODE_TITLE_COLOR,this.default_link_color=e.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=e.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],i&&i.attachCanvas(this),this.setCanvas(t),this.clear(),s.skip_render||this.startRendering(),this.autoresize=s.autoresize}"undefined"!=typeof performance?e.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?e.getTime=Date.now.bind(Date):e.getTime=void 0!==o?function(){var t=o.hrtime();return.001*t[0]+1e-6*t[1]}:function(){return(new Date).getTime()},t.LGraph=e.LGraph=i,i.supported_types=["number","string","boolean"],i.prototype.getSupportedTypes=function(){return this.supported_types||i.supported_types},i.STATUS_STOPPED=1,i.STATUS_RUNNING=2,i.prototype.clear=function(){if(this.stop(),this.status=i.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},i.prototype.attachCanvas=function(t){if(t.constructor!=u)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},i.prototype.detachCanvas=function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!=e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}},i.prototype.start=function(t){if(this.status!=i.STATUS_RUNNING){this.status=i.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=e.getTime(),this.last_update_time=this.starttime;var s=this;0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,function t(){-1==s.execution_timer_id&&(window.requestAnimationFrame(t),s.onBeforeStep&&s.onBeforeStep(),s.runStep(1,!s.catch_errors),s.onAfterStep&&s.onAfterStep())}()):this.execution_timer_id=setInterval((function(){s.onBeforeStep&&s.onBeforeStep(),s.runStep(1,!s.catch_errors),s.onAfterStep&&s.onAfterStep()}),t)}},i.prototype.stop=function(){this.status!=i.STATUS_STOPPED&&(this.status=i.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},i.prototype.runStep=function(t,i,s){t=t||1;var o=e.getTime();this.globaltime=.001*(o-this.starttime);var r=this._nodes_executable?this._nodes_executable:this._nodes;if(r){if(s=s||r.length,i){for(var n=0;n<t;n++){for(var a=0;a<s;++a)(u=r[a]).mode==e.ALWAYS&&u.onExecute&&u.onExecute();this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(n=0;n<t;n++){for(a=0;a<s;++a){var u;(u=r[a]).mode==e.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,e.throw_errors)throw t;e.debug&&console.log("Error during execution: "+t),this.stop()}var h=e.getTime(),p=h-o;0==p&&(p=1),this.execution_time=.001*p,this.globaltime+=.001*p,this.iteration+=1,this.elapsed_time=.001*(h-this.last_update_time),this.last_update_time=h}},i.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},i.prototype.computeExecutionOrder=function(t,i){for(var s=[],o=[],r={},n={},a={},u=0,h=this._nodes.length;u<h;++u){var p=this._nodes[u];if(!t||p.onExecute){r[p.id]=p;var l=0;if(p.inputs)for(var d=0,c=p.inputs.length;d<c;d++)p.inputs[d]&&null!=p.inputs[d].link&&(l+=1);0==l?(o.push(p),i&&(p._level=1)):(i&&(p._level=0),a[p.id]=l)}}for(;0!=o.length;)if(p=o.shift(),s.push(p),delete r[p.id],p.outputs)for(u=0;u<p.outputs.length;u++){var _=p.outputs[u];if(null!=_&&null!=_.links&&0!=_.links.length)for(d=0;d<_.links.length;d++){var g=_.links[d],f=this.links[g];if(f&&!n[f.id]){var v=this.getNodeById(f.target_id);null!=v?(i&&(!v._level||v._level<=p._level)&&(v._level=p._level+1),n[f.id]=!0,a[v.id]-=1,0==a[v.id]&&o.push(v)):n[f.id]=!0}}}for(var u in r)s.push(r[u]);for(s.length!=this._nodes.length&&e.debug&&console.warn("something went wrong, nodes missing"),h=s.length,u=0;u<h;++u)s[u].order=u;for(s=s.sort((function(t,e){var i=t.constructor.priority||t.priority||0,s=e.constructor.priority||e.priority||0;return i==s?t.order-e.order:i-s})),u=0;u<h;++u)s[u].order=u;return s},i.prototype.getAncestors=function(t){for(var e=[],i=[t],s={};i.length;){var o=i.shift();if(o.inputs){s[o.id]||o==t||(s[o.id]=!0,e.push(o));for(var r=0;r<o.inputs.length;++r){var n=o.getInputNode(r);n&&-1==e.indexOf(n)&&i.push(n)}}}return e.sort((function(t,e){return t.order-e.order})),e},i.prototype.arrange=function(t){t=t||100;for(var i=this.computeExecutionOrder(!1,!0),s=[],o=0;o<i.length;++o){var r=(l=i[o])._level||1;s[r]||(s[r]=[]),s[r].push(l)}var n=t;for(o=0;o<s.length;++o){var a=s[o];if(a){for(var u=100,h=t+e.NODE_TITLE_HEIGHT,p=0;p<a.length;++p){var l;(l=a[p]).pos[0]=n,l.pos[1]=h,l.size[0]>u&&(u=l.size[0]),h+=l.size[1]+t+e.NODE_TITLE_HEIGHT}n+=u+t}}this.setDirtyCanvas(!0,!0)},i.prototype.getTime=function(){return this.globaltime},i.prototype.getFixedTime=function(){return this.fixedtime},i.prototype.getElapsedTime=function(){return this.elapsed_time},i.prototype.sendEventToAllNodes=function(t,i,s){s=s||e.ALWAYS;var o=this._nodes_in_order?this._nodes_in_order:this._nodes;if(o)for(var r=0,n=o.length;r<n;++r){var a=o[r];a.constructor!==e.Subgraph||"onExecute"==t?a[t]&&a.mode==s&&(void 0===i?a[t]():i&&i.constructor===Array?a[t].apply(a,i):a[t](i)):a.mode==s&&a.sendEventToAllNodes(t,i,s)}},i.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var s=this.list_of_graphcanvas[i];s[t]&&s[t].apply(s,e)}},i.prototype.add=function(t,i){if(t){if(t.constructor===n)return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,void this._version++;if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=e.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}},i.prototype.remove=function(t){if(t.constructor===e.LGraphGroup){var i=this._groups.indexOf(t);return-1!=i&&this._groups.splice(i,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(t.inputs)for(var s=0;s<t.inputs.length;s++)null!=(o=t.inputs[s]).link&&t.disconnectInput(s);if(t.outputs)for(s=0;s<t.outputs.length;s++){var o;null!=(o=t.outputs[s]).links&&o.links.length&&t.disconnectOutput(s)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(s=0;s<this.list_of_graphcanvas.length;++s){var r=this.list_of_graphcanvas[s];r.selected_nodes[t.id]&&delete r.selected_nodes[t.id],r.node_dragged==t&&(r.node_dragged=null)}var n=this._nodes.indexOf(t);-1!=n&&this._nodes.splice(n,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}},i.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},i.prototype.findNodesByClass=function(t,e){(e=e||[]).length=0;for(var i=0,s=this._nodes.length;i<s;++i)this._nodes[i].constructor===t&&e.push(this._nodes[i]);return e},i.prototype.findNodesByType=function(t,e){t=t.toLowerCase(),(e=e||[]).length=0;for(var i=0,s=this._nodes.length;i<s;++i)this._nodes[i].type.toLowerCase()==t&&e.push(this._nodes[i]);return e},i.prototype.findNodeByTitle=function(t){for(var e=0,i=this._nodes.length;e<i;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},i.prototype.findNodesByTitle=function(t){for(var e=[],i=0,s=this._nodes.length;i<s;++i)this._nodes[i].title==t&&e.push(this._nodes[i]);return e},i.prototype.getNodeOnPos=function(t,e,i,s){for(var o=(i=i||this._nodes).length-1;o>=0;o--){var r=i[o];if(r.isPointInside(t,e,s))return r}return null},i.prototype.getGroupOnPos=function(t,e){for(var i=this._groups.length-1;i>=0;i--){var s=this._groups[i];if(s.isPointInside(t,e,2,!0))return s}return null},i.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var i=this._nodes[t],s=e.registered_node_types[i.type];if(i.constructor!=s){console.log("node being replaced by newer version: "+i.type);var o=e.createNode(i.type);this._nodes[t]=o,o.configure(i.serialize()),o.graph=this,this._nodes_by_id[o.id]=o,i.inputs&&(o.inputs=i.inputs.concat()),i.outputs&&(o.outputs=i.outputs.concat())}}this.updateExecutionOrder()},i.prototype.onAction=function(t,i){this._input_nodes=this.findNodesByClass(e.GraphInput,this._input_nodes);for(var s=0;s<this._input_nodes.length;++s){var o=this._input_nodes[s];if(o.properties.name==t){o.onAction(t,i);break}}},i.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},i.prototype.addInput=function(t,e,i){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:i},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},i.prototype.setInputData=function(t,e){var i=this.inputs[t];i&&(i.value=e)},i.prototype.getInputData=function(t){var e=this.inputs[t];return e?e.value:null},i.prototype.renameInput=function(t,e){if(e!=t){if(!this.inputs[t])return!1;if(this.inputs[e])return console.error("there is already one input with that name"),!1;this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},i.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},i.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.addOutput=function(t,e,i){this.outputs[t]={name:t,type:e,value:i},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},i.prototype.setOutputData=function(t,e){var i=this.outputs[t];i&&(i.value=e)},i.prototype.getOutputData=function(t){var e=this.outputs[t];return e?e.value:null},i.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},i.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},i.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.triggerInput=function(t,e){for(var i=this.findNodesByTitle(t),s=0;s<i.length;++s)i[s].onTrigger(e)},i.prototype.setCallback=function(t,e){for(var i=this.findNodesByTitle(t),s=0;s<i.length;++s)i[s].setTrigger(e)},i.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},i.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},i.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},i.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1},i.prototype.clearTriggeredSlots=function(){for(var t in this.links){var e=this.links[t];e&&e._last_time&&(e._last_time=0)}},i.prototype.change=function(){e.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},i.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},i.prototype.removeLink=function(t){var e=this.links[t];if(e){var i=this.getNodeById(e.target_id);i&&i.disconnectInput(e.target_slot)}},i.prototype.serialize=function(){for(var t=[],i=0,o=this._nodes.length;i<o;++i)t.push(this._nodes[i].serialize());var r=[];for(var i in this.links){var n=this.links[i];if(!n.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var a=new s;for(var u in n)a[u]=n[u];this.links[i]=a,n=a}r.push(n.serialize())}var h=[];for(i=0;i<this._groups.length;++i)h.push(this._groups[i].serialize());var p={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:r,groups:h,config:this.config,extra:this.extra,version:e.VERSION};return this.onSerialize&&this.onSerialize(p),p},i.prototype.configure=function(t,i){if(t){i||this.clear();var o=t.nodes;if(t.links&&t.links.constructor===Array){for(var n=[],a=0;a<t.links.length;++a){var u=t.links[a];if(u){var h=new s;h.configure(u),n[h.id]=h}else console.warn("serialized graph link data contains errors, skipping.")}t.links=n}for(var a in t)"nodes"!=a&&"groups"!=a&&(this[a]=t[a]);var p=!1;if(this._nodes=[],o){a=0;for(var l=o.length;a<l;++a){var d=o[a];(c=e.createNode(d.type,d.title))||(e.debug&&console.log("Node not found or has errors: "+d.type),(c=new r).last_serialization=d,c.has_errors=!0,p=!0),c.id=d.id,this.add(c,!0)}for(a=0,l=o.length;a<l;++a){var c;d=o[a],(c=this.getNodeById(d.id))&&c.configure(d)}}if(this._groups.length=0,t.groups)for(a=0;a<t.groups.length;++a){var _=new e.LGraphGroup;_.configure(t.groups[a]),this.add(_)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),p}},i.prototype.load=function(t,e){var i=this;if(t.constructor===File||t.constructor===Blob){var s=new FileReader;return s.addEventListener("load",(function(t){var s=JSON.parse(t.target.result);i.configure(s),e&&e()})),void s.readAsText(t)}var o=new XMLHttpRequest;o.open("GET",t,!0),o.send(null),o.onload=function(t){if(200===o.status){var s=JSON.parse(o.response);i.configure(s),e&&e()}else console.error("Error loading graph:",o.status,o.response)},o.onerror=function(t){console.error("Error loading graph:",t)}},i.prototype.onNodeTrace=function(t,e,i){},s.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},s.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},e.LLink=s,t.LGraphNode=e.LGraphNode=r,r.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[e.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},r.prototype.configure=function(t){for(var i in this.graph&&this.graph._version++,t)if("properties"!=i)null!=t[i]&&("object"==typeof t[i]?this[i]&&this[i].configure?this[i].configure(t[i]):this[i]=e.cloneObject(t[i],this[i]):this[i]=t[i]);else for(var s in t.properties)this.properties[s]=t.properties[s],this.onPropertyChanged&&this.onPropertyChanged(s,t.properties[s]);if(t.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var o=0;o<this.inputs.length;++o){var r=this.inputs[o],n=this.graph?this.graph.links[r.link]:null;this.onConnectionsChange(e.INPUT,o,!0,n,r)}if(this.outputs)for(o=0;o<this.outputs.length;++o){var a=this.outputs[o];if(a.links)for(i=0;i<a.links.length;++i)n=this.graph?this.graph.links[a.links[i]]:null,this.onConnectionsChange(e.OUTPUT,o,!0,n,a)}}if(this.widgets){for(o=0;o<this.widgets.length;++o){var u=this.widgets[o];u&&u.options&&u.options.property&&this.properties[u.options.property]&&(u.value=JSON.parse(JSON.stringify(this.properties[u.options.property])))}if(t.widgets_values)for(o=0;o<t.widgets_values.length;++o)this.widgets[o]&&(this.widgets[o].value=t.widgets_values[o])}this.onConfigure&&this.onConfigure(t)},r.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:e.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===r&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var i=0;i<this.outputs.length;i++)delete this.outputs[i]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=e.cloneObject(this.properties)),this.widgets&&this.serialize_widgets)for(t.widgets_values=[],i=0;i<this.widgets.length;++i)this.widgets[i]?t.widgets_values[i]=this.widgets[i].value:t.widgets_values[i]=null;return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},r.prototype.clone=function(){var t=e.createNode(this.type);if(!t)return null;var i=e.cloneObject(this.serialize());if(i.inputs)for(var s=0;s<i.inputs.length;++s)i.inputs[s].link=null;if(i.outputs)for(s=0;s<i.outputs.length;++s)i.outputs[s].links&&(i.outputs[s].links.length=0);return delete i.id,t.configure(i),t},r.prototype.toString=function(){return JSON.stringify(this.serialize())},r.prototype.getTitle=function(){return this.title||this.constructor.title},r.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var i=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,i)&&(this.properties[t]=i),this.widgets)for(var s=0;s<this.widgets.length;++s){var o=this.widgets[s];if(o&&o.options.property==t){o.value=e;break}}}},r.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i._data=e,this.outputs[t].links))for(var s=0;s<this.outputs[t].links.length;s++){var o=this.outputs[t].links[s],r=this.graph.links[o];r&&(r.data=e)}}},r.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.type=e,this.outputs[t].links))for(var s=0;s<this.outputs[t].links.length;s++){var o=this.outputs[t].links[s];this.graph.links[o].type=e}}},r.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)){var i=this.inputs[t].link,s=this.graph.links[i];if(!s)return null;if(!e)return s.data;var o=this.graph.getNodeById(s.origin_id);return o?(o.updateOutputData?o.updateOutputData(s.origin_slot):o.onExecute&&o.onExecute(),s.data):s.data}},r.prototype.getInputDataType=function(t){if(!this.inputs)return null;if(t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,i=this.graph.links[e];if(!i)return null;var s=this.graph.getNodeById(i.origin_id);if(!s)return i.type;var o=s.outputs[i.origin_slot];return o?o.type:null},r.prototype.getInputDataByName=function(t,e){var i=this.findInputSlot(t);return-1==i?null:this.getInputData(i,e)},r.prototype.isInputConnected=function(t){return!!this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link},r.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},r.prototype.getInputLink=function(t){if(!this.inputs)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null},r.prototype.getInputNode=function(t){if(!this.inputs)return null;if(t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var i=this.graph.links[e.link];return i?this.graph.getNodeById(i.origin_id):null},r.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,i=this.inputs.length;e<i;++e){var s=this.inputs[e];if(t==s.name&&null!=s.link){var o=this.graph.links[s.link];if(o)return o.data}}return this.properties[t]},r.prototype.getOutputData=function(t){return this.outputs?t>=this.outputs.length?null:this.outputs[t]._data:null},r.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},r.prototype.isOutputConnected=function(t){return!!this.outputs&&t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length},r.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},r.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var i=[],s=0;s<e.links.length;s++){var o=e.links[s],r=this.graph.links[o];if(r){var n=this.graph.getNodeById(r.target_id);n&&i.push(n)}}return i},r.prototype.trigger=function(t,i){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=e.getTime());for(var s=0;s<this.outputs.length;++s){var o=this.outputs[s];!o||o.type!==e.EVENT||t&&o.name!=t||this.triggerSlot(s,i)}}},r.prototype.triggerSlot=function(t,i,s){if(this.outputs){var o=this.outputs[t];if(o){var r=o.links;if(r&&r.length){this.graph&&(this.graph._last_trigger_time=e.getTime());for(var n=0;n<r.length;++n){var a=r[n];if(null==s||s==a){var u=this.graph.links[r[n]];if(u){u._last_time=e.getTime();var h=this.graph.getNodeById(u.target_id);if(h){var p=h.inputs[u.target_slot];h.mode===e.ON_TRIGGER?h.onExecute&&h.onExecute(i):h.onAction&&h.onAction(p.name,i)}}}}}}}},r.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){var i=this.outputs[t];if(i){var s=i.links;if(s&&s.length)for(var o=0;o<s.length;++o){var r=s[o];if(null==e||e==r){var n=this.graph.links[s[o]];n&&(n._last_time=0)}}}}},r.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},r.prototype.addProperty=function(t,e,i,s){var o={name:t,type:i,default_value:e};if(s)for(var r in s)o[r]=s[r];return this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=e,o},r.prototype.addOutput=function(t,e,i){var s={name:t,type:e,links:null};if(i)for(var o in i)s[o]=i[o];return this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),s},r.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],s={name:i[0],type:i[1],link:null};if(t[2])for(var o in i[2])s[o]=i[2][o];this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},r.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var i=this.outputs[e].links,s=0;s<i.length;++s){var o=this.graph.links[i[s]];o&&(o.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},r.prototype.addInput=function(t,e,i){var s={name:t,type:e=e||0,link:null};if(i)for(var o in i)s[o]=i[o];return this.inputs||(this.inputs=[]),this.inputs.push(s),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(s),this.setDirtyCanvas(!0,!0),s},r.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],s={name:i[0],type:i[1],link:null};if(t[2])for(var o in i[2])s[o]=i[2][o];this.inputs||(this.inputs=[]),this.inputs.push(s),this.onInputAdded&&this.onInputAdded(s)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},r.prototype.removeInput=function(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),i=t;i<this.inputs.length;++i)if(this.inputs[i]){var s=this.graph.links[this.inputs[i].link];s&&(s.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)},r.prototype.addConnection=function(t,e,i,s){var o={name:t,type:e,pos:i,direction:s,links:null};return this.connections.push(o),o},r.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var i=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),s=t||new Float32Array([0,0]);i=Math.max(i,1);var o=o=e.NODE_TEXT_SIZE,r=_(this.title),n=0,a=0;if(this.inputs)for(var u=0,h=this.inputs.length;u<h;++u){var p=this.inputs[u];n<(l=_(p.label||p.name||""))&&(n=l)}if(this.outputs)for(u=0,h=this.outputs.length;u<h;++u){var l,d=this.outputs[u];a<(l=_(d.label||d.name||""))&&(a=l)}s[0]=Math.max(n+a+10,r),s[0]=Math.max(s[0],e.NODE_WIDTH),this.widgets&&this.widgets.length&&(s[0]=Math.max(s[0],1.5*e.NODE_WIDTH)),s[1]=(this.constructor.slot_start_y||0)+i*e.NODE_SLOT_HEIGHT;var c=0;if(this.widgets&&this.widgets.length){for(u=0,h=this.widgets.length;u<h;++u)this.widgets[u].computeSize?c+=this.widgets[u].computeSize(s[0])[1]+4:c+=e.NODE_WIDGET_HEIGHT+4;c+=8}function _(t){return t?o*t.length*.6:0}return this.widgets_up?s[1]=Math.max(s[1],c):null!=this.widgets_start_y?s[1]=Math.max(s[1],c+this.widgets_start_y):s[1]+=c,this.constructor.min_height&&s[1]<this.constructor.min_height&&(s[1]=this.constructor.min_height),s[1]+=6,s},r.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},r.prototype.addWidget=function(t,e,i,s,o){this.widgets||(this.widgets=[]),!o&&s&&s.constructor===Object&&(o=s,s=null),o&&o.constructor===String&&(o={property:o}),s&&s.constructor===String&&(o||(o={}),o.property=s,s=null),s&&s.constructor!==Function&&(console.warn("addWidget: callback must be a function"),s=null);var r={type:t.toLowerCase(),name:e,value:i,callback:s,options:o||{}};if(void 0!==r.options.y&&(r.y=r.options.y),s||r.options.callback||r.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(r),this.setSize(this.computeSize()),r},r.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},r.prototype.getBounding=function(t){return(t=t||new Float32Array(4))[0]=this.pos[0]-4,t[1]=this.pos[1]-e.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.size[1]+e.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t},r.prototype.isPointInside=function(t,i,s,o){s=s||0;var r=this.graph&&this.graph.isLive()?0:e.NODE_TITLE_HEIGHT;if(o&&(r=0),this.flags&&this.flags.collapsed){if(v(t,i,this.pos[0]-s,this.pos[1]-e.NODE_TITLE_HEIGHT-s,(this._collapsed_width||e.NODE_COLLAPSED_WIDTH)+2*s,e.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-r-s<i&&this.pos[1]+this.size[1]+s>i)return!0;return!1},r.prototype.getSlotInPosition=function(t,e){var i=new Float32Array(2);if(this.inputs)for(var s=0,o=this.inputs.length;s<o;++s){var r=this.inputs[s];if(this.getConnectionPos(!0,s,i),v(t,e,i[0]-10,i[1]-5,20,10))return{input:r,slot:s,link_pos:i}}if(this.outputs)for(s=0,o=this.outputs.length;s<o;++s){var n=this.outputs[s];if(this.getConnectionPos(!1,s,i),v(t,e,i[0]-10,i[1]-5,20,10))return{output:n,slot:s,link_pos:i}}return null},r.prototype.findInputSlot=function(t){if(!this.inputs)return-1;for(var e=0,i=this.inputs.length;e<i;++e)if(t==this.inputs[e].name)return e;return-1},r.prototype.findOutputSlot=function(t){if(!this.outputs)return-1;for(var e=0,i=this.outputs.length;e<i;++e)if(t==this.outputs[e].name)return e;return-1},r.prototype.connect=function(t,i,o){if(o=o||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&i.constructor===Number&&(i=this.graph.getNodeById(i)),!i)throw"target node is null";if(i==this)return null;if(o.constructor===String){if(-1==(o=i.findInputSlot(o)))return e.debug&&console.log("Connect: Error, no slot of name "+o),null}else{if(o===e.EVENT)return null;if(!i.inputs||o>=i.inputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),null}var r=i.inputs[o],n=this.outputs[t],a=null;if(e.isValidConnection(n.type,r.type)){if(i.onBeforeConnectInput&&(o=i.onBeforeConnectInput(o)),null!=i.inputs[o].link&&i.disconnectInput(o),i.onConnectInput&&!1===i.onConnectInput(o,n.type,n,this,t))return null;if(this.onConnectOutput&&!1===this.onConnectOutput(t,r.type,r,i,o))return null;a=new s(++this.graph.last_link_id,r.type,this.id,t,i.id,o),this.graph.links[a.id]=a,null==n.links&&(n.links=[]),n.links.push(a.id),i.inputs[o].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!0,a,n),i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,o,!0,a,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.INPUT,i,o,this,t),this.graph.onNodeConnectionChange(e.OUTPUT,this,t,i,o))}return this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a},r.prototype.disconnectOutput=function(t,i){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),!1;var s=this.outputs[t];if(!s||!s.links||0==s.links.length)return!1;if(i){if(i.constructor===Number&&(i=this.graph.getNodeById(i)),!i)throw"Target Node not found";for(var o=0,r=s.links.length;o<r;o++){var n=s.links[o];if((a=this.graph.links[n]).target_id==i.id){s.links.splice(o,1),(u=i.inputs[a.target_slot]).link=null,delete this.graph.links[n],this.graph&&this.graph._version++,i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,a.target_slot,!1,a,u),this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!1,a,s),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot));break}}}else{for(o=0,r=s.links.length;o<r;o++){var a;if(n=s.links[o],a=this.graph.links[n]){i=this.graph.getNodeById(a.target_id);var u=null;this.graph&&this.graph._version++,i&&((u=i.inputs[a.target_slot]).link=null,i.onConnectionsChange&&i.onConnectionsChange(e.INPUT,a.target_slot,!1,a,u),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot)),delete this.graph.links[n],this.onConnectionsChange&&this.onConnectionsChange(e.OUTPUT,t,!1,a,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,this,t),this.graph.onNodeConnectionChange(e.INPUT,i,a.target_slot))}}s.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},r.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return e.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return e.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.inputs[t];if(!i)return!1;var s=this.inputs[t].link;if(null!=s){this.inputs[t].link=null;var o=this.graph.links[s];if(o){var r=this.graph.getNodeById(o.origin_id);if(!r)return!1;var n=r.outputs[o.origin_slot];if(!n||!n.links||0==n.links.length)return!1;for(var a=0,u=n.links.length;a<u;a++)if(n.links[a]==s){n.links.splice(a,1);break}delete this.graph.links[s],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(e.INPUT,t,!1,o,i),r.onConnectionsChange&&r.onConnectionsChange(e.OUTPUT,a,!1,o,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(e.OUTPUT,r,a),this.graph.onNodeConnectionChange(e.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},r.prototype.getConnectionPos=function(t,i,s){s=s||new Float32Array(2);var o=0;t&&this.inputs&&(o=this.inputs.length),!t&&this.outputs&&(o=this.outputs.length);var r=.5*e.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var n=this._collapsed_width||e.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+.5*n,s[1]=t?this.pos[1]-e.NODE_TITLE_HEIGHT:this.pos[1]):(s[0]=t?this.pos[0]:this.pos[0]+n,s[1]=this.pos[1]-.5*e.NODE_TITLE_HEIGHT),s}return t&&-1==i?(s[0]=this.pos[0]+.5*e.NODE_TITLE_HEIGHT,s[1]=this.pos[1]+.5*e.NODE_TITLE_HEIGHT,s):t&&o>i&&this.inputs[i].pos?(s[0]=this.pos[0]+this.inputs[i].pos[0],s[1]=this.pos[1]+this.inputs[i].pos[1],s):!t&&o>i&&this.outputs[i].pos?(s[0]=this.pos[0]+this.outputs[i].pos[0],s[1]=this.pos[1]+this.outputs[i].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(i+.5)*(this.size[0]/o),s[1]=t?this.pos[1]-e.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],s):(s[0]=t?this.pos[0]+r:this.pos[0]+this.size[0]+1-r,s[1]=this.pos[1]+(i+.7)*e.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)},r.prototype.alignToGrid=function(){this.pos[0]=e.CANVAS_GRID_SIZE*Math.round(this.pos[0]/e.CANVAS_GRID_SIZE),this.pos[1]=e.CANVAS_GRID_SIZE*Math.round(this.pos[1]/e.CANVAS_GRID_SIZE)},r.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>r.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},r.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},r.prototype.loadImage=function(t){var i=new Image;i.src=e.node_images_path+t,i.ready=!1;var s=this;return i.onload=function(){this.ready=!0,s.setDirtyCanvas(!0)},i},r.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,i=0;i<e.length;++i){var s=e[i];(t||s.node_capturing_input==this)&&(s.node_capturing_input=t?this:null)}},r.prototype.collapse=function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},r.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},r.prototype.localToScreen=function(t,e,i){return[(t+this.pos[0])*i.scale+i.offset[0],(e+this.pos[1])*i.scale+i.offset[1]]},t.LGraphGroup=e.LGraphGroup=n,n.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=u.node_colors.pale_blue?u.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},n.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font},n.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}},n.prototype.move=function(t,e,i){if(this._pos[0]+=t,this._pos[1]+=e,!i)for(var s=0;s<this._nodes.length;++s){var o=this._nodes[s];o.pos[0]+=t,o.pos[1]+=e}},n.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),i=0;i<t.length;++i){var s=t[i];s.getBounding(e),m(this._bounding,e)&&this._nodes.push(s)}},n.prototype.isPointInside=r.prototype.isPointInside,n.prototype.setDirtyCanvas=r.prototype.setDirtyCanvas,e.DragAndScale=a,a.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),t.addEventListener("mousedown",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},a.prototype.computeVisibleArea=function(){if(this.element){var t=this.element.width,e=this.element.height,i=-this.offset[0],s=-this.offset[1],o=i+t/this.scale,r=s+e/this.scale;this.visible_area[0]=i,this.visible_area[1]=s,this.visible_area[2]=o-i,this.visible_area[3]=r-s}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},a.prototype.onMouse=function(t){if(this.enabled){var e=this.element,i=e.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;t.canvasx=s,t.canvasy=o,t.dragging=this.dragging;var r=!1;if(this.onmouse&&(r=this.onmouse(t)),"mousedown"==t.type)this.dragging=!0,e.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"==t.type){if(!r){var n=s-this.last_mouse[0],a=o-this.last_mouse[1];this.dragging&&this.mouseDrag(n,a)}}else"mouseup"==t.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback)):"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel","wheel"==t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta));return this.last_mouse[0]=s,this.last_mouse[1]=o,t.preventDefault(),t.stopPropagation(),!1}},a.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},a.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},a.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},a.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},a.prototype.changeScale=function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var i=this.element.getBoundingClientRect();if(i){e=e||[.5*i.width,.5*i.height];var s=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var o=this.convertCanvasToOffset(e),r=[o[0]-s[0],o[1]-s[1]];this.offset[0]+=r[0],this.offset[1]+=r[1],this.onredraw&&this.onredraw(this)}}},a.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},a.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},t.LGraphCanvas=e.LGraphCanvas=u,u.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",u.link_type_colors={"-1":e.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},u.gradients={},u.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},u.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),t||!this.graph?(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},u.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},u.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},u.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t]))}},u.prototype.getCurrentGraph=function(){return this.graph},u.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e||this.bindEvents()}},u.prototype._doNothing=function(t){return t.preventDefault(),!1},u.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},u.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),t.addEventListener("mousedown",this._mousedown_callback,!0),t.addEventListener("mousemove",this._mousemove_callback),t.addEventListener("mousewheel",this._mousewheel_callback,!1),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),t.addEventListener("touchstart",this.touchHandler,!0),t.addEventListener("touchmove",this.touchHandler,!0),t.addEventListener("touchend",this.touchHandler,!0),t.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},u.prototype.unbindEvents=function(){if(this._events_binded){var t=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")},u.getFileExtension=function(t){var e=t.indexOf("?");-1!=e&&(t=t.substr(0,e));var i=t.lastIndexOf(".");return-1==i?"":t.substr(i+1).toLowerCase()},u.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},u.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},u.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},u.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}.call(this))},u.prototype.stopRendering=function(){this.is_rendering=!1},u.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},u.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var i=this.getCanvasWindow();i.document,u.active_canvas=this;var s=this;this.canvas.removeEventListener("mousemove",this._mousemove_callback),i.document.addEventListener("mousemove",this._mousemove_callback,!0),i.document.addEventListener("mouseup",this._mouseup_callback,!0);var o=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),r=!1,n=e.getTime()-this.last_mouseclick<300;if(this.mouse[0]=t.localX,this.mouse[1]=t.localY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.canvas.focus(),e.closeAllContextMenus(i),!this.onMouse||1!=this.onMouse(t)){if(1==t.which){t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,r=!0);var a=!1;if(o&&this.allow_interaction&&!r&&!this.read_only){if(this.live_mode||o.flags.pinned||this.bringToFront(o),!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!r&&!1!==o.resizable&&v(t.canvasX,t.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",r=!0;else{if(o.outputs)for(var h=0,p=o.outputs.length;h<p;++h){var l=o.outputs[h],d=o.getConnectionPos(!1,h);if(v(t.canvasX,t.canvasY,d[0]-15,d[1]-10,30,20)){this.connecting_node=o,this.connecting_output=l,this.connecting_pos=o.getConnectionPos(!1,h),this.connecting_slot=h,t.shiftKey&&o.disconnectOutput(h),n?o.onOutputDblClick&&o.onOutputDblClick(h,t):o.onOutputClick&&o.onOutputClick(h,t),r=!0;break}}if(o.inputs)for(h=0,p=o.inputs.length;h<p;++h){var c=o.inputs[h];if(d=o.getConnectionPos(!0,h),v(t.canvasX,t.canvasY,d[0]-15,d[1]-10,30,20)&&(n?o.onInputDblClick&&o.onInputDblClick(h,t):o.onInputClick&&o.onInputClick(h,t),null!==c.link)){var _=this.graph.links[c.link];o.disconnectInput(h),(this.allow_reconnect_links||t.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[_.origin_id],this.connecting_slot=_.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,r=!0}}}if(!r){var g=!1,m=[t.canvasX-o.pos[0],t.canvasY-o.pos[1]],y=this.processNodeWidgets(o,this.graph_mouse,t);y&&(g=!0,this.node_widget=[o,y]),n&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(t,m,this),this.processNodeDblClicked(o),g=!0),o.onMouseDown&&o.onMouseDown(t,m,this)?g=!0:(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&m[0]>o.size[0]-e.NODE_TITLE_HEIGHT&&m[1]<0&&(s=this,setTimeout((function(){s.openSubgraph(o.subgraph)}),10)),this.live_mode&&(a=!0,g=!0)),g||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,t)),this.dirty_canvas=!0}}else{if(!this.read_only)for(h=0;h<this.visible_links.length;++h){var x=this.visible_links[h],b=x._pos;if(!(!b||t.canvasX<b[0]-4||t.canvasX>b[0]+4||t.canvasY<b[1]-4||t.canvasY>b[1]+4)){this.showLinkMenu(x,t),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(t.ctrlKey&&(this.dragging_rectangle=null),f([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),n&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(t),a=!0}!r&&a&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==t.which||3==t.which&&(this.read_only||this.processContextMenu(o,t));return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=e.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!i.document.activeElement||"input"!=i.document.activeElement.nodeName.toLowerCase()&&"textarea"!=i.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}},u.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){u.active_canvas=this,this.adjustMouseEvent(t);var i=[t.localX,t.localY];this.mouse[0]=i[0],this.mouse[1]=i[1];var s=[i[0]-this.last_mouse[0],i[1]-this.last_mouse[1]];if(this.last_mouse=i,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.block_click)return t.preventDefault(),!1;if(t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var o=s[0]/this.ds.scale,r=s[1]/this.ds.scale;this.selected_group.move(o,r,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=s[0]/this.ds.scale,this.ds.offset[1]+=s[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes),a=0,h=this.graph._nodes.length;a<h;++a)this.graph._nodes[a].mouseOver&&n!=this.graph._nodes[a]&&(this.graph._nodes[a].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(n){if(n.redraw_on_mouse&&(this.dirty_canvas=!0),n.mouseOver||(n.mouseOver=!0,this.node_over=n,this.dirty_canvas=!0,n.onMouseEnter&&n.onMouseEnter(t)),n.onMouseMove&&n.onMouseMove(t,[t.canvasX-n.pos[0],t.canvasY-n.pos[1]],this),this.connecting_node){var p=this._highlight_input||[0,0];if(this.isOverNodeBox(n,t.canvasX,t.canvasY));else{var l=this.isOverNodeInput(n,t.canvasX,t.canvasY,p);if(-1!=l&&n.inputs[l]){var d=n.inputs[l].type;e.isValidConnection(this.connecting_output.type,d)&&(this._highlight_input=p)}else this._highlight_input=null}}this.canvas&&(v(t.canvasX,t.canvasY,n.pos[0]+n.size[0]-5,n.pos[1]+n.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var c=null;for(a=0;a<this.visible_links.length;++a){var _=this.visible_links[a],g=_._pos;if(!(!g||t.canvasX<g[0]-4||t.canvasX>g[0]+4||t.canvasY<g[1]-4||t.canvasY>g[1]+4)){c=_;break}}c!=this.over_link_center&&(this.over_link_center=c,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=n&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var a in this.selected_nodes){var f=this.selected_nodes[a];f.pos[0]+=s[0]/this.ds.scale,f.pos[1]+=s[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var m=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],y=this.resizing_node.computeSize();m[0]=Math.max(y[0],m[0]),m[1]=Math.max(y[1],m[1]),this.resizing_node.setSize(m),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},u.prototype.processMouseUp=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var i=this.getCanvasWindow().document;u.active_canvas=this,i.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),i.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(t);var s=e.getTime();if(t.click_time=s-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(console.log("foo"),this.block_click=!1),1==t.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group){var o=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),r=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(o,r,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var n=this.graph._nodes,a=new Float32Array(4);this.deselectAllNodes();var h=Math.abs(this.dragging_rectangle[2]),p=Math.abs(this.dragging_rectangle[3]),l=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-h:this.dragging_rectangle[0],d=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-p:this.dragging_rectangle[1];this.dragging_rectangle[0]=l,this.dragging_rectangle[1]=d,this.dragging_rectangle[2]=h,this.dragging_rectangle[3]=p;for(var c=[],_=0;_<n.length;++_)(y=n[_]).getBounding(a),m(this.dragging_rectangle,a)&&c.push(y);c.length&&this.selectNodes(c)}this.dragging_rectangle=null}else if(this.connecting_node){if(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,y=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))if(this.connecting_output.type==e.EVENT&&this.isOverNodeBox(y,t.canvasX,t.canvasY))this.connecting_node.connect(this.connecting_slot,y,e.EVENT);else{var g=this.isOverNodeInput(y,t.canvasX,t.canvasY);if(-1!=g)this.connecting_node.connect(this.connecting_slot,y,g);else{var f=y.getInputInfo(0);this.connecting_output.type==e.EVENT?this.connecting_node.connect(this.connecting_slot,y,e.EVENT):f&&!f.link&&e.isValidConnection(f.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,y,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged)(y=this.node_dragged)&&t.click_time<300&&v(t.canvasX,t.canvasY,y.pos[0],y.pos[1]-e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT)&&y.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null;else{var y;!(y=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},u.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail;this.adjustMouseEvent(t);var i=this.ds.scale;return e>0?i*=1.1:e<0&&(i*=1/1.1),this.ds.changeScale(i,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}},u.prototype.isOverNodeBox=function(t,i,s){var o=e.NODE_TITLE_HEIGHT;return!!v(i,s,t.pos[0]+2,t.pos[1]+2-o,o-4,o-4)},u.prototype.isOverNodeInput=function(t,e,i,s){if(t.inputs)for(var o=0,r=t.inputs.length;o<r;++o){t.inputs[o];var n=t.getConnectionPos(!0,o);if(t.horizontal?v(e,i,n[0]-5,n[1]-10,10,20):v(e,i,n[0]-10,n[1]-5,40,10))return s&&(s[0]=n[0],s[1]=n[1]),o}return-1},u.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(this.dragging_canvas=!0,e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),"KeyC"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),"KeyV"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.pasteFromClipboard(),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},u.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,i=[];for(var s in this.selected_nodes)(o=this.selected_nodes[s])._relative_id=e,i.push(o),e+=1;for(s=0;s<i.length;++s){var o,r=(o=i[s]).clone();if(r){if(t.nodes.push(r.serialize()),o.inputs&&o.inputs.length)for(var n=0;n<o.inputs.length;++n){var a=o.inputs[n];if(a&&null!=a.link){var u=this.graph.links[a.link];if(u){var h=this.graph.getNodeById(u.origin_id);h&&this.selected_nodes[h.id]&&t.links.push([h._relative_id,u.origin_slot,o._relative_id,u.target_slot])}}}}else console.warn("node type not found: "+o.type)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},u.prototype.pasteFromClipboard=function(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var i=JSON.parse(t),s=[],o=0;o<i.nodes.length;++o){var r=i.nodes[o],n=e.createNode(r.type);n&&(n.configure(r),n.pos[0]+=5,n.pos[1]+=5,this.graph.add(n),s.push(n))}for(o=0;o<i.links.length;++o){var a=i.links[o],u=s[a[0]],h=s[a[2]];u&&h?u.connect(a[1],h,a[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(s),this.graph.afterChange()}},u.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=[t.canvasX,t.canvasY],i=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(!i){var s=null;return this.onDropItem&&(s=this.onDropItem(event)),void(s||this.checkDropItem(t))}if(i.onDropFile||i.onDropData){var o=t.dataTransfer.files;if(o&&o.length)for(var r=0;r<o.length;r++){var n=t.dataTransfer.files[0],a=n.name;if(u.getFileExtension(a),i.onDropFile&&i.onDropFile(n),i.onDropData){var h=new FileReader;h.onload=function(t){var e=t.target.result;i.onDropData(e,a,n)};var p=n.type.split("/")[0];"text"==p||""==p?h.readAsText(n):"image"==p?h.readAsDataURL(n):h.readAsArrayBuffer(n)}}}return!(!i.onDropItem||!i.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)},u.prototype.checkDropItem=function(t){if(t.dataTransfer.files.length){var i=t.dataTransfer.files[0],s=u.getFileExtension(i.name).toLowerCase(),o=e.node_types_by_file_extension[s];if(o){this.graph.beforeChange();var r=e.createNode(o.type);r.pos=[t.canvasX,t.canvasY],this.graph.add(r),r.onDropFile&&r.onDropFile(i),this.graph.afterChange()}}},u.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},u.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(t)},u.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},u.prototype.selectNodes=function(t,e){e||this.deselectAllNodes(),t=t||this.graph._nodes;for(var i=0;i<t.length;++i){var s=t[i];if(!s.is_selected){if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,this.selected_nodes[s.id]=s,s.inputs)for(var o=0;o<s.inputs.length;++o)this.highlighted_links[s.inputs[o].link]=!0;if(s.outputs)for(o=0;o<s.outputs.length;++o){var r=s.outputs[o];if(r.links)for(var n=0;n<r.links.length;++n)this.highlighted_links[r.links[n]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},u.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var i=t.outputs[e];if(i.links)for(var s=0;s<i.links.length;++s)delete this.highlighted_links[i.links[s]]}}},u.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,i=t.length;e<i;++e){var s=t[e];s.is_selected&&(s.onDeselected&&s.onDeselected(),s.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(s))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},u.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var i=this.selected_nodes[t];if(!i.block_delete){if(i.inputs&&i.inputs.length&&i.outputs&&i.outputs.length&&e.isValidConnection(i.inputs[0].type,i.outputs[0].type)&&i.inputs[0].link&&i.outputs[0].links&&i.outputs[0].links.length){var s=i.graph.links[i.inputs[0].link],o=i.graph.links[i.outputs[0].links[0]],r=i.getInputNode(0),n=i.getOutputNodes(0)[0];r&&n&&r.connect(s.origin_slot,n,o.target_slot)}this.graph.remove(i),this.onNodeDeselected&&this.onNodeDeselected(i)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},u.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},u.prototype.adjustMouseEvent=function(t){if(this.canvas){var e=this.canvas.getBoundingClientRect();t.localX=t.clientX-e.left,t.localY=t.clientY-e.top}else t.localX=t.clientX,t.localY=t.clientY;t.deltaX=t.localX-this.last_mouse_position[0],t.deltaY=t.localY-this.last_mouse_position[1],this.last_mouse_position[0]=t.localX,this.last_mouse_position[1]=t.localY,t.canvasX=t.localX/this.ds.scale-this.ds.offset[0],t.canvasY=t.localY/this.ds.scale-this.ds.offset[1]},u.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},u.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},u.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},u.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},u.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},u.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var h=new Float32Array(4);u.prototype.computeVisibleNodes=function(t,e){var i=e||[];i.length=0;for(var s=0,o=(t=t||this.graph._nodes).length;s<o;++s){var r=t[s];(!this.live_mode||r.onDrawBackground||r.onDrawForeground)&&m(this.visible_area,r.getBounding(h))&&i.push(r)}return i},u.prototype.draw=function(t,i){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var s=e.getTime();this.render_time=.001*(s-this.last_draw_time),this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(),(this.dirty_bgcanvas||i||this.always_render_background||this.graph&&this.graph._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},u.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){t.start2D&&t.start2D();var i=this.canvas;if(t.restore(),t.setTransform(1,0,0,1,0,0),this.dirty_area&&(t.save(),t.beginPath(),t.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),t.clip()),this.clear_background&&t.clearRect(0,0,i.width,i.height),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(i,t),this.show_info&&this.renderInfo(t),this.graph){t.save(),this.ds.toCanvasContext(t);for(var s=this.computeVisibleNodes(null,this.visible_nodes),o=0;o<s.length;++o){var r=s[o];t.save(),t.translate(r.pos[0],r.pos[1]),this.drawNode(r,t),t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var n=null;switch(this.connecting_output.type){case e.EVENT:n=e.EVENT_LINK_COLOR;break;default:n=e.CONNECTING_LINK_COLOR}this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,n,this.connecting_output.dir||(this.connecting_node.horizontal?e.DOWN:e.RIGHT),e.CENTER),t.beginPath(),this.connecting_output.type===e.EVENT||this.connecting_output.shape===e.BOX_SHAPE?t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),this.dirty_area&&t.restore(),t.finish2D&&t.finish2D()}},u.prototype.drawSubgraphPanel=function(t){var i=this.graph,s=i._subgraph_node;if(s){var o=s.inputs?s.inputs.length:0,r=Math.floor(1.6*e.NODE_SLOT_HEIGHT);if(t.fillStyle="#111",t.globalAlpha=.8,t.beginPath(),t.roundRect(10,10,300,(o+1)*r+50,8),t.fill(),t.globalAlpha=1,t.fillStyle="#888",t.font="14px Arial",t.textAlign="left",t.fillText("Graph Inputs",20,34),this.mouse,this.drawButton(280,20,20,20,"X","#151515"))this.closeSubgraph();else{var n=50;if(t.font="20px Arial",s.inputs)for(var a=0;a<s.inputs.length;++a){var u=s.inputs[a];if(!u.not_subgraph_input){if(this.drawButton(20,n+2,280,r-2)){var h=s.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=e.createNode(h);p?(i.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",u.name),p.setProperty("type",u.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",h)}t.fillStyle="#9C9",t.beginPath(),t.arc(284,n+.5*r,5,0,2*Math.PI),t.fill(),t.fillStyle="#AAA",t.fillText(u.name,50,n+.75*r);var l=t.measureText(u.name);t.fillStyle="#777",t.fillText(u.type,50+l.width+10,n+.75*r),n+=r}}this.drawButton(20,n+2,280,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(s)}}else console.warn("subgraph without subnode")},u.prototype.drawButton=function(t,i,s,o,r,n,a,u){var h=this.ctx;n=n||e.NODE_DEFAULT_COLOR,a=a||"#555",u=u||e.NODE_TEXT_COLOR;var p=this.mouse,l=e.isInsideRectangle(p[0],p[1],t,i,s,o),d=(p=this.last_click_position)&&e.isInsideRectangle(p[0],p[1],t,i,s,o);h.fillStyle=l?a:n,d&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(t,i,s,o,4),h.fill(),null!=r&&r.constructor==String&&(h.fillStyle=u,h.textAlign="center",h.font=(.65*o|0)+"px Arial",h.fillText(r,t+.5*s,i+.75*o),h.textAlign="left");var c=d&&!this.block_click;return d&&this.blockClick(),c},u.prototype.isAreaClicked=function(t,i,s,o,r){var n=this.mouse,a=(e.isInsideRectangle(n[0],n[1],t,i,s,o),(n=this.last_click_position)&&e.isInsideRectangle(n[0],n[1],t,i,s,o)),u=a&&!this.block_click;return a&&r&&this.blockClick(),u},u.prototype.renderInfo=function(t,e,i){e=e||10,i=i||this.canvas.height-80,t.save(),t.translate(e,i),t.font="10px Arial",t.fillStyle="#888",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},u.prototype.drawBackCanvas=function(){var t=this.bgcanvas;t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;if(e.start&&e.start(),this.clear_background&&e.clearRect(0,0,t.width,t.height),this._graph_stack&&this._graph_stack.length){e.save(),this._graph_stack[this._graph_stack.length-1];var i=this.graph._subgraph_node;e.strokeStyle=i.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=i.bgcolor||"#AAA";for(var s="",o=1;o<this._graph_stack.length;++o)s+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";e.fillText(s+i.getTitle(),.5*t.width,40),e.restore()}var r=!1;if(this.onRenderBackground&&(r=this.onRenderBackground(t,e)),e.restore(),e.setTransform(1,0,0,1,0,0),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.background_image&&this.ds.scale>.5&&!r){if(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var n=this;this._bg_img.onload=function(){n.draw(!0,!0)}}var a=null;null==this._pattern&&this._bg_img.width>0?(a=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=a):a=this._pattern,a&&(e.fillStyle=a,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var p=new Float32Array(2);u.prototype.drawNode=function(t,i){this.current_node=t;var s=t.color||t.constructor.color||e.NODE_DEFAULT_COLOR,o=t.bgcolor||t.constructor.bgcolor||e.NODE_DEFAULT_BGCOLOR;t.mouseOver;var r=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(i.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(i,this,this.canvas));else{var n=this.editor_alpha;if(i.globalAlpha=n,this.render_shadows&&!r?(i.shadowColor=e.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(i,this)){var a=t._shape||e.BOX_SHAPE,u=p;p.set(t.size);var h=t.horizontal;if(t.flags.collapsed){i.font=this.inner_text_font;var l=t.getTitle?t.getTitle():t.title;null!=l&&(t._collapsed_width=Math.min(t.size[0],i.measureText(l).width+2*e.NODE_TITLE_HEIGHT),u[0]=t._collapsed_width,u[1]=0)}t.clip_area&&(i.save(),i.beginPath(),a==e.BOX_SHAPE?i.rect(0,0,u[0],u[1]):a==e.ROUND_SHAPE?i.roundRect(0,0,u[0],u[1],10):a==e.CIRCLE_SHAPE&&i.arc(.5*u[0],.5*u[1],.5*u[0],0,2*Math.PI),i.clip()),t.has_errors&&(o="red"),this.drawNodeShape(t,i,u,s,o,t.is_selected,t.mouseOver),i.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(i,this,this.canvas),i.textAlign=h?"center":"left",i.font=this.inner_text_font;var d=!r,c=this.connecting_output;i.lineWidth=1;var _=0,g=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var f=null,v=null;if(t.inputs)for(x=0;x<t.inputs.length;x++)if(null!=(b=t.inputs[x]).link){f=b;break}if(t.outputs)for(x=0;x<t.outputs.length;x++)(b=t.outputs[x]).links&&b.links.length&&(v=b);if(f){var m=0,y=-.5*e.NODE_TITLE_HEIGHT;h&&(m=.5*t._collapsed_width,y=-e.NODE_TITLE_HEIGHT),i.fillStyle="#686",i.beginPath(),b.type===e.EVENT||b.shape===e.BOX_SHAPE?i.rect(m-7+.5,y-4,14,8):b.shape===e.ARROW_SHAPE?(i.moveTo(m+8,y),i.lineTo(m+-4,y-4),i.lineTo(m+-4,y+4),i.closePath()):i.arc(m,y,4,0,2*Math.PI),i.fill()}v&&(m=t._collapsed_width,y=-.5*e.NODE_TITLE_HEIGHT,h&&(m=.5*t._collapsed_width,y=0),i.fillStyle="#686",i.strokeStyle="black",i.beginPath(),b.type===e.EVENT||b.shape===e.BOX_SHAPE?i.rect(m-7+.5,y-4,14,8):b.shape===e.ARROW_SHAPE?(i.moveTo(m+6,y),i.lineTo(m-6,y-4),i.lineTo(m-6,y+4),i.closePath()):i.arc(m,y,4,0,2*Math.PI),i.fill())}}else{if(t.inputs)for(var x=0;x<t.inputs.length;x++){var b=t.inputs[x];i.globalAlpha=n,this.connecting_node&&!e.isValidConnection(b.type,c.type)&&(i.globalAlpha=.4*n),i.fillStyle=null!=b.link?b.color_on||this.default_connection_color.input_on:b.color_off||this.default_connection_color.input_off,(T=t.getConnectionPos(!0,x,g))[0]-=t.pos[0],T[1]-=t.pos[1],_<T[1]+.5*e.NODE_SLOT_HEIGHT&&(_=T[1]+.5*e.NODE_SLOT_HEIGHT),i.beginPath(),b.type===e.EVENT||b.shape===e.BOX_SHAPE?h?i.rect(T[0]-5+.5,T[1]-8+.5,10,14):i.rect(T[0]-6+.5,T[1]-5+.5,14,10):b.shape===e.ARROW_SHAPE?(i.moveTo(T[0]+8,T[1]+.5),i.lineTo(T[0]-4,T[1]+6+.5),i.lineTo(T[0]-4,T[1]-6+.5),i.closePath()):r?i.rect(T[0]-4,T[1]-4,8,8):i.arc(T[0],T[1],4,0,2*Math.PI),i.fill(),d&&(E=null!=b.label?b.label:b.name)&&(i.fillStyle=e.NODE_TEXT_COLOR,h||b.dir==e.UP?i.fillText(E,T[0],T[1]-10):i.fillText(E,T[0]+10,T[1]+5))}if(this.connecting_node&&(i.globalAlpha=.4*n),i.textAlign=h?"center":"right",i.strokeStyle="black",t.outputs)for(x=0;x<t.outputs.length;x++){var T,E;b=t.outputs[x];(T=t.getConnectionPos(!1,x,g))[0]-=t.pos[0],T[1]-=t.pos[1],_<T[1]+.5*e.NODE_SLOT_HEIGHT&&(_=T[1]+.5*e.NODE_SLOT_HEIGHT),i.fillStyle=b.links&&b.links.length?b.color_on||this.default_connection_color.output_on:b.color_off||this.default_connection_color.output_off,i.beginPath(),b.type===e.EVENT||b.shape===e.BOX_SHAPE?h?i.rect(T[0]-5+.5,T[1]-8+.5,10,14):i.rect(T[0]-6+.5,T[1]-5+.5,14,10):b.shape===e.ARROW_SHAPE?(i.moveTo(T[0]+8,T[1]+.5),i.lineTo(T[0]-4,T[1]+6+.5),i.lineTo(T[0]-4,T[1]-6+.5),i.closePath()):r?i.rect(T[0]-4,T[1]-4,8,8):i.arc(T[0],T[1],4,0,2*Math.PI),i.fill(),r||i.stroke(),d&&(E=null!=b.label?b.label:b.name)&&(i.fillStyle=e.NODE_TEXT_COLOR,h||b.dir==e.DOWN?i.fillText(E,T[0],T[1]-8):i.fillText(E,T[0]-10,T[1]+5))}if(i.textAlign="left",i.globalAlpha=1,t.widgets){var w=_;(h||t.widgets_up)&&(w=2),null!=t.widgets_start_y&&(w=t.widgets_start_y),this.drawNodeWidgets(t,w,i,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&i.restore(),i.globalAlpha=1}}},u.prototype.drawLinkTooltip=function(t,e){var i=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(i[0],i[1],3,0,2*Math.PI),t.fill(),null!=e.data&&(!this.onDrawLinkTooltip||1!=this.onDrawLinkTooltip(t,e,this))){var s=e.data,o=null;if(null!=(o=s.constructor===Number?s.toFixed(2):s.constructor===String?'"'+s+'"':s.constructor===Boolean?String(s):s.toToolTip?s.toToolTip():"["+s.constructor.name+"]")){o=o.substr(0,30),t.font="14px Courier New";var r=t.measureText(o).width+20;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(i[0]-.5*r,i[1]-15-24,r,24,3,3),t.moveTo(i[0]-10,i[1]-15),t.lineTo(i[0]+10,i[1]-15),t.lineTo(i[0],i[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(o,i[0],i[1]-15-24*.3)}}};var l=new Float32Array(4);u.prototype.drawNodeShape=function(t,i,s,o,r,n,a){i.strokeStyle=o,i.fillStyle=r;var h=e.NODE_TITLE_HEIGHT,p=this.ds.scale<.5,d=t._shape||t.constructor.shape||e.ROUND_SHAPE,c=t.constructor.title_mode,_=!0;c==e.TRANSPARENT_TITLE?_=!1:c==e.AUTOHIDE_TITLE&&a&&(_=!0);var g=l;g[0]=0,g[1]=_?-h:0,g[2]=s[0]+1,g[3]=_?s[1]+h:s[1];var f=i.globalAlpha;if(i.beginPath(),d==e.BOX_SHAPE||p?i.fillRect(g[0],g[1],g[2],g[3]):d==e.ROUND_SHAPE||d==e.CARD_SHAPE?i.roundRect(g[0],g[1],g[2],g[3],this.round_radius,d==e.CARD_SHAPE?0:this.round_radius):d==e.CIRCLE_SHAPE&&i.arc(.5*s[0],.5*s[1],.5*s[0],0,2*Math.PI),i.fill(),t.flags.collapsed||(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,g[2],2)),i.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(i,this,this.canvas,this.graph_mouse),_||c==e.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(i,h,s,this.ds.scale,o);else if(c!=e.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var v=t.constructor.title_color||o;if(t.flags.collapsed&&(i.shadowColor=e.DEFAULT_SHADOW_COLOR),this.use_gradients){var m=u.gradients[v];m||((m=u.gradients[v]=i.createLinearGradient(0,0,400,0)).addColorStop(0,v),m.addColorStop(1,"#000")),i.fillStyle=m}else i.fillStyle=v;i.beginPath(),d==e.BOX_SHAPE||p?i.rect(0,-h,s[0]+1,h):d!=e.ROUND_SHAPE&&d!=e.CARD_SHAPE||i.roundRect(0,-h,s[0]+1,h,this.round_radius,t.flags.collapsed?this.round_radius:0),i.fill(),i.shadowColor="transparent"}var y=10;if(t.onDrawTitleBox?t.onDrawTitleBox(i,h,s,this.ds.scale):d==e.ROUND_SHAPE||d==e.CIRCLE_SHAPE||d==e.CARD_SHAPE?(p&&(i.fillStyle="black",i.beginPath(),i.arc(.5*h,-.5*h,6,0,2*Math.PI),i.fill()),i.fillStyle=t.boxcolor||e.NODE_DEFAULT_BOXCOLOR,p?i.fillRect(.5*h-5,-.5*h-5,y,y):(i.beginPath(),i.arc(.5*h,-.5*h,5,0,2*Math.PI),i.fill())):(p&&(i.fillStyle="black",i.fillRect(.5*(h-y)-1,-.5*(h+y)-1,12,12)),i.fillStyle=t.boxcolor||e.NODE_DEFAULT_BOXCOLOR,i.fillRect(.5*(h-y),-.5*(h+y),y,y)),i.globalAlpha=f,t.onDrawTitleText&&t.onDrawTitleText(i,h,s,this.ds.scale,this.title_text_font,n),!p){i.font=this.title_text_font;var x=String(t.getTitle());x&&(i.fillStyle=n?e.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(i.textAlign="left",i.measureText(x),i.fillText(x.substr(0,20),h,e.NODE_TITLE_TEXT_Y-h),i.textAlign="left"):(i.textAlign="left",i.fillText(x,h,e.NODE_TITLE_TEXT_Y-h)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var b=e.NODE_TITLE_HEIGHT,T=t.size[0]-b,E=e.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],T+2,2-b,b-4,b-4);i.fillStyle=E?"#888":"#555",d==e.BOX_SHAPE||p?i.fillRect(T+2,2-b,b-4,b-4):(i.beginPath(),i.roundRect(T+2,2-b,b-4,b-4,4),i.fill()),i.fillStyle="#333",i.beginPath(),i.moveTo(T+.2*b,.6*-b),i.lineTo(T+.8*b,.6*-b),i.lineTo(T+.5*b,.3*-b),i.fill()}t.onDrawTitle&&t.onDrawTitle(i)}n&&(t.onBounding&&t.onBounding(g),c==e.TRANSPARENT_TITLE&&(g[1]-=h,g[3]+=h),i.lineWidth=1,i.globalAlpha=.8,i.beginPath(),d==e.BOX_SHAPE?i.rect(-6+g[0],-6+g[1],12+g[2],12+g[3]):d==e.ROUND_SHAPE||d==e.CARD_SHAPE&&t.flags.collapsed?i.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius):d==e.CARD_SHAPE?i.roundRect(-6+g[0],-6+g[1],12+g[2],12+g[3],2*this.round_radius,2):d==e.CIRCLE_SHAPE&&i.arc(.5*s[0],.5*s[1],.5*s[0]+6,0,2*Math.PI),i.strokeStyle=e.NODE_BOX_OUTLINE_COLOR,i.stroke(),i.strokeStyle=o,i.globalAlpha=1)};var d=new Float32Array(4),c=new Float32Array(4),_=new Float32Array(2),g=new Float32Array(2);function f(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function v(t,e,i,s,o,r){return i<t&&i+o>t&&s<e&&s+r>e}function m(t,e){var i=t[0]+t[2],s=t[1]+t[3],o=e[0]+e[2],r=e[1]+e[3];return!(t[0]>o||t[1]>r||i<e[0]||s<e[1])}function y(t,e){e=e||{},this.options=e;var i=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var s=null;e.event&&(s=e.event.constructor.name),"MouseEvent"!==s&&"CustomEvent"!==s&&"PointerEvent"!==s&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),e.event=null);var o=document.createElement("div");function r(t){var i=parseInt(o.style.top);return o.style.top=(i+t.deltaY*e.scroll_speed).toFixed()+"px",t.preventDefault(),!0}if(o.className="litegraph litecontextmenu litemenubar-panel",e.className&&(o.className+=" "+e.className),o.style.minWidth=100,o.style.minHeight=100,o.style.pointerEvents="none",setTimeout((function(){o.style.pointerEvents="auto"}),100),o.addEventListener("mouseup",(function(t){return t.preventDefault(),!0}),!0),o.addEventListener("contextmenu",(function(t){return 2!=t.button||t.preventDefault(),!1}),!0),o.addEventListener("mousedown",(function(t){if(2==t.button)return i.close(),t.preventDefault(),!0}),!0),e.scroll_speed||(e.scroll_speed=.1),o.addEventListener("wheel",r,!0),o.addEventListener("mousewheel",r,!0),this.root=o,e.title){var n=document.createElement("div");n.className="litemenu-title",n.innerHTML=e.title,o.appendChild(n)}for(var a=0;a<t.length;a++){var u=t.constructor==Array?t[a]:a;null!=u&&u.constructor!==String&&(u=void 0===u.content?String(u):u.content);var h=t[a];this.addItem(u,h,e)}o.addEventListener("mouseleave",(function(t){i.lock||(o.closing_timer&&clearTimeout(o.closing_timer),o.closing_timer=setTimeout(i.close.bind(i,t),500))})),o.addEventListener("mouseenter",(function(t){o.closing_timer&&clearTimeout(o.closing_timer)}));var p=document;e.event&&(p=e.event.target.ownerDocument),p||(p=document),p.fullscreenElement?p.fullscreenElement.appendChild(o):p.body.appendChild(o);var l=e.left||0,d=e.top||0;if(e.event){if(l=e.event.clientX-10,d=e.event.clientY-10,e.title&&(d-=20),e.parentMenu){var c=e.parentMenu.root.getBoundingClientRect();l=c.left+c.width}var _=document.body.getBoundingClientRect(),g=o.getBoundingClientRect();0==_.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),_.width&&l>_.width-g.width-10&&(l=_.width-g.width-10),_.height&&d>_.height-g.height-10&&(d=_.height-g.height-10)}o.style.left=l+"px",o.style.top=d+"px",e.scale&&(o.style.transform="scale("+e.scale+")")}function x(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}u.prototype.drawConnections=function(t){var i=e.getTime(),s=this.visible_area;d[0]=s[0]-20,d[1]=s[1]-20,d[2]=s[2]+40,d[3]=s[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var o=this.graph._nodes,r=0,n=o.length;r<n;++r){var a=o[r];if(a.inputs&&a.inputs.length)for(var u=0;u<a.inputs.length;++u){var h=a.inputs[u];if(h&&null!=h.link){var p=h.link,l=this.graph.links[p];if(l){var f=this.graph.getNodeById(l.origin_id);if(null!=f){var v,y=l.origin_slot;v=-1==y?[f.pos[0]+10,f.pos[1]+10]:f.getConnectionPos(!1,y,_);var x=a.getConnectionPos(!0,u,g);if(c[0]=v[0],c[1]=v[1],c[2]=x[0]-v[0],c[3]=x[1]-v[1],c[2]<0&&(c[0]+=c[2],c[2]=Math.abs(c[2])),c[3]<0&&(c[1]+=c[3],c[3]=Math.abs(c[3])),m(c,d)){var b=f.outputs[y],T=a.inputs[u];if(b&&T){var E=b.dir||(f.horizontal?e.DOWN:e.RIGHT),w=T.dir||(a.horizontal?e.UP:e.LEFT);if(this.renderLink(t,v,x,l,!1,0,null,E,w),l&&l._last_time&&i-l._last_time<1e3){var I=2-.002*(i-l._last_time),O=t.globalAlpha;t.globalAlpha=O*I,this.renderLink(t,v,x,l,!0,I,"white",E,w),t.globalAlpha=O}}}}}}}}t.globalAlpha=1},u.prototype.renderLink=function(t,i,s,o,r,n,a,h,p,l){o&&this.visible_links.push(o),!a&&o&&(a=o.color||u.link_type_colors[o.type]),a||(a=this.default_link_color),null!=o&&this.highlighted_links[o.id]&&(a="#FFF"),h=h||e.RIGHT,p=p||e.LEFT;var d=f(i,s);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(l=l||1)>1&&(t.lineWidth=.5),t.beginPath();for(var c=0;c<l;c+=1){var _=5*(c-.5*(l-1));if(this.links_render_mode==e.SPLINE_LINK){t.moveTo(i[0],i[1]+_);var g=0,v=0,m=0,y=0;switch(h){case e.LEFT:g=-.25*d;break;case e.RIGHT:g=.25*d;break;case e.UP:v=-.25*d;break;case e.DOWN:v=.25*d}switch(p){case e.LEFT:m=-.25*d;break;case e.RIGHT:m=.25*d;break;case e.UP:y=-.25*d;break;case e.DOWN:y=.25*d}t.bezierCurveTo(i[0]+g,i[1]+v+_,s[0]+m,s[1]+y+_,s[0],s[1]+_)}else if(this.links_render_mode==e.LINEAR_LINK){switch(t.moveTo(i[0],i[1]+_),g=0,v=0,m=0,y=0,h){case e.LEFT:g=-1;break;case e.RIGHT:g=1;break;case e.UP:v=-1;break;case e.DOWN:v=1}switch(p){case e.LEFT:m=-1;break;case e.RIGHT:m=1;break;case e.UP:y=-1;break;case e.DOWN:y=1}t.lineTo(i[0]+15*g,i[1]+15*v+_),t.lineTo(s[0]+15*m,s[1]+15*y+_),t.lineTo(s[0],s[1]+_)}else{if(this.links_render_mode!=e.STRAIGHT_LINK)return;t.moveTo(i[0],i[1]);var x=i[0],b=i[1],T=s[0],E=s[1];h==e.RIGHT?x+=10:b+=10,p==e.LEFT?T-=10:E-=10,t.lineTo(x,b),t.lineTo(.5*(x+T),b),t.lineTo(.5*(x+T),E),t.lineTo(T,E),t.lineTo(s[0],s[1])}}this.render_connections_border&&this.ds.scale>.6&&!r&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var w=this.computeConnectionPoint(i,s,.5,h,p);if(o&&o._pos&&(o._pos[0]=w[0],o._pos[1]=w[1]),this.ds.scale>=.6&&this.highquality_render&&p!=e.CENTER){if(this.render_connection_arrows){var I=this.computeConnectionPoint(i,s,.25,h,p),O=this.computeConnectionPoint(i,s,.26,h,p),D=this.computeConnectionPoint(i,s,.75,h,p),N=this.computeConnectionPoint(i,s,.76,h,p),S=0,C=0;this.render_curved_connections?(S=-Math.atan2(O[0]-I[0],O[1]-I[1]),C=-Math.atan2(N[0]-D[0],N[1]-D[1])):C=S=s[1]>i[1]?0:Math.PI,t.save(),t.translate(I[0],I[1]),t.rotate(S),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(D[0],D[1]),t.rotate(C),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(w[0],w[1],5,0,2*Math.PI),t.fill()}if(n)for(t.fillStyle=a,c=0;c<5;++c){var A=(.001*e.getTime()+.2*c)%1;w=this.computeConnectionPoint(i,s,A,h,p),t.beginPath(),t.arc(w[0],w[1],5,0,2*Math.PI),t.fill()}},u.prototype.computeConnectionPoint=function(t,i,s,o,r){o=o||e.RIGHT,r=r||e.LEFT;var n=f(t,i),a=t,u=[t[0],t[1]],h=[i[0],i[1]],p=i;switch(o){case e.LEFT:u[0]+=-.25*n;break;case e.RIGHT:u[0]+=.25*n;break;case e.UP:u[1]+=-.25*n;break;case e.DOWN:u[1]+=.25*n}switch(r){case e.LEFT:h[0]+=-.25*n;break;case e.RIGHT:h[0]+=.25*n;break;case e.UP:h[1]+=-.25*n;break;case e.DOWN:h[1]+=.25*n}var l=(1-s)*(1-s)*(1-s),d=(1-s)*(1-s)*3*s,c=3*(1-s)*(s*s),_=s*s*s;return[l*a[0]+d*u[0]+c*h[0]+_*p[0],l*a[1]+d*u[1]+c*h[1]+_*p[1]]},u.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var i=this.visible_nodes,s=0;s<i.length;++s){var o=i[s];t.fillStyle="black",t.fillRect(o.pos[0]-e.NODE_TITLE_HEIGHT,o.pos[1]-e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT),0==o.order&&t.strokeRect(o.pos[0]-e.NODE_TITLE_HEIGHT+.5,o.pos[1]-e.NODE_TITLE_HEIGHT+.5,e.NODE_TITLE_HEIGHT,e.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(o.order,o.pos[0]+-.5*e.NODE_TITLE_HEIGHT,o.pos[1]-6)}t.globalAlpha=1},u.prototype.drawNodeWidgets=function(t,i,s,o){if(!t.widgets||!t.widgets.length)return 0;var r=t.size[0],n=t.widgets;i+=2;var a=e.NODE_WIDGET_HEIGHT,u=this.ds.scale>.5;s.save(),s.globalAlpha=this.editor_alpha;for(var h=e.WIDGET_OUTLINE_COLOR,p=e.WIDGET_BGCOLOR,l=e.WIDGET_TEXT_COLOR,d=e.WIDGET_SECONDARY_TEXT_COLOR,c=15,_=0;_<n.length;++_){var g=n[_],f=i;g.y&&(f=g.y),g.last_y=f,s.strokeStyle=h,s.fillStyle="#222",s.textAlign="left",g.disabled&&(s.globalAlpha*=.5);var v=g.width||r;switch(g.type){case"button":g.clicked&&(s.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),s.fillRect(c,f,v-30,a),u&&!g.disabled&&s.strokeRect(c,f,v-30,a),u&&(s.textAlign="center",s.fillStyle=l,s.fillText(g.name,.5*v,f+.7*a));break;case"toggle":s.textAlign="left",s.strokeStyle=h,s.fillStyle=p,s.beginPath(),u?s.roundRect(c,i,v-30,a,.5*a):s.rect(c,i,v-30,a),s.fill(),u&&!g.disabled&&s.stroke(),s.fillStyle=g.value?"#89A":"#333",s.beginPath(),s.arc(v-30,f+.5*a,.36*a,0,2*Math.PI),s.fill(),u&&(s.fillStyle=d,null!=g.name&&s.fillText(g.name,30,f+.7*a),s.fillStyle=g.value?l:d,s.textAlign="right",s.fillText(g.value?g.options.on||"true":g.options.off||"false",v-40,f+.7*a));break;case"slider":s.fillStyle=p,s.fillRect(c,f,v-30,a);var m=g.options.max-g.options.min,y=(g.value-g.options.min)/m;if(s.fillStyle=o==g?"#89A":"#678",s.fillRect(c,f,y*(v-30),a),u&&!g.disabled&&s.strokeRect(c,f,v-30,a),g.marker){var x=(g.marker-g.options.min)/m;s.fillStyle="#AA9",s.fillRect(c+x*(v-30),f,2,a)}u&&(s.textAlign="center",s.fillStyle=l,s.fillText(g.name+"  "+Number(g.value).toFixed(3),.5*v,f+.7*a));break;case"number":case"combo":if(s.textAlign="left",s.strokeStyle=h,s.fillStyle=p,s.beginPath(),u?s.roundRect(c,i,v-30,a,.5*a):s.rect(c,i,v-30,a),s.fill(),u)if(g.disabled||s.stroke(),s.fillStyle=l,g.disabled||(s.beginPath(),s.moveTo(31,i+5),s.lineTo(21,i+.5*a),s.lineTo(31,i+a-5),s.fill(),s.beginPath(),s.moveTo(v-c-16,i+5),s.lineTo(v-c-6,i+.5*a),s.lineTo(v-c-16,i+a-5),s.fill()),s.fillStyle=d,s.fillText(g.name,35,f+.7*a),s.fillStyle=l,s.textAlign="right","number"==g.type)s.fillText(Number(g.value).toFixed(void 0!==g.options.precision?g.options.precision:3),v-30-20,f+.7*a);else{var b=g.value;if(g.options.values){var T=g.options.values;T.constructor===Function&&(T=T()),T&&T.constructor!==Array&&(b=T[g.value])}s.fillText(b,v-30-20,f+.7*a)}break;case"string":case"text":s.textAlign="left",s.strokeStyle=h,s.fillStyle=p,s.beginPath(),u?s.roundRect(c,i,v-30,a,.5*a):s.rect(c,i,v-30,a),s.fill(),u&&(g.disabled||s.stroke(),s.save(),s.beginPath(),s.rect(c,i,v-30,a),s.clip(),s.fillStyle=d,null!=g.name&&s.fillText(g.name,30,f+.7*a),s.fillStyle=l,s.textAlign="right",s.fillText(String(g.value).substr(0,30),v-30,f+.7*a),s.restore());break;default:g.draw&&g.draw(s,t,v,f,a)}i+=(g.computeSize?g.computeSize(v)[1]:a)+4,s.globalAlpha=this.editor_alpha}s.restore(),s.textAlign="left"},u.prototype.processNodeWidgets=function(t,i,s,o){if(!t.widgets||!t.widgets.length)return null;for(var r=i[0]-t.pos[0],n=i[1]-t.pos[1],a=t.size[0],u=this,h=this.getCanvasWindow(),p=0;p<t.widgets.length;++p){var l=t.widgets[p];if(l&&!l.disabled){var d=l.computeSize?l.computeSize(a)[1]:e.NODE_WIDGET_HEIGHT,c=l.width||a;if(l==o||!(r<6||r>c-12||n<l.last_y||n>l.last_y+d)){var _=l.value;switch(l.type){case"button":if("mousemove"===s.type)break;l.callback&&setTimeout((function(){l.callback(l,u,t,i,s)}),20),l.clicked=!0,this.dirty_canvas=!0;break;case"slider":l.options.max,l.options.min;var g=Math.clamp((r-15)/(c-30),0,1);l.value=l.options.min+(l.options.max-l.options.min)*g,l.callback&&setTimeout((function(){T(l,l.value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":if(_=l.value,"mousemove"==s.type&&"number"==l.type)l.value+=.1*s.deltaX*(l.options.step||1),null!=l.options.min&&l.value<l.options.min&&(l.value=l.options.min),null!=l.options.max&&l.value>l.options.max&&(l.value=l.options.max);else if("mousedown"==s.type){var f=l.options.values;f&&f.constructor===Function&&(f=l.options.values(l,t));var v=null;"number"!=l.type&&(v=f.constructor===Array?f:Object.keys(f));var m=r<40?-1:r>c-40?1:0;if("number"==l.type)l.value+=.1*m*(l.options.step||1),null!=l.options.min&&l.value<l.options.min&&(l.value=l.options.min),null!=l.options.max&&l.value>l.options.max&&(l.value=l.options.max);else if(m){var y=-1;this.last_mouseclick=0,(y=f.constructor===Object?v.indexOf(String(l.value))+m:v.indexOf(l.value)+m)>=v.length&&(y=v.length-1),y<0&&(y=0),f.constructor===Array?l.value=f[y]:l.value=y}else{var x=f!=v?Object.values(f):f;function b(t,e,i){return f!=v&&(t=x.indexOf(t)),this.value=t,T(this,t),u.dirty_canvas=!0,!1}new e.ContextMenu(x,{scale:Math.max(1,this.ds.scale),event:s,className:"dark",callback:b.bind(l)},h)}}else"mouseup"==s.type&&"number"==l.type&&(m=r<40?-1:r>c-40?1:0,s.click_time<200&&0==m&&this.prompt("Value",l.value,function(t){this.value=Number(t),T(this,this.value)}.bind(l),s));_!=l.value&&setTimeout(function(){T(this,this.value)}.bind(l),20),this.dirty_canvas=!0;break;case"toggle":"mousedown"==s.type&&(l.value=!l.value,setTimeout((function(){T(l,l.value)}),20));break;case"string":case"text":"mousedown"==s.type&&this.prompt("Value",l.value,function(t){this.value=t,T(this,t)}.bind(l),s,!!l.options&&l.options.multiline);break;default:l.mouse&&(this.dirty_canvas=l.mouse(s,[r,n],t))}return _!=l.value&&(t.onWidgetChanged&&t.onWidgetChanged(l.name,l.value,_,l),t.graph._version++),l}}}function T(e,o){e.value=o,e.options&&e.options.property&&void 0!==t.properties[e.options.property]&&t.setProperty(e.options.property,o),e.callback&&e.callback(e.value,u,t,i,s)}return null},u.prototype.drawGroups=function(t,i){if(this.graph){var s=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;for(var o=0;o<s.length;++o){var r=s[o];if(m(this.visible_area,r._bounding)){i.fillStyle=r.color||"#335",i.strokeStyle=r.color||"#335";var n=r._pos,a=r._size;i.globalAlpha=.25*this.editor_alpha,i.beginPath(),i.rect(n[0]+.5,n[1]+.5,a[0],a[1]),i.fill(),i.globalAlpha=this.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(n[0]+a[0],n[1]+a[1]),i.lineTo(n[0]+a[0]-10,n[1]+a[1]),i.lineTo(n[0]+a[0],n[1]+a[1]-10),i.fill();var u=r.font_size||e.DEFAULT_GROUP_FONT_SIZE;i.font=u+"px Arial",i.fillText(r.title,n[0]+4,n[1]+u)}}i.restore()}},u.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},u.prototype.resize=function(t,e){if(!t&&!e){var i=this.canvas.parentNode;t=i.offsetWidth,e=i.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},u.prototype.switchLiveMode=function(t){if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var e=this,i=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var s=setInterval((function(){e.editor_alpha*=i,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,i<1&&e.editor_alpha<.01&&(clearInterval(s),i<1&&(e.live_mode=!0)),i>1&&e.editor_alpha>.99&&(clearInterval(s),e.editor_alpha=1)}),1)},u.prototype.onNodeSelectionChange=function(t){},u.prototype.touchHandler=function(t){var e=t.changedTouches[0],i="";switch(t.type){case"touchstart":i="mousedown";break;case"touchmove":i="mousemove";break;case"touchend":i="mouseup";break;default:return}var s=this.getCanvasWindow(),o=s.document.createEvent("MouseEvent");o.initMouseEvent(i,!0,!0,s,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(o),t.preventDefault()},u.onGroupAdd=function(t,i,s){var o=u.active_canvas,r=(o.getCanvasWindow(),new e.LGraphGroup);r.pos=o.convertEventToCanvasOffset(s),o.graph.add(r)},u.onMenuAdd=function(t,i,s,o,r){var n=u.active_canvas,a=n.getCanvasWindow(),h=n.graph;if(h){for(var p=e.getNodeTypesCategories(n.filter||h.filter),l=[],d=0;d<p.length;d++)if(p[d]){var c=p[d];-1!=c.indexOf("::")&&(c=c.split("::")[1]),l.push({value:p[d],content:c,has_submenu:!0})}var _=new e.ContextMenu(l,{event:s,callback:function(t,i,s){for(var o=t.value,r=e.getNodeTypesInCategory(o,n.filter||h.filter),u=[],p=0;p<r.length;p++)r[p].skip_list||u.push({content:r[p].title,value:r[p].type});return new e.ContextMenu(u,{event:s,callback:g,parentMenu:_},a),!1},parentMenu:o},a);return!1}function g(t,i){var s=o.getFirstEvent();n.graph.beforeChange();var a=e.createNode(t.value);a&&(a.pos=n.convertEventToCanvasOffset(s),n.graph.add(a)),r&&r(a),n.graph.afterChange()}},u.onMenuCollapseAll=function(){},u.onMenuNodeEdit=function(){},u.showMenuNodeOptionalInputs=function(t,i,s,o,r){if(r){var n=this,a=u.active_canvas.getCanvasWindow();i=r.optional_inputs,r.onGetInputs&&(i=r.onGetInputs());var h=[];if(i)for(var p=0;p<i.length;p++){var l=i[p];if(l){var d=l[0];l[2]&&l[2].label&&(d=l[2].label);var c={content:d,value:l};l[1]==e.ACTION&&(c.className="event"),h.push(c)}else h.push(null)}if(this.onMenuNodeInputs&&(h=this.onMenuNodeInputs(h)),h.length)return new e.ContextMenu(h,{event:s,callback:function(t,e,i){r&&(t.callback&&t.callback.call(n,r,t,e,i),t.value&&(r.graph.beforeChange(),r.addInput(t.value[0],t.value[1],t.value[2]),r.setDirtyCanvas(!0,!0),r.graph.afterChange()))},parentMenu:o,node:r},a),!1;console.log("no input entries")}},u.showMenuNodeOptionalOutputs=function(t,i,s,o,r){if(r){var n=this,a=u.active_canvas.getCanvasWindow();i=r.optional_outputs,r.onGetOutputs&&(i=r.onGetOutputs());var h=[];if(i)for(var p=0;p<i.length;p++){var l=i[p];if(l){if(!r.flags||!r.flags.skip_repeated_outputs||-1==r.findOutputSlot(l[0])){var d=l[0];l[2]&&l[2].label&&(d=l[2].label);var c={content:d,value:l};l[1]==e.EVENT&&(c.className="event"),h.push(c)}}else h.push(null)}if(this.onMenuNodeOutputs&&(h=this.onMenuNodeOutputs(h)),h.length)return new e.ContextMenu(h,{event:s,callback:function t(i,s,a){if(r&&(i.callback&&i.callback.call(n,r,i,s,a),i.value)){var u=i.value[1];if(u&&(u.constructor===Object||u.constructor===Array)){var h=[];for(var p in u)h.push({content:p,value:u[p]});return new e.ContextMenu(h,{event:s,callback:t,parentMenu:o,node:r}),!1}r.graph.beforeChange(),r.addOutput(i.value[0],i.value[1],i.value[2]),r.setDirtyCanvas(!0,!0),r.graph.afterChange()}},parentMenu:o,node:r},a),!1}},u.onShowMenuNodeProperties=function(t,i,s,o,r){if(r&&r.properties){var n=u.active_canvas,a=n.getCanvasWindow(),h=[];for(var p in r.properties){"object"==typeof(t=void 0!==r.properties[p]?r.properties[p]:" ")&&(t=JSON.stringify(t));var l=r.getPropertyInfo(p);"enum"!=l.type&&"combo"!=l.type||(t=u.getPropertyPrintableValue(t,l.values)),t=u.decodeHTML(t),h.push({content:"<span class='property_name'>"+(l.label?l.label:p)+"</span><span class='property_value'>"+t+"</span>",value:p})}if(h.length)return new e.ContextMenu(h,{event:s,callback:function(t,e,i,s){if(r){var o=this.getBoundingClientRect();n.showEditPropertyValue(r,t.value,{position:[o.left,o.top]})}},parentMenu:o,allow_html:!0,node:r},a),!1}},u.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},u.onResizeNode=function(t,e,i,s,o){o&&(o.size=o.computeSize(),o.onResize&&o.onResize(o.size),o.setDirtyCanvas(!0,!0))},u.prototype.showLinkMenu=function(t,i){var s=this;console.log(t);var o=new e.ContextMenu(["Add Node",null,"Delete"],{event:i,title:null!=t.data?t.data.constructor.name:null,callback:function(e,i,r){switch(e){case"Add Node":u.onMenuAdd(null,null,r,o,(function(e){console.log("node autoconnect");var i=s.graph.getNodeById(t.origin_id),o=s.graph.getNodeById(t.target_id);e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&i.outputs[t.origin_slot].type==e.inputs[0].type&&e.outputs[0].type==o.inputs[0].type&&(i.connect(t.origin_slot,e,0),e.connect(0,o,t.target_slot),e.pos[0]-=.5*e.size[0])}));break;case"Delete":s.graph.removeLink(t.id)}}});return!1},u.onShowPropertyEditor=function(t,e,i,s,o){var r=t.property||"title",n=o[r],a=document.createElement("div");a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.querySelector(".name").innerText=r;var h=a.querySelector(".value");h&&(h.value=n,h.addEventListener("blur",(function(t){this.focus()})),h.addEventListener("keydown",(function(t){13!=t.keyCode&&"textarea"!=t.target.localName||(_(),t.preventDefault(),t.stopPropagation())})));var p=u.active_canvas.canvas,l=p.getBoundingClientRect(),d=-20,c=-20;function _(){!function(e){"Number"==t.type?e=Number(e):"Boolean"==t.type&&(e=Boolean(e)),o[r]=e,a.parentNode&&a.parentNode.removeChild(a),o.setDirtyCanvas(!0,!0)}(h.value)}l&&(d-=l.left,c-=l.top),event?(a.style.left=event.clientX+d+"px",a.style.top=event.clientY+c+"px"):(a.style.left=.5*p.width+d+"px",a.style.top=.5*p.height+c+"px"),a.querySelector("button").addEventListener("click",_),p.parentNode.appendChild(a)},u.prototype.prompt=function(t,e,i,s,o){var r=this;t=t||"";var n=!1,a=document.createElement("div");a.className="graphdialog rounded",a.innerHTML=o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",a.close=function(){r.prompt_box=null,a.parentNode&&a.parentNode.removeChild(a)},this.ds.scale>1&&(a.style.transform="scale("+this.ds.scale+")"),a.addEventListener("mouseleave",(function(t){n||a.close()})),r.prompt_box&&r.prompt_box.close(),r.prompt_box=a,a.querySelector(".name").innerText=t;var h=a.querySelector(".value");h.value=e;var p=h;p.addEventListener("keydown",(function(t){if(n=!0,27==t.keyCode)a.close();else{if(13!=t.keyCode||"textarea"==t.target.localName)return;i&&i(this.value),a.close()}t.preventDefault(),t.stopPropagation()})),a.querySelector("button").addEventListener("click",(function(t){i&&i(p.value),r.setDirty(!0),a.close()}));var l=u.active_canvas.canvas,d=l.getBoundingClientRect(),c=-20,_=-20;return d&&(c-=d.left,_-=d.top),s?(a.style.left=s.clientX+c+"px",a.style.top=s.clientY+_+"px"):(a.style.left=.5*l.width+c+"px",a.style.top=.5*l.height+_+"px"),l.parentNode.appendChild(a),setTimeout((function(){p.focus()}),10),a},u.search_limit=-1,u.prototype.showSearchBox=function(t){var i=this,s=u.active_canvas,o=s.canvas,r=o.ownerDocument||document,n=document.createElement("div");n.className="litegraph litesearchbox graphdialog rounded",n.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",n.close=function(){i.search_box=null,r.body.focus(),r.body.style.overflow="",setTimeout((function(){i.canvas.focus()}),20),n.parentNode&&n.parentNode.removeChild(n)};var a=null;this.ds.scale>1&&(n.style.transform="scale("+this.ds.scale+")"),n.addEventListener("mouseenter",(function(t){a&&(clearTimeout(a),a=null)})),n.addEventListener("mouseleave",(function(t){a=setTimeout((function(){n.close()}),500)})),i.search_box&&i.search_box.close(),i.search_box=n;var h=n.querySelector(".helper"),p=null,l=null,d=null,c=n.querySelector("input");c&&(c.addEventListener("blur",(function(t){this.focus()})),c.addEventListener("keydown",(function(t){if(38==t.keyCode)m(!1);else if(40==t.keyCode)m(!0);else if(27==t.keyCode)n.close();else{if(13!=t.keyCode)return l&&clearInterval(l),void(l=setTimeout(y,10));d?v(d.innerHTML):p?v(p):n.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0}))),r.fullscreenElement?r.fullscreenElement.appendChild(n):(r.body.appendChild(n),r.body.style.overflow="hidden");var _=o.getBoundingClientRect(),g=(t?t.clientX:_.left+.5*_.width)-80,f=(t?t.clientY:_.top+.5*_.height)-20;function v(o){if(o)if(i.onSearchBoxSelection)i.onSearchBoxSelection(o,t,s);else{var r=e.searchbox_extras[o.toLowerCase()];r&&(o=r.type),s.graph.beforeChange();var a=e.createNode(o);if(a&&(a.pos=s.convertEventToCanvasOffset(t),s.graph.add(a)),r&&r.data){if(r.data.properties)for(var u in r.data.properties)a.addProperty(u,r.data.properties[u]);if(r.data.inputs)for(var u in a.inputs=[],r.data.inputs)a.addOutput(r.data.inputs[u][0],r.data.inputs[u][1]);if(r.data.outputs)for(var u in a.outputs=[],r.data.outputs)a.addOutput(r.data.outputs[u][0],r.data.outputs[u][1]);r.data.title&&(a.title=r.data.title),r.data.json&&a.configure(r.data.json),s.graph.afterChange()}}n.close()}function m(t){var e=d;d&&d.classList.remove("selected"),d?(d=t?d.nextSibling:d.previousSibling)||(d=e):d=t?h.childNodes[0]:h.childNodes[h.childNodes.length],d&&(d.classList.add("selected"),d.scrollIntoView({block:"end",behavior:"smooth"}))}function y(){l=null;var t=c.value;if(p=null,h.innerHTML="",t)if(i.onSearchBox){var o=i.onSearchBox(h,t,s);if(o)for(var r=0;r<o.length;++r)m(o[r])}else{var n=0;t=t.toLowerCase();var a=s.filter||s.graph.filter;for(var r in e.searchbox_extras){var d=e.searchbox_extras[r];if(-1!==d.desc.toLowerCase().indexOf(t)){var _=e.registered_node_types[d.type];if((!_||_.filter==a)&&(m(d.desc,"searchbox_extra"),-1!==u.search_limit&&n++>u.search_limit))break}}var g=null;if(Array.prototype.filter)g=Object.keys(e.registered_node_types).filter(f);else for(var r in g=[],e.registered_node_types)f(r)&&g.push(r);for(r=0;r<g.length&&(m(g[r]),!(-1!==u.search_limit&&n++>u.search_limit));r++);function f(i){var s=e.registered_node_types[i];return(!a||s.filter==a)&&-1!==i.toLowerCase().indexOf(t)}}function m(t,e){var i=document.createElement("div");p||(p=t),i.innerText=t,i.dataset.type=escape(t),i.className="litegraph lite-search-item",e&&(i.className+=" "+e),i.addEventListener("click",(function(t){v(unescape(this.dataset.type))})),h.appendChild(i)}}return n.style.left=g+"px",n.style.top=f+"px",t.layerY>_.height-200&&(h.style.maxHeight=_.height-t.layerY-20+"px"),c.focus(),n},u.prototype.showEditPropertyValue=function(t,e,i){if(t&&void 0!==t.properties[e]){i=i||{};var s=t.getPropertyInfo(e),o=s.type,r="";if("string"==o||"number"==o||"array"==o||"object"==o)r="<input autofocus type='text' class='value'/>";else if("enum"!=o&&"combo"!=o||!s.values){if("boolean"!=o)return void console.warn("unknown type: "+o);r="<input autofocus type='checkbox' class='value' "+(t.properties[e]?"checked":"")+"/>"}else{for(var n in r="<select autofocus type='text' class='value'>",s.values){var a=n;s.values.constructor===Array&&(a=s.values[n]),r+="<option value='"+a+"' "+(a==t.properties[e]?"selected":"")+">"+s.values[n]+"</option>"}r+="</select>"}var u=this.createDialog("<span class='name'>"+(s.label?s.label:e)+"</span>"+r+"<button>OK</button>",i);if("enum"!=o&&"combo"!=o||!s.values)if("boolean"==o)(h=u.querySelector("input"))&&h.addEventListener("click",(function(t){l(!!h.checked)}));else{var h;(h=u.querySelector("input"))&&(h.addEventListener("blur",(function(t){this.focus()})),a=void 0!==t.properties[e]?t.properties[e]:"","string"!==o&&(a=JSON.stringify(a)),h.value=a,h.addEventListener("keydown",(function(t){13==t.keyCode&&(p(),t.preventDefault(),t.stopPropagation())})))}else(h=u.querySelector("select")).addEventListener("change",(function(t){l(t.target.value)}));return u.querySelector("button").addEventListener("click",p),u}function p(){l(h.value)}function l(r){s&&s.values&&s.values.constructor===Object&&null!=s.values[r]&&(r=s.values[r]),"number"==typeof t.properties[e]&&(r=Number(r)),"array"!=o&&"object"!=o||(r=JSON.parse(r)),t.properties[e]=r,t.graph&&t.graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,r),i.onclose&&i.onclose(),u.close(),t.setDirtyCanvas(!0,!0)}},u.prototype.createDialog=function(t,e){e=e||{};var i=document.createElement("div");i.className="graphdialog",i.innerHTML=t;var s=this.canvas.getBoundingClientRect(),o=-20,r=-20;return s&&(o-=s.left,r-=s.top),e.position?(o+=e.position[0],r+=e.position[1]):e.event?(o+=e.event.clientX,r+=e.event.clientY):(o+=.5*this.canvas.width,r+=.5*this.canvas.height),i.style.left=o+"px",i.style.top=r+"px",this.canvas.parentNode.appendChild(i),i.close=function(){this.parentNode&&this.parentNode.removeChild(this)},i},u.prototype.createPanel=function(t,i){var s=(i=i||{}).window||window,o=document.createElement("div");if(o.className="litegraph dialog",o.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div class='dialog-footer'></div>",o.header=o.querySelector(".dialog-header"),i.width&&(o.style.width=i.width+(i.width.constructor===Number?"px":"")),i.height&&(o.style.height=i.height+(i.height.constructor===Number?"px":"")),i.closable){var r=document.createElement("span");r.innerHTML="&#10005;",r.classList.add("close"),r.addEventListener("click",(function(){o.close()})),o.header.appendChild(r)}return o.title_element=o.querySelector(".dialog-title"),o.title_element.innerText=t,o.content=o.querySelector(".dialog-content"),o.footer=o.querySelector(".dialog-footer"),o.close=function(){this.parentNode.removeChild(this)},o.clear=function(){this.content.innerHTML=""},o.addHTML=function(t,e,i){var s=document.createElement("div");return e&&(s.className=e),s.innerHTML=t,i?o.footer.appendChild(s):o.content.appendChild(s),s},o.addButton=function(t,e,i){var s=document.createElement("button");return s.innerText=t,s.options=i,s.classList.add("btn"),s.addEventListener("click",e),o.footer.appendChild(s),s},o.addSeparator=function(){var t=document.createElement("div");t.className="separator",o.content.appendChild(t)},o.addWidget=function(t,i,r,n,a){n=n||{};var h=String(r);"number"==(t=t.toLowerCase())&&(h=r.toFixed(3));var p=document.createElement("div");p.className="property",p.innerHTML="<span class='property_name'></span><span class='property_value'></span>",p.querySelector(".property_name").innerText=i;var l=p.querySelector(".property_value");function d(t,e){console.log("change",t,e),n.callback&&n.callback(t,e),a&&a(t,e)}return l.innerText=h,p.dataset.property=i,p.dataset.type=n.type||t,p.options=n,p.value=r,"boolean"==t?(p.classList.add("boolean"),r&&p.classList.add("bool-on"),p.addEventListener("click",(function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",d(t,this.value)}))):"string"==t||"number"==t?(l.setAttribute("contenteditable",!0),l.addEventListener("keydown",(function(t){"Enter"==t.code&&(t.preventDefault(),this.blur())})),l.addEventListener("blur",(function(){var t=this.innerText,e=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(t=Number(t)),d(e,t)}))):"enum"!=t&&"combo"!=t||(h=u.getPropertyPrintableValue(r,n.values)),l.innerText=h,l.addEventListener("click",(function(t){var i=n.values||[],o=this.parentNode.dataset.property,r=this;new e.ContextMenu(i,{event:t,className:"dark",callback:function(t,e,i){return r.innerText=t,d(o,t),!1}},s)})),o.content.appendChild(p),p},o},u.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var i="";for(var s in e)if(e[s]==t){i=s;break}return String(t)+" ("+i+")"}},u.prototype.showShowNodePanel=function(t){window.SELECTED_NODE=t;var e=document.querySelector("#node-panel");e&&e.close();var i=this.getCanvasWindow();(e=this.createPanel(t.title||"",{closable:!0,window:i})).id="node-panel",e.node=t,e.classList.add("settings");var s=this;(function(){for(var i in e.content.innerHTML="",e.addHTML("<span class='node_type'>"+t.type+"</span><span class='node_desc'>"+(t.constructor.desc||"")+"</span><span class='separator'></span>"),e.addHTML("<h3>Properties</h3>"),t.properties){var o=t.properties[i],r=t.getPropertyInfo(i);r.type,t.onAddPropertyToPanel&&t.onAddPropertyToPanel(i,e)||e.addWidget(r.widget||r.type,i,o,r,(function(e,i){s.graph.beforeChange(t),t.setProperty(e,i),s.graph.afterChange(),s.dirty_canvas=!0}))}e.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(e),e.addButton("Delete",(function(){t.block_delete||(t.graph.remove(t),e.close())})).classList.add("delete")})(),this.canvas.parentNode.appendChild(e)},u.prototype.showSubgraphPropertiesDialog=function(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var i=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function s(){if(i.clear(),t.inputs)for(var e=0;e<t.inputs.length;++e){var o=t.inputs[e];if(!o.not_subgraph_input){var r=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");r.dataset.name=o.name,r.dataset.slot=e,r.querySelector(".name").innerText=o.name,r.querySelector(".type").innerText=o.type,r.querySelector("button").addEventListener("click",(function(e){t.removeInput(Number(this.parentNode.dataset.slot)),s()}))}}}return i.node=t,i.classList.add("subgraph_dialog"),i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(e){var i=this.parentNode,o=i.querySelector(".name").value,r=i.querySelector(".type").value;o&&-1==t.findInputSlot(o)&&(t.addInput(o,r),i.querySelector(".name").value="",i.querySelector(".type").value="",s())})),s(),this.canvas.parentNode.appendChild(i),i},u.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var i=t[e];i.node&&(i.node.graph&&i.graph==this.graph||i.close())}},u.onMenuNodeCollapse=function(t,e,i,s,o){o.graph.beforeChange(o),o.collapse(),o.graph.afterChange(o)},u.onMenuNodePin=function(t,e,i,s,o){o.pin()},u.onMenuNodeMode=function(t,i,s,o,r){return new e.ContextMenu(["Always","On Event","On Trigger","Never"],{event:s,callback:function(t){if(r)switch(t){case"On Event":r.mode=e.ON_EVENT;break;case"On Trigger":r.mode=e.ON_TRIGGER;break;case"Never":r.mode=e.NEVER;break;case"Always":default:r.mode=e.ALWAYS}},parentMenu:o,node:r}),!1},u.onMenuNodeColors=function(t,i,s,o,r){if(!r)throw"no node for color";var n=[];for(var a in n.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),u.node_colors){var h=u.node_colors[a];t={value:a,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+h.color+"; background-color:"+h.bgcolor+"'>"+a+"</span>"},n.push(t)}return new e.ContextMenu(n,{event:s,callback:function(t){if(r){var i=t.value?u.node_colors[t.value]:null;i?r.constructor===e.LGraphGroup?r.color=i.groupcolor:(r.color=i.color,r.bgcolor=i.bgcolor):(delete r.color,delete r.bgcolor),r.setDirtyCanvas(!0,!0)}},parentMenu:o,node:r}),!1},u.onMenuNodeShapes=function(t,i,s,o,r){if(!r)throw"no node passed";return new e.ContextMenu(e.VALID_SHAPES,{event:s,callback:function(t){r&&(r.graph.beforeChange(r),r.shape=t,r.graph.afterChange(r),r.setDirtyCanvas(!0))},parentMenu:o,node:r}),!1},u.onMenuNodeRemove=function(t,e,i,s,o){if(!o)throw"no node passed";if(!1!==o.removable){var r=o.graph;r.beforeChange(),r.remove(o),r.afterChange(),o.setDirtyCanvas(!0,!0)}},u.onMenuNodeToSubgraph=function(t,i,s,o,r){var n=r.graph,a=u.active_canvas;if(a){var h=Object.values(a.selected_nodes||{});h.length||(h=[r]);var p=e.createNode("graph/subgraph");p.pos=r.pos.concat(),n.add(p),p.buildFromNodes(h),a.deselectAllNodes(),r.setDirtyCanvas(!0,!0)}},u.onMenuNodeClone=function(t,e,i,s,o){if(0!=o.clonable){var r=o.clone();r&&(r.pos=[o.pos[0]+5,o.pos[1]+5],o.graph.beforeChange(),o.graph.add(r),o.graph.afterChange(),o.setDirtyCanvas(!0,!0))}},u.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},u.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:u.onMenuAdd},{content:"Add Group",callback:u.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t},u.prototype.getNodeMenuOptions=function(t){var e=null;if(e=t.getMenuOptions?t.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:u.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:u.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:u.onShowMenuNodeProperties},null,{content:"Title",callback:u.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:u.onMenuNodeMode},{content:"Resize",callback:function(){if(t.resizable)return u.onResizeNode}},{content:"Collapse",callback:u.onMenuNodeCollapse},{content:"Pin",callback:u.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:u.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:u.onMenuNodeShapes},null],t.onGetInputs){var i=t.onGetInputs();i&&i.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var s=t.onGetOutputs();s&&s.length&&(e[1].disabled=!1)}if(t.getExtraMenuOptions){var o=t.getExtraMenuOptions(this,e);o&&(o.push(null),e=o.concat(e))}return!1!==t.clonable&&e.push({content:"Clone",callback:u.onMenuNodeClone}),e.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:u.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(e,t),e},u.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:u.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:u.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:u.onShowPropertyEditor},null,{content:"Remove",callback:u.onMenuNodeRemove}]},u.prototype.processContextMenu=function(t,i){var s=this,o=u.active_canvas.getCanvasWindow(),r=null,n={event:i,callback:function(e,i,o){if(e)if("Remove Slot"!=e.content)if("Disconnect Links"!=e.content){if("Rename Slot"==e.content){var r,n=(r=e.slot).input?t.getInputInfo(r.slot):t.getOutputInfo(r.slot),a=s.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",i),u=a.querySelector("input");u&&n&&(u.value=n.label||""),a.querySelector("button").addEventListener("click",(function(t){u.value&&(n&&(n.label=u.value),s.setDirty(!0)),a.close()}))}}else(r=e.slot).output?t.disconnectOutput(r.slot):r.input&&t.disconnectInput(r.slot);else(r=e.slot).input?t.removeInput(r.slot):r.output&&t.removeOutput(r.slot)},extra:t};t&&(n.title=t.type);var a=null;if(t&&(a=t.getSlotInPosition(i.canvasX,i.canvasY),u.active_node=t),a){if(r=[],t.getSlotMenuOptions)r=t.getSlotMenuOptions(a);else{a&&a.output&&a.output.links&&a.output.links.length&&r.push({content:"Disconnect Links",slot:a});var h=a.input||a.output;r.push(h.locked?"Cannot remove":{content:"Remove Slot",slot:a}),r.push(h.nameLocked?"Cannot rename":{content:"Rename Slot",slot:a})}n.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==e.ACTION&&(n.title="Action"),a.output&&a.output.type==e.EVENT&&(n.title="Event")}else if(t)r=this.getNodeMenuOptions(t);else{r=this.getCanvasMenuOptions();var p=this.graph.getGroupOnPos(i.canvasX,i.canvasY);p&&r.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:p,options:this.getGroupMenuOptions(p)}})}r&&new e.ContextMenu(r,n,o)},"undefined"!=typeof window&&window.CanvasRenderingContext2D&&(window.CanvasRenderingContext2D.prototype.roundRect=function(t,e,i,s,o,r){void 0===o&&(o=5),void 0===r&&(r=o),this.moveTo(t+o,e),this.lineTo(t+i-o,e),this.quadraticCurveTo(t+i,e,t+i,e+o),this.lineTo(t+i,e+s-r),this.quadraticCurveTo(t+i,e+s,t+i-r,e+s),this.lineTo(t+r,e+s),this.quadraticCurveTo(t,e+s,t,e+s-r),this.lineTo(t,e+o),this.quadraticCurveTo(t,e,t+o,e)}),e.compareObjects=function(t,e){for(var i in t)if(t[i]!=e[i])return!1;return!0},e.distance=f,e.colorToString=function(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"},e.isInsideRectangle=v,e.growBounding=function(t,e,i){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),i<t[1]?t[1]=i:i>t[3]&&(t[3]=i)},e.isInsideBounding=function(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])},e.overlapBounding=m,e.hex2num=function(t){"#"==t.charAt(0)&&(t=t.slice(1)),t=t.toUpperCase();for(var e,i,s="0123456789ABCDEF",o=new Array(3),r=0,n=0;n<6;n+=2)e=s.indexOf(t.charAt(n)),i=s.indexOf(t.charAt(n+1)),o[r]=16*e+i,r++;return o},e.num2hex=function(t){for(var e,i,s="0123456789ABCDEF",o="#",r=0;r<3;r++)e=t[r]/16,i=t[r]%16,o+=s.charAt(e)+s.charAt(i);return o},y.prototype.addItem=function(t,e,i){var s=this;i=i||{};var o=document.createElement("div");o.className="litemenu-entry submenu";var r=!1;function n(t){var e=this.value,o=!0;if(s.current_submenu&&s.current_submenu.close(t),i.callback&&!0===i.callback.call(this,e,i,t,s,i.node)&&(o=!1),e&&(e.callback&&!i.ignore_item_callbacks&&!0!==e.disabled&&!0===e.callback.call(this,e,i,t,s,i.extra)&&(o=!1),e.submenu)){if(!e.submenu.options)throw"ContextMenu submenu needs options";new s.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:s,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:i.autoopen}),o=!1}o&&!s.lock&&s.close()}return null===e?o.classList.add("separator"):(o.innerHTML=e&&e.title?e.title:t,o.value=e,e&&(e.disabled&&(r=!0,o.classList.add("disabled")),(e.submenu||e.has_submenu)&&o.classList.add("has_submenu")),"function"==typeof e?(o.dataset.value=t,o.onclick_callback=e):o.dataset.value=e,e.className&&(o.className+=" "+e.className)),this.root.appendChild(o),r||o.addEventListener("click",n),i.autoopen&&o.addEventListener("mouseenter",(function(t){var e=this.value;e&&e.has_submenu&&n.call(this,t)})),o},y.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!y.isCursorOverElement(t,this.parentMenu.root)&&y.trigger(this.parentMenu.root,"mouseleave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},y.trigger=function(t,e,i,s){var o=document.createEvent("CustomEvent");return o.initCustomEvent(e,!0,!0,i),o.srcElement=s,t.dispatchEvent?t.dispatchEvent(o):t.__events&&t.__events.dispatchEvent(o),o},y.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},y.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},y.isCursorOverElement=function(t,e){var i=t.clientX,s=t.clientY,o=e.getBoundingClientRect();return!!o&&s>o.top&&s<o.top+o.height&&i>o.left&&i<o.left+o.width},e.ContextMenu=y,e.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var i=[],s=0;s<e.length;s++)i.push(e[s]);for(s=0;s<i.length;s++)i[s].close?i[s].close():i[s].parentNode&&i[s].parentNode.removeChild(i[s])}},e.extendClass=function(t,e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i]);if(e.prototype)for(var i in e.prototype)e.prototype.hasOwnProperty(i)&&(t.prototype.hasOwnProperty(i)||(e.prototype.__lookupGetter__(i)?t.prototype.__defineGetter__(i,e.prototype.__lookupGetter__(i)):t.prototype[i]=e.prototype[i],e.prototype.__lookupSetter__(i)&&t.prototype.__defineSetter__(i,e.prototype.__lookupSetter__(i))))},x.sampleCurve=function(t,e){if(e){for(var i=0;i<e.length-1;++i){var s=e[i],o=e[i+1];if(!(o[0]<t)){var r=o[0]-s[0];if(Math.abs(r)<1e-5)return s[1];var n=(t-s[0])/r;return s[1]*(1-n)+o[1]*n}}return 0}},x.prototype.draw=function(t,e,i,s,o,r){var n=this.points;if(n){this.size=e;var a=e[0]-2*this.margin,u=e[1]-2*this.margin;o=o||"#666",t.save(),t.translate(this.margin,this.margin),s&&(t.fillStyle="#111",t.fillRect(0,0,a,u),t.fillStyle="#222",t.fillRect(.5*a,0,1,u),t.strokeStyle="#333",t.strokeRect(0,0,a,u)),t.strokeStyle=o,r&&(t.globalAlpha=.5),t.beginPath();for(var h=0;h<n.length;++h){var p=n[h];t.lineTo(p[0]*a,(1-p[1])*u)}if(t.stroke(),t.globalAlpha=1,!r)for(h=0;h<n.length;++h)p=n[h],t.fillStyle=this.selected==h?"#FFF":this.nearest==h?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*a,(1-p[1])*u,2,0,2*Math.PI),t.fill();t.restore()}},x.prototype.onMouseDown=function(t,e){var i=this.points;if(i&&!(t[1]<0)){var s=this.size[0]-2*this.margin,o=this.size[1]-2*this.margin,r=t[0]-this.margin,n=t[1]-this.margin,a=[r,n],u=30/e.ds.scale;if(this.selected=this.getCloserPoint(a,u),-1==this.selected){var h=[r/s,1-n/o];i.push(h),i.sort((function(t,e){return t[0]-e[0]})),this.selected=i.indexOf(h),this.must_update=!0}return-1!=this.selected||void 0}},x.prototype.onMouseMove=function(t,e){var i=this.points;if(i){var s=this.selected;if(!(s<0)){var o=(t[0]-this.margin)/(this.size[0]-2*this.margin),r=(t[1]-this.margin)/(this.size[1]-2*this.margin),n=[t[0]-this.margin,t[1]-this.margin],a=30/e.ds.scale;this._nearest=this.getCloserPoint(n,a);var u=i[s];if(u){var h=0==s||s==i.length-1;if(!h&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10))return i.splice(s,1),void(this.selected=-1);u[0]=h?0==s?0:1:Math.clamp(o,0,1),u[1]=1-Math.clamp(r,0,1),i.sort((function(t,e){return t[0]-e[0]})),this.selected=i.indexOf(u),this.must_update=!0}}}},x.prototype.onMouseUp=function(t,e){return this.selected=-1,!1},x.prototype.getCloserPoint=function(t,e){var i=this.points;if(!i)return-1;e=e||30;for(var s=this.size[0]-2*this.margin,o=this.size[1]-2*this.margin,r=i.length,n=[0,0],a=1e6,u=-1,h=0;h<r;++h){var p=i[h];n[0]=p[0]*s,n[1]=(1-p[1])*o,n[0],t[0];var l=vec2.distance(t,n);l>a||l>e||(u=h,a=l)}return u},e.CurveEditor=x,e.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},Math.clamp=function(t,e,i){return e>t?e:i<t?i:t},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),e.LiteGraph=this.LiteGraph,function(t){var e=t.LiteGraph;function i(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}function s(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new e.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}function o(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var t=this;this.name_widget=this.addWidget("text","Name",this.properties.name,(function(e){e&&t.setProperty("name",e)})),this.type_widget=this.addWidget("text","Type",this.properties.type,(function(e){t.setProperty("type",e)})),this.value_widget=this.addWidget("number","Value",this.properties.value,(function(e){t.setProperty("value",e)})),this.widgets_up=!0,this.size=[180,90]}function r(){this.addInput("",""),this.name_in_graph="",this.properties={};var t=this;Object.defineProperty(this.properties,"name",{get:function(){return t.name_in_graph},set:function(e){""!=e&&e!=t.name_in_graph&&(t.name_in_graph?t.graph.renameOutput(t.name_in_graph,e):t.graph.addOutput(e,t.properties.type),t.name_widget.value=e,t.name_in_graph=e)},enumerable:!0}),Object.defineProperty(this.properties,"type",{get:function(){return t.inputs[0].type},set:function(i){"action"!=i&&"event"!=i||(i=e.ACTION),e.isValidConnection(t.inputs[0].type,i)||t.disconnectInput(0),t.inputs[0].type=i,t.name_in_graph&&t.graph.changeOutputType(t.name_in_graph,t.inputs[0].type),t.type_widget.value=i||""},enumerable:!0}),this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}function n(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}function a(){this.addOutput("","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.widgets_up=!0,this.size=[140,30]}function u(){this.addOutput("","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}function h(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}function p(){this.addInput("url",""),this.addOutput("",""),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}function l(){this.addOutput("",""),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}function d(){this._value=[],this.addInput("",""),this.addOutput("","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}function c(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index")}function _(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}function g(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}function f(){this.addInput("obj",""),this.addOutput("",""),this.addProperty("value",""),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}function v(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}function m(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}function y(){this.addInput("A",""),this.addInput("B",""),this.addOutput("",""),this._result={};var t=this;this.addWidget("button","clear","",(function(){t._result={}})),this.size=this.computeSize()}function x(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:x.LITEGRAPH},this.value=null}function b(){this.size=[60,30],this.addInput("data",0),this.addInput("download",e.ACTION),this.properties={filename:"data.json"},this.value=null;var t=this;this.addWidget("button","Download","",(function(e){t.value&&t.downloadAsFile()}))}function T(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}function E(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}function w(){this.mode=e.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",e.EVENT),this.addInput("msg",0)}function I(){this.mode=e.ON_EVENT,this.addProperty("msg",""),this.addInput("",e.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}function O(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",""),this.addInput("B",""),this.addOutput("out",""),this._func=null,this.data={}}i.title="Time",i.desc="Time",i.prototype.onExecute=function(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)},e.registerNodeType("basic/time",i),s.title="Subgraph",s.desc="Graph inside a node",s.title_color="#334",s.prototype.onGetInputs=function(){return[["enabled","boolean"]]},s.prototype.onDblClick=function(t,e,i){var s=this;setTimeout((function(){i.openSubgraph(s.subgraph)}),10)},s.prototype.onAction=function(t,e){this.subgraph.onAction(t,e)},s.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);this.subgraph.setInputData(e.name,i)}if(this.subgraph.runStep(),this.outputs)for(t=0;t<this.outputs.length;t++){var s=this.outputs[t];i=this.subgraph.getOutputData(s.name),this.setOutputData(t,i)}}},s.prototype.sendEventToAllNodes=function(t,e,i){this.enabled&&this.subgraph.sendEventToAllNodes(t,e,i)},s.prototype.onDrawBackground=function(t,i,s,o){if(!this.flags.collapsed){var r=this.size[1]-e.NODE_TITLE_HEIGHT+.5,n=e.isInsideRectangle(o[0],o[1],this.pos[0],this.pos[1]+r,this.size[0],e.NODE_TITLE_HEIGHT);t.fillStyle=n?"#555":"#222",t.beginPath(),this._shape==e.BOX_SHAPE?t.rect(0,r,this.size[0]+1,e.NODE_TITLE_HEIGHT):t.roundRect(0,r,this.size[0]+1,e.NODE_TITLE_HEIGHT,0,8),t.fill(),t.textAlign="center",t.font="24px Arial",t.fillStyle=n?"#DDD":"#999",t.fillText("+",.5*this.size[0],r+24)}},s.prototype.onMouseDown=function(t,i,s){var o=this.size[1]-e.NODE_TITLE_HEIGHT+.5;i[1]>o&&s.showSubgraphPropertiesDialog(this)},s.prototype.computeSize=function(){var t=this.inputs?this.inputs.length:0,i=this.outputs?this.outputs.length:0;return[200,Math.max(t,i)*e.NODE_SLOT_HEIGHT+e.NODE_TITLE_HEIGHT]},s.prototype.onSubgraphTrigger=function(t,e){var i=this.findOutputSlot(t);-1!=i&&this.triggerSlot(i)},s.prototype.onSubgraphNewInput=function(t,e){-1==this.findInputSlot(t)&&this.addInput(t,e)},s.prototype.onSubgraphRenamedInput=function(t,e){var i=this.findInputSlot(t);-1!=i&&(this.getInputInfo(i).name=e)},s.prototype.onSubgraphTypeChangeInput=function(t,e){var i=this.findInputSlot(t);-1!=i&&(this.getInputInfo(i).type=e)},s.prototype.onSubgraphRemovedInput=function(t){var e=this.findInputSlot(t);-1!=e&&this.removeInput(e)},s.prototype.onSubgraphNewOutput=function(t,e){-1==this.findOutputSlot(t)&&this.addOutput(t,e)},s.prototype.onSubgraphRenamedOutput=function(t,e){var i=this.findOutputSlot(t);-1!=i&&(this.getOutputInfo(i).name=e)},s.prototype.onSubgraphTypeChangeOutput=function(t,e){var i=this.findOutputSlot(t);-1!=i&&(this.getOutputInfo(i).type=e)},s.prototype.onSubgraphRemovedOutput=function(t){var e=this.findInputSlot(t);-1!=e&&this.removeOutput(e)},s.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Open",callback:function(){t.openSubgraph(e.subgraph)}}]},s.prototype.onResize=function(t){t[1]+=20},s.prototype.serialize=function(){var t=e.LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t},s.prototype.clone=function(){var t=e.createNode(this.type),i=this.serialize();return delete i.id,delete i.inputs,delete i.outputs,t.configure(i),t},s.prototype.buildFromNodes=function(t){for(var e={},i=0,s=0;s<t.length;++s)e[(o=t[s]).id]=o,i=Math.min(o.pos[0],i),Math.max(o.pos[0],i);for(s=0;s<t.length;++s){var o;if((o=t[s]).inputs)for(var r=0;r<o.inputs.length;++r){var n=o.inputs[r];n&&n.link&&(h=o.graph.links[n.link])&&(e[h.origin_id]||this.subgraph.addInput(n.name,h.type))}if(o.outputs)for(r=0;r<o.outputs.length;++r){var a=o.outputs[r];if(a&&a.links&&a.links.length)for(var u=0;u<a.links.length;++u){var h;if((h=o.graph.links[a.links[u]])&&!e[h.target_id])break}}}},e.Subgraph=s,e.registerNodeType("graph/subgraph",s),o.title="Input",o.desc="Input of the graph",o.prototype.onConfigure=function(){this.updateType()},o.prototype.updateType=function(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(e.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),"number"==t?(this.value_widget.type="number",this.value_widget.value=0):"boolean"==t?(this.value_widget.type="toggle",this.value_widget.value=!0):"string"==t?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)},o.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,e):this.graph.addInput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},o.prototype.onAction=function(t,i){this.properties.type==e.EVENT&&this.triggerSlot(0,i)},o.prototype.onExecute=function(){var t=this.properties.name,e=this.graph.inputs[t];e?this.setOutputData(0,void 0!==e.value?e.value:this.properties.value):this.setOutputData(0,this.properties.value)},o.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},e.GraphInput=o,e.registerNodeType("graph/input",o),r.title="Output",r.desc="Output of the graph",r.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},r.prototype.onAction=function(t,i){this.properties.type==e.ACTION&&this.graph.trigger(this.properties.name,i)},r.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},r.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},e.GraphOutput=r,e.registerNodeType("graph/output",r),n.title="Const Number",n.desc="Constant number",n.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},n.prototype.setValue=function(t){this.setProperty("value",t)},n.prototype.onDrawBackground=function(t){this.outputs[0].label=this.properties.value.toFixed(3)},e.registerNodeType("basic/const",n),a.title="Const Boolean",a.desc="Constant boolean",a.prototype.getTitle=n.prototype.getTitle,a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},a.prototype.setValue=n.prototype.setValue,a.prototype.onGetInputs=function(){return[["toggle",e.ACTION]]},a.prototype.onAction=function(t){this.setValue(!this.properties.value)},e.registerNodeType("basic/boolean",a),u.title="Const String",u.desc="Constant string",u.prototype.getTitle=n.prototype.getTitle,u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},u.prototype.setValue=n.prototype.setValue,u.prototype.onDropFile=function(t){var e=this,i=new FileReader;i.onload=function(t){e.setProperty("value",t.target.result)},i.readAsText(t)},e.registerNodeType("basic/string",u),h.title="Const Object",h.desc="Constant Object",h.prototype.onExecute=function(){this.setOutputData(0,this._object)},e.registerNodeType("basic/object",h),p.title="Const File",p.desc="Fetches a file from an url",p["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},p.prototype.onPropertyChanged=function(t,e){"url"==t&&(null==e||""==e?this._data=null:this.fetchFile(e))},p.prototype.onExecute=function(){var t=this.getInputData(0)||this.properties.url;!t||t==this._url&&this._type==this.properties.type||this.fetchFile(t),this.setOutputData(0,this._data)},p.prototype.setValue=n.prototype.setValue,p.prototype.fetchFile=function(t){var i=this;if(!t||t.constructor!==String)return i._data=null,void(i.boxcolor=null);this._url=t,this._type=this.properties.type,"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then((function(t){if(!t.ok)throw new Error("File not found");return"arraybuffer"==i.properties.type?t.arrayBuffer():"text"==i.properties.type?t.text():"json"==i.properties.type?t.json():"blob"==i.properties.type?t.blob():void 0})).then((function(t){i._data=t,i.boxcolor="#AEA"})).catch((function(e){i._data=null,i.boxcolor="red",console.error("error fetching file:",t)}))},p.prototype.onDropFile=function(t){var e=this;this._url=t.name,this._type=this.properties.type,this.properties.url=t.name;var i=new FileReader;if(i.onload=function(t){e.boxcolor="#AEA";var i=t.target.result;"json"==e.properties.type&&(i=JSON.parse(i)),e._data=i},"arraybuffer"==e.properties.type)i.readAsArrayBuffer(t);else if("text"==e.properties.type||"json"==e.properties.type)i.readAsText(t);else if("blob"==e.properties.type)return i.readAsBinaryString(t)},e.registerNodeType("basic/file",p),l.title="Const Data",l.desc="Constant Data",l.prototype.onPropertyChanged=function(t,e){if(this.widget.value=e,null!=e&&""!=e)try{this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},l.prototype.onExecute=function(){this.setOutputData(0,this._value)},l.prototype.setValue=n.prototype.setValue,e.registerNodeType("basic/data",l),d.title="Const Array",d.desc="Constant Array",d.prototype.onPropertyChanged=function(t,e){if(this.widget.value=e,null!=e&&""!=e)try{"["!=e[0]?this._value=JSON.parse("["+e+"]"):this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},d.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=new Array),this._value.length=t.length;for(var e=0;e<t.length;++e)this._value[e]=t[e]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},d.prototype.setValue=n.prototype.setValue,e.registerNodeType("basic/array",d),c.title="Set Array",c.desc="Sets index of array",c.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputData(1);void 0!==e&&(this.properties.index&&(t[Math.floor(this.properties.index)]=e),this.setOutputData(0,t))}},e.registerNodeType("basic/set_array",c),_.title="Array[i]",_.desc="Returns an element from an array",_.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);null==e&&(e=this.properties.index),null!=t&&null!=e&&this.setOutputData(0,t[Math.floor(Number(e))])},e.registerNodeType("basic/array[]",_),g.title="Table[row][col]",g.desc="Returns an element from a table",g.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);null==e&&(e=this.properties.row),null==i&&(i=this.properties.column),null!=t&&null!=e&&null!=i&&((e=t[Math.floor(Number(e))])?this.setOutputData(0,e[Math.floor(Number(i))]):this.setOutputData(0,null))},e.registerNodeType("basic/table[][]",g),f.title="Object property",f.desc="Outputs the property of an object",f.prototype.setValue=function(t){this.properties.value=t,this.widget.value=t},f.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},f.prototype.onPropertyChanged=function(t,e){this.widget.value=e},f.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t[this.properties.value])},e.registerNodeType("basic/object_property",f),v.title="Object keys",v.desc="Outputs an array with the keys of an object",v.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Object.keys(t))},e.registerNodeType("basic/object_keys",v),m.title="Set Object",m.desc="Adds propertiesrty to object",m.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputData(1);void 0!==e&&(this.properties.property&&(t[this.properties.property]=e),this.setOutputData(0,t))}},e.registerNodeType("basic/set_object",m),y.title="Merge Objects",y.desc="Creates an object copying properties from others",y.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this._result;if(t)for(var s in t)i[s]=t[s];if(e)for(var s in e)i[s]=e[s];this.setOutputData(0,i)},e.registerNodeType("basic/merge_objects",y),x.title="Variable",x.desc="store/read variable value",x.LITEGRAPH=0,x.GRAPH=1,x.GLOBALSCOPE=2,x["@container"]={type:"enum",values:{litegraph:x.LITEGRAPH,graph:x.GRAPH,global:x.GLOBALSCOPE}},x.prototype.onExecute=function(){var t=this.getContainer();if(this.isInputConnected(0))return this.value=this.getInputData(0),t[this.properties.varname]=this.value,void this.setOutputData(0,this.value);this.setOutputData(0,t[this.properties.varname])},x.prototype.getContainer=function(){switch(this.properties.container){case x.GRAPH:return this.graph?this.graph.vars:{};case x.GLOBALSCOPE:return t;case x.LITEGRAPH:default:return e.Globals}},x.prototype.getTitle=function(){return this.properties.varname},e.registerNodeType("basic/variable",x),e.wrapFunctionAsNode("basic/length",(function(t){return t&&null!=t.length?Number(t.length):0}),[""],"number"),b.title="Download",b.desc="Download some data",b.prototype.downloadAsFile=function(){if(null!=this.value){var t;t=this.value.constructor===String?this.value:JSON.stringify(this.value);var e=new Blob([t]),i=URL.createObjectURL(e),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",this.properties.filename),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout((function(){URL.revokeObjectURL(i)}),6e4)}},b.prototype.onAction=function(t,e){var i=this;setTimeout((function(){i.downloadAsFile()}),100)},b.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},b.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},e.registerNodeType("basic/download",b),T.title="Watch",T.desc="Show value of input",T.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},T.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},T.toString=function(t){if(null==t)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor===Array){for(var e="[",i=0;i<t.length;++i)e+=T.toString(t[i])+(i+1!=t.length?",":"");return e+"]"}return String(t)},T.prototype.onDrawBackground=function(t){this.inputs[0].label=T.toString(this.value)},e.registerNodeType("basic/watch",T),E.title="Cast",E.desc="Allows to connect different types",E.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},e.registerNodeType("basic/cast",E),w.title="Console",w.desc="Show value inside the console",w.prototype.onAction=function(t,e){"log"==t?console.log(e):"warn"==t?console.warn(e):"error"==t&&console.error(e)},w.prototype.onExecute=function(){var t=this.getInputData(1);null!==t&&(this.properties.msg=t),console.log(t)},w.prototype.onGetInputs=function(){return[["log",e.ACTION],["warn",e.ACTION],["error",e.ACTION]]},e.registerNodeType("basic/console",w),I.title="Alert",I.desc="Show an alert window",I.color="#510",I.prototype.onConfigure=function(t){this.widget.value=t.properties.msg},I.prototype.onAction=function(t,e){var i=this.properties.msg;setTimeout((function(){alert(i)}),10)},e.registerNodeType("basic/alert",I),O.prototype.onConfigure=function(t){t.properties.onExecute&&e.allow_scripts?this.compileCode(t.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},O.title="Script",O.desc="executes a code (max 100 characters)",O.widgets_info={onExecute:{type:"code"}},O.prototype.onPropertyChanged=function(t,i){"onExecute"==t&&e.allow_scripts?this.compileCode(i):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},O.prototype.compileCode=function(t){if(this._func=null,t.length>256)console.warn("Script too long, max 256 chars");else{for(var e=t.toLowerCase(),i=["script","body","document","eval","nodescript","function"],s=0;s<i.length;++s)if(-1!=e.indexOf(i[s]))return void console.warn("invalid script");try{this._func=new Function("A","B","C","DATA","node",t)}catch(t){console.error("Error parsing script"),console.error(t)}}},O.prototype.onExecute=function(){if(this._func)try{var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);this.setOutputData(0,this._func(t,e,i,this.data,this))}catch(t){console.error("Error in script"),console.error(t)}},O.prototype.onGetOutputs=function(){return[["C",""]]},e.registerNodeType("basic/script",O)}(this),function(t){var e=t.LiteGraph;function i(){this.size=[60,30],this.addInput("event",e.ACTION)}function s(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",e.EVENT),this.addOutput("change",e.EVENT),this.addOutput("false",e.EVENT),this.properties={only_on_change:!0},this.prev=0}function o(){this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addInput("",e.ACTION),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.addOutput("",e.EVENT),this.size=[120,30],this.flags={horizontal:!0,render_box:!1}}function r(){this.size=[60,30],this.addInput("event",e.ACTION),this.addOutput("event",e.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}function n(){this.addInput("in",e.ACTION),this.addInput("cond","boolean"),this.addOutput("true",e.EVENT),this.addOutput("false",e.EVENT),this.size=[120,60],this._value=!1}function a(){this.addInput("inc",e.ACTION),this.addInput("dec",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("change",e.EVENT),this.addOutput("num","number"),this.num=0}function u(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",e.ACTION),this.addOutput("on_time",e.EVENT),this._pending=[]}function h(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",e.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}function p(){this.addInput("data",""),this.addInput("assign",e.ACTION),this.addOutput("data",""),this._last_value=null,this.properties={data:null,serialize:!0};var t=this;this.addWidget("button","store","",(function(){t.properties.data=t._last_value}))}i.title="Log Event",i.desc="Log event in console",i.prototype.onAction=function(t,e){console.log(t,e)},e.registerNodeType("events/log",i),s.title="TriggerEvent",s.desc="Triggers event if input evaluates to true",s.prototype.onExecute=function(t,e){var i=this.getInputData(0),s=i!=this.prev;0===this.prev&&(s=!1);var o=s&&this.properties.only_on_change||!s&&!this.properties.only_on_change;i&&o&&this.triggerSlot(0,e),!i&&o&&this.triggerSlot(2,e),s&&this.triggerSlot(1,e),this.prev=i},e.registerNodeType("events/trigger",s),o.title="Sequencer",o.desc="Trigger events when an event arrives",o.prototype.getTitle=function(){return""},o.prototype.onAction=function(t,e){if(this.outputs)for(var i=0;i<this.outputs.length;++i)this.triggerSlot(i,e)},e.registerNodeType("events/sequencer",o),r.title="Filter Event",r.desc="Blocks events that do not match the filter",r.prototype.onAction=function(t,e){if(null!=e&&(!this.properties.equal_to||this.properties.equal_to==e)){if(this.properties.has_property){var i=e[this.properties.has_property];if(null==i)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=i)return}this.triggerSlot(0,e)}},e.registerNodeType("events/filter",r),n.title="Branch",n.desc="If condition is true, outputs triggers true, otherwise false",n.prototype.onExecute=function(){this._value=this.getInputData(1)},n.prototype.onAction=function(t,e){this.triggerSlot(this._value?0:1)},e.registerNodeType("events/branch",n),a.title="Counter",a.desc="Counts events",a.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},a.prototype.onAction=function(t,e){var i=this.num;"inc"==t?this.num+=1:"dec"==t?this.num-=1:"reset"==t&&(this.num=0),this.num!=i&&this.trigger("change",this.num)},a.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.fillStyle="#AAA",t.font="20px Arial",t.textAlign="center",t.fillText(this.num,.5*this.size[0],.5*this.size[1]))},a.prototype.onExecute=function(){this.setOutputData(1,this.num)},e.registerNodeType("events/counter",a),u.title="Delay",u.desc="Delays one event",u.prototype.onAction=function(t,e){var i=this.properties.time_in_ms;i<=0?this.trigger(null,e):this._pending.push([i,e])},u.prototype.onExecute=function(){var t=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var e=0;e<this._pending.length;++e){var i=this._pending[e];i[0]-=t,i[0]>0||(this._pending.splice(e,1),--e,this.trigger(null,i[1]))}},u.prototype.onGetInputs=function(){return[["event",e.ACTION],["time_in_ms","number"]]},e.registerNodeType("events/delay",u),h.title="Timer",h.desc="Sends an event every N milliseconds",h.prototype.onStart=function(){this.time=0},h.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},h.on_color="#AAA",h.off_color="#222",h.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?h.on_color:h.off_color,this.triggered=!1},h.prototype.onExecute=function(){var t=1e3*this.graph.elapsed_time,e=0==this.time;this.time+=t,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),e||!(this.time<this.last_interval||isNaN(this.last_interval))?(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)):this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1)},h.prototype.onGetInputs=function(){return[["interval","number"]]},h.prototype.onGetOutputs=function(){return[["tick","boolean"]]},e.registerNodeType("events/timer",h),p.title="Data Store",p.desc="Stores data and only changes when event is received",p.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},p.prototype.onAction=function(t,e){this.properties.data=this._last_value},p.prototype.onSerialize=function(t){null!=t.data&&(0==this.properties.serialize||t.data.constructor!==String&&t.data.constructor!==Number&&t.data.constructor!==Boolean&&t.data.constructor!==Array&&t.data.constructor!==Object)&&(t.data=null)},e.registerNodeType("basic/data_store",p)}(this),function(t){var e=t.LiteGraph;function i(){this.addOutput("",e.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}function s(){this.addInput("","boolean"),this.addInput("e",e.ACTION),this.addOutput("v","boolean"),this.addOutput("e",e.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}function o(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}function r(){this.addOutput("","string"),this.addOutput("change",e.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var t=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,(function(e){t.properties.value=e,t.triggerSlot(1,e)}),{property:"value",values:this._values})}function n(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}function a(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var t=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,(function(e){t.properties.value=e}),this.properties),this.widgets_up=!0}function u(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}function h(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}function p(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}function l(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}i.title="Button",i.desc="Triggers an event",i.font="Arial",i.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){if(t.fillStyle="black",t.fillRect(11,11,this.size[0]-20,this.size[1]-20),t.fillStyle="#AAF",t.fillRect(9,9,this.size[0]-20,this.size[1]-20),t.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",t.fillRect(10,10,this.size[0]-20,this.size[1]-20),this.properties.text||0===this.properties.text){var e=this.properties.font_size||30;t.textAlign="center",t.fillStyle=this.clicked?"black":"white",t.font=e+"px "+i.font,t.fillText(this.properties.text,.5*this.size[0],.5*this.size[1]+.3*e),t.textAlign="left"}}},i.prototype.onMouseDown=function(t,e){if(e[0]>1&&e[1]>1&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.clicked=!0,this.triggerSlot(0,this.properties.message),!0},i.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},i.prototype.onMouseUp=function(t){this.clicked=!1},e.registerNodeType("widget/button",i),s.title="Toggle",s.desc="Toggles between true or false",s.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=.5*this.size[1],i=.8*this.size[1];t.font=this.properties.font||(.8*e).toFixed(0)+"px Arial";var s=t.measureText(this.title).width,o=.5*(this.size[0]-(s+e));t.fillStyle="#AAA",t.fillRect(o,i-e,e,e),t.fillStyle=this.properties.value?"#AEF":"#000",t.fillRect(o+.25*e,i-e+.25*e,.5*e,.5*e),t.textAlign="left",t.fillStyle="#AAA",t.fillText(this.title,1.2*e+o,.85*i),t.textAlign="left"}},s.prototype.onAction=function(t){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},s.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t),this.setOutputData(0,this.properties.value)},s.prototype.onMouseDown=function(t,e){if(e[0]>1&&e[1]>1&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},e.registerNodeType("widget/toggle",s),o.title="Number",o.desc="Widget to select number value",o.pixels_threshold=10,o.markers_color="#666",o.prototype.onDrawForeground=function(t){var e=.5*this.size[0],i=this.size[1];i>30?(t.fillStyle=o.markers_color,t.beginPath(),t.moveTo(e,.1*i),t.lineTo(e+.1*i,.2*i),t.lineTo(e+-.1*i,.2*i),t.fill(),t.beginPath(),t.moveTo(e,.9*i),t.lineTo(e+.1*i,.8*i),t.lineTo(e+-.1*i,.8*i),t.fill(),t.font=(.7*i).toFixed(1)+"px Arial"):t.font=(.8*i).toFixed(1)+"px Arial",t.textAlign="center",t.font=(.7*i).toFixed(1)+"px Arial",t.fillStyle="#EEE",t.fillText(this.properties.value.toFixed(this._precision),e,.75*i)},o.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},o.prototype.onPropertyChanged=function(t,e){var i=(this.properties.step+"").split(".");this._precision=i.length>1?i[1].length:0},o.prototype.onMouseDown=function(t,e){if(!(e[1]<0))return this.old_y=t.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},o.prototype.onMouseMove=function(t){if(this.mouse_captured){var e=this.old_y-t.canvasY;t.shiftKey&&(e*=10),(t.metaKey||t.altKey)&&(e*=.1),this.old_y=t.canvasY;var i=this._remainder+e/o.pixels_threshold;this._remainder=i%1,i|=0;var s=Math.clamp(this.properties.value+i*this.properties.step,this.properties.min,this.properties.max);this.properties.value=s,this.graph._version++,this.setDirtyCanvas(!0)}},o.prototype.onMouseUp=function(t,e){if(t.click_time<200){var i=e[1]>.5*this.size[1]?-1:1;this.properties.value=Math.clamp(this.properties.value+i*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},e.registerNodeType("widget/number",o),r.title="Combo",r.desc="Widget to select from a list",r.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},r.prototype.onPropertyChanged=function(t,e){"values"==t?(this._values=e.split(";"),this.widget.options.values=this._values):"value"==t&&(this.widget.value=e)},e.registerNodeType("widget/combo",r),n.title="Knob",n.desc="Circular controller",n.size=[80,100],n.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var e=.5*this.size[0],i=.5*this.size[1],s=.5*Math.min(this.size[0],this.size[1])-5;Math.floor(.05*s),t.globalAlpha=1,t.save(),t.translate(e,i),t.rotate(.75*Math.PI),t.fillStyle="rgba(0,0,0,0.5)",t.beginPath(),t.moveTo(0,0),t.arc(0,0,s,0,1.5*Math.PI),t.fill(),t.strokeStyle="black",t.fillStyle=this.properties.color,t.lineWidth=2,t.beginPath(),t.moveTo(0,0),t.arc(0,0,s-4,0,1.5*Math.PI*Math.max(.01,this.value)),t.closePath(),t.fill(),t.lineWidth=1,t.globalAlpha=1,t.restore(),t.fillStyle="black",t.beginPath(),t.arc(e,i,.75*s,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":this.properties.color,t.beginPath();var o=this.value*Math.PI*1.5+.75*Math.PI;t.arc(e+Math.cos(o)*s*.65,i+Math.sin(o)*s*.65,.05*s,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":"#AAA",t.font=Math.floor(.5*s)+"px Arial",t.textAlign="center",t.fillText(this.properties.value.toFixed(this.properties.precision),e,i+.15*s)}},n.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=e.colorToString([this.value,this.value,this.value])},n.prototype.onMouseDown=function(t){return this.center=[.5*this.size[0],.5*this.size[1]+20],this.radius=.5*this.size[0],!(t.canvasY-this.pos[1]<20||e.distance([t.canvasX,t.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius||(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),0))},n.prototype.onMouseMove=function(t){if(this.oldmouse){var e=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],i=this.value;(i-=.01*(e[1]-this.oldmouse[1]))>1?i=1:i<0&&(i=0),this.value=i,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=e,this.setDirtyCanvas(!0)}},n.prototype.onMouseUp=function(t){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},n.prototype.onPropertyChanged=function(t,e){if("min"==t||"max"==t||"value"==t)return this.properties[t]=parseFloat(e),!0},e.registerNodeType("widget/knob",n),a.title="Inner Slider",a.prototype.onPropertyChanged=function(t,e){"value"==t&&(this.slider.value=e)},a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},e.registerNodeType("widget/internal_slider",a),u.title="H.Slider",u.desc="Linear slider controller",u.prototype.onDrawForeground=function(t){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),t.globalAlpha=1,t.lineWidth=1,t.fillStyle="#000",t.fillRect(2,2,this.size[0]-4,this.size[1]-4),t.fillStyle=this.properties.color,t.beginPath(),t.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),t.fill()},u.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=e.colorToString([this.value,this.value,this.value])},u.prototype.onMouseDown=function(t){return!(t.canvasY-this.pos[1]<0||(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),0))},u.prototype.onMouseMove=function(t){if(this.oldmouse){var e=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],i=this.value;(i+=(e[0]-this.oldmouse[0])/this.size[0])>1?i=1:i<0&&(i=0),this.value=i,this.oldmouse=e,this.setDirtyCanvas(!0)}},u.prototype.onMouseUp=function(t){this.oldmouse=null,this.captureInput(!1)},u.prototype.onMouseLeave=function(t){},e.registerNodeType("widget/hslider",u),h.title="Progress",h.desc="Shows data in linear progress",h.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t)},h.prototype.onDrawForeground=function(t){t.lineWidth=1,t.fillStyle=this.properties.color;var e=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);e=Math.min(1,e),e=Math.max(0,e),t.fillRect(2,2,(this.size[0]-4)*e,this.size[1]-4)},e.registerNodeType("widget/progress",h),p.title="Text",p.desc="Shows the input value",p.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],p.prototype.onDrawForeground=function(t){t.fillStyle=this.properties.color;var e=this.properties.value;this.properties.glowSize?(t.shadowColor=this.properties.color,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.glowSize):t.shadowColor="transparent";var i=this.properties.fontsize;if(t.textAlign=this.properties.align,t.font=i.toString()+"px "+this.properties.font,this.str="number"==typeof e?e.toFixed(this.properties.decimals):e,"string"==typeof this.str)for(var s=this.str.split("\\n"),o=0;o<s.length;o++)t.fillText(s[o],"left"==this.properties.align?15:this.size[0]-15,-.15*i+i*(parseInt(o)+1));t.shadowColor="transparent",this.last_ctx=t,t.textAlign="left"},p.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t)},p.prototype.resize=function(){if(this.last_ctx){var t=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var e=0,i=0;i<t.length;i++){var s=this.last_ctx.measureText(t[i]).width;e<s&&(e=s)}this.size[0]=e+20,this.size[1]=4+t.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},p.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,this.str="number"==typeof e?e.toFixed(3):e,!0},e.registerNodeType("widget/text",p),l.title="Panel",l.desc="Non interactive panel",l.widgets=[{name:"update",text:"Update",type:"button"}],l.prototype.createGradient=function(t){""!=this.properties.bgcolorTop&&""!=this.properties.bgcolorBottom?(this.lineargradient=t.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)):this.lineargradient=0},l.prototype.onDrawForeground=function(t){this.flags.collapsed||(null==this.lineargradient&&this.createGradient(t),this.lineargradient&&(t.lineWidth=1,t.strokeStyle=this.properties.borderColor,t.fillStyle=this.lineargradient,this.properties.shadowSize?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.shadowSize):t.shadowColor="transparent",t.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),t.fill(),t.shadowColor="transparent",t.stroke()))},e.registerNodeType("widget/panel",l)}(this),function(t){var e=t.LiteGraph;function i(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",e.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}i.title="Gamepad",i.desc="gets the input of the gamepad",i.CENTER=0,i.LEFT=1,i.RIGHT=2,i.UP=4,i.DOWN=8,i.zero=new Float32Array(2),i.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],i.prototype.onExecute=function(){var t=this.getGamepad(),e=this.properties.threshold||0;if(t&&(this._left_axis[0]=Math.abs(t.xbox.axes.lx)>e?t.xbox.axes.lx:0,this._left_axis[1]=Math.abs(t.xbox.axes.ly)>e?t.xbox.axes.ly:0,this._right_axis[0]=Math.abs(t.xbox.axes.rx)>e?t.xbox.axes.rx:0,this._right_axis[1]=Math.abs(t.xbox.axes.ry)>e?t.xbox.axes.ry:0,this._triggers[0]=Math.abs(t.xbox.axes.ltrigger)>e?t.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(t.xbox.axes.rtrigger)>e?t.xbox.axes.rtrigger:0),this.outputs)for(var s=0;s<this.outputs.length;s++){var o=this.outputs[s];if(o.links&&o.links.length){var r=null;if(t)switch(o.name){case"left_axis":r=this._left_axis;break;case"right_axis":r=this._right_axis;break;case"left_x_axis":r=this._left_axis[0];break;case"left_y_axis":r=this._left_axis[1];break;case"right_x_axis":r=this._right_axis[0];break;case"right_y_axis":r=this._right_axis[1];break;case"trigger_left":r=this._triggers[0];break;case"trigger_right":r=this._triggers[1];break;case"a_button":r=t.xbox.buttons.a?1:0;break;case"b_button":r=t.xbox.buttons.b?1:0;break;case"x_button":r=t.xbox.buttons.x?1:0;break;case"y_button":r=t.xbox.buttons.y?1:0;break;case"lb_button":r=t.xbox.buttons.lb?1:0;break;case"rb_button":r=t.xbox.buttons.rb?1:0;break;case"ls_button":r=t.xbox.buttons.ls?1:0;break;case"rs_button":r=t.xbox.buttons.rs?1:0;break;case"hat_left":r=t.xbox.hatmap&i.LEFT;break;case"hat_right":r=t.xbox.hatmap&i.RIGHT;break;case"hat_up":r=t.xbox.hatmap&i.UP;break;case"hat_down":r=t.xbox.hatmap&i.DOWN;break;case"hat":r=t.xbox.hatmap;break;case"start_button":r=t.xbox.buttons.start?1:0;break;case"back_button":r=t.xbox.buttons.back?1:0;break;case"button_pressed":for(var n=0;n<this._current_buttons.length;++n)this._current_buttons[n]&&!this._previous_buttons[n]&&this.triggerSlot(s,i.buttons[n])}else switch(o.name){case"button_pressed":break;case"left_axis":case"right_axis":r=i.zero;break;default:r=0}this.setOutputData(s,r)}}},i.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},i.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],i.prototype.getGamepad=function(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!t)return null;var e=t.call(navigator),s=null;this._previous_buttons.set(this._current_buttons);for(var o=this.properties.gamepad_index;o<4;o++)if(e[o]){s=e[o];var r=this.xbox_mapping;r||(r=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:i.CENTER}),r.axes.lx=s.axes[0],r.axes.ly=s.axes[1],r.axes.rx=s.axes[2],r.axes.ry=s.axes[3],r.axes.ltrigger=s.buttons[6].value,r.axes.rtrigger=s.buttons[7].value,r.hat="",r.hatmap=i.CENTER;for(var n=0;n<s.buttons.length;n++)if(this._current_buttons[n]=s.buttons[n].pressed,n<12)r.buttons[i.mapping_array[n]]=s.buttons[n].pressed,s.buttons[n].was_pressed&&this.trigger(i.mapping_array[n]+"_button_event");else switch(n){case 12:s.buttons[n].pressed&&(r.hat+="up",r.hatmap|=i.UP);break;case 13:s.buttons[n].pressed&&(r.hat+="down",r.hatmap|=i.DOWN);break;case 14:s.buttons[n].pressed&&(r.hat+="left",r.hatmap|=i.LEFT);break;case 15:s.buttons[n].pressed&&(r.hat+="right",r.hatmap|=i.RIGHT);break;case 16:r.buttons.home=s.buttons[n].pressed}return s.xbox=r,s}},i.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this._left_axis,i=this._right_axis;t.strokeStyle="#88A",t.strokeRect(.5*(e[0]+1)*this.size[0]-4,.5*(e[1]+1)*this.size[1]-4,8,8),t.strokeStyle="#8A8",t.strokeRect(.5*(i[0]+1)*this.size[0]-4,.5*(i[1]+1)*this.size[1]-4,8,8);var s=this.size[1]/this._current_buttons.length;t.fillStyle="#AEB";for(var o=0;o<this._current_buttons.length;++o)this._current_buttons[o]&&t.fillRect(0,s*o,6,s)}},i.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",e.EVENT],["b_button_event",e.EVENT],["x_button_event",e.EVENT],["y_button_event",e.EVENT],["lb_button_event",e.EVENT],["rb_button_event",e.EVENT],["ls_button_event",e.EVENT],["rs_button_event",e.EVENT],["start_button_event",e.EVENT],["back_button_event",e.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",e.EVENT]]},e.registerNodeType("input/gamepad",i)}(this),function(t){var e=t.LiteGraph;function i(){this.addInput("in","*"),this.size=[80,30]}function s(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}function o(){this.addInput("in"),this.addOutput("out")}function r(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}function n(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}function a(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}function u(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}function h(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}function p(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}function l(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function d(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function _(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}function g(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}function f(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}function v(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}function m(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}function y(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:y.values}),this._func=function(t,e){return t+e},this._result=[]}function x(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}function b(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:b.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:b.values}),this.size=[80,60]}function T(){this.addInput("in",""),this.addInput("cond","boolean"),this.addOutput("true",""),this.addOutput("false",""),this.size=[80,60]}function E(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}function w(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}function I(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,(function(t,e,i){i.properties.formula=t})),this.addWidget("toggle","allow",e.allow_scripts,(function(t){e.allow_scripts=t})),this._func=null}function O(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}function D(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}function N(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}function S(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}function C(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}function A(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}i.title="Converter",i.desc="type A to type B",i.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t&&this.outputs)for(var e=0;e<this.outputs.length;e++){var i=this.outputs[e];if(i.links&&i.links.length){var s=null;switch(i.name){case"number":s=t.length?t[0]:parseFloat(t);break;case"vec2":case"vec3":case"vec4":s=null;var o=1;switch(i.name){case"vec2":o=2;break;case"vec3":o=3;break;case"vec4":o=4}if(s=new Float32Array(o),t.length)for(var r=0;r<t.length&&r<s.length;r++)s[r]=t[r];else s[0]=parseFloat(t)}this.setOutputData(e,s)}}},i.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},e.registerNodeType("math/converter",i),s.title="Bypass",s.desc="removes the type",s.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,t)},e.registerNodeType("math/bypass",s),o.title="to Number",o.desc="Cast to number",o.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,Number(t))},e.registerNodeType("math/to_number",o),r.title="Range",r.desc="Convert a number from one range to another",r.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},r.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t];void 0!==(i=this.getInputData(t))&&(this.properties[e.name]=i)}var i;null!=(i=this.properties.in)&&i.constructor===Number||(i=0);var s=this.properties.in_min,o=this.properties.in_max,r=this.properties.out_min,n=this.properties.out_max;this._last_v=(i-s)/(o-s)*(n-r)+r,this.setOutputData(0,this._last_v),this.setOutputData(1,Math.clamp(this._last_v,r,n))},r.prototype.onDrawBackground=function(t){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},r.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},e.registerNodeType("math/range",r),n.title="Rand",n.desc="Random number",n.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);void 0!==i&&(this.properties[e.name]=i)}var s=this.properties.min,o=this.properties.max;this._last_v=Math.random()*(o-s)+s,this.setOutputData(0,this._last_v)},n.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},n.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},e.registerNodeType("math/rand",n),a.title="Noise",a.desc="Random number with temporal continuity",a.data=null,a.getValue=function(t,e){if(!a.data){a.data=new Float32Array(1024);for(var i=0;i<a.data.length;++i)a.data[i]=Math.random()}(t%=1024)<0&&(t+=1024);var s=Math.floor(t);return t-=s,e&&(t=t*t*t*(t*(6*t-15)+10)),a.data[s]*(1-t)+a.data[1023==s?0:s+1]*t},a.prototype.onExecute=function(){var t=this.getInputData(0)||0,e=this.properties.octaves||1,i=0,s=1;t+=this.properties.seed||0;for(var o=this.properties.speed||1,r=0,n=0;n<e&&(i+=a.getValue(t*(1+n)*o,this.properties.smooth)*s,r+=s,!((s*=this.properties.persistence)<.001));++n);i/=r;var u=this.properties.min,h=this.properties.max;this._last_v=i*(h-u)+u,this.setOutputData(0,this._last_v)},a.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},e.registerNodeType("math/noise",a),u.title="Spikes",u.desc="spike every random time",u.prototype.onExecute=function(){var t=this.graph.elapsed_time;this._remaining_time-=t,this._blink_time-=t;var e=0;if(this._blink_time>0){var i=this._blink_time/this.properties.duration;e=1/(Math.pow(8*i-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,e)},e.registerNodeType("math/spikes",u),h.title="Clamp",h.desc="Clamp number between min and max",h.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.max(this.properties.min,t),t=Math.min(this.properties.max,t),this.setOutputData(0,t))},h.prototype.getCode=function(t){var e="";return this.isInputConnected(0)&&(e+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),e},e.registerNodeType("math/clamp",h),p.title="Lerp",p.desc="Linear Interpolation",p.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.getInputData(1);null==e&&(e=0);var i=this.properties.f,s=this.getInputData(2);void 0!==s&&(i=s),this.setOutputData(0,t*(1-i)+e*i)},p.prototype.onGetInputs=function(){return[["f","number"]]},e.registerNodeType("math/lerp",p),l.title="Abs",l.desc="Absolute",l.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.abs(t))},e.registerNodeType("math/abs",l),d.title="Floor",d.desc="Floor number to remove fractional part",d.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.floor(t))},e.registerNodeType("math/floor",d),c.title="Frac",c.desc="Returns fractional part",c.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t%1)},e.registerNodeType("math/frac",c),_.title="Smoothstep",_.desc="Smoothstep",_.prototype.onExecute=function(){var t=this.getInputData(0);if(void 0!==t){var e=this.properties.A,i=this.properties.B;t=(t=Math.clamp((t-e)/(i-e),0,1))*t*(3-2*t),this.setOutputData(0,t)}},e.registerNodeType("math/smoothstep",_),g.title="Scale",g.desc="v * factor",g.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t*this.properties.factor)},e.registerNodeType("math/scale",g),f.title="Gate",f.desc="if v is true, then outputs A, otherwise B",f.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,this.getInputData(t?1:2))},e.registerNodeType("math/gate",f),v.title="Average",v.desc="Average Filter",v.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this._values.length;this._values[this._current%e]=t,this._current+=1,this._current>e&&(this._current=0);for(var i=0,s=0;s<e;++s)i+=this._values[s];this.setOutputData(0,i/e)},v.prototype.onPropertyChanged=function(t,e){e<1&&(e=1),this.properties.samples=Math.round(e);var i=this._values;this._values=new Float32Array(this.properties.samples),i.length<=this._values.length?this._values.set(i):this._values.set(i.subarray(0,this._values.length))},e.registerNodeType("math/average",v),m.title="TendTo",m.desc="moves the output value always closer to the input",m.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.properties.factor;null==this._value?this._value=t:this._value=this._value*(1-e)+t*e,this.setOutputData(0,this._value)},e.registerNodeType("math/tendTo",m),y.values=["+","-","*","/","%","^","max","min"],y.title="Operation",y.desc="Easy math operators",y["@OP"]={type:"enum",title:"operation",values:y.values},y.size=[100,60],y.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},y.prototype.setValue=function(t){"string"==typeof t&&(t=parseFloat(t)),this.properties.value=t},y.prototype.onPropertyChanged=function(t,e){if("OP"==t)switch(this.properties.OP){case"+":this._func=function(t,e){return t+e};break;case"-":this._func=function(t,e){return t-e};break;case"x":case"X":case"*":this._func=function(t,e){return t*e};break;case"/":this._func=function(t,e){return t/e};break;case"%":this._func=function(t,e){return t%e};break;case"^":this._func=function(t,e){return Math.pow(t,e)};break;case"max":this._func=function(t,e){return Math.max(t,e)};break;case"min":this._func=function(t,e){return Math.min(t,e)};break;default:console.warn("Unknown operation: "+this.properties.OP),this._func=function(t){return t}}},y.prototype.onExecute=function(){var t,e=this.getInputData(0),i=this.getInputData(1);if(null!=e?e.constructor===Number&&(this.properties.A=e):e=this.properties.A,null!=i?this.properties.B=i:i=this.properties.B,e.constructor===Number)t=0,t=this._func(e,i);else if(e.constructor===Array){(t=this._result).length=e.length;for(var s=0;s<e.length;++s)t[s]=this._func(e[s],i)}else for(var s in t={},e)t[s]=this._func(e[s],i);this.setOutputData(0,t)},y.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+e.NODE_TITLE_HEIGHT)),t.textAlign="left")},e.registerNodeType("math/operation",y),e.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),e.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"}),x.title="Compare",x.desc="compares between two values",x.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);void 0!==t?this.properties.A=t:t=this.properties.A,void 0!==e?this.properties.B=e:e=this.properties.B;for(var i=0,s=this.outputs.length;i<s;++i){var o=this.outputs[i];if(o.links&&o.links.length){var r;switch(o.name){case"A==B":r=t==e;break;case"A!=B":r=t!=e;break;case"A>B":r=t>e;break;case"A<B":r=t<e;break;case"A<=B":r=t<=e;break;case"A>=B":r=t>=e}this.setOutputData(i,r)}}},x.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},e.registerNodeType("math/compare",x),e.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),e.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),e.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),e.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),e.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),e.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"}),b.values=[">","<","==","!=","<=",">=","||","&&"],b["@OP"]={type:"enum",title:"operation",values:b.values},b.title="Condition",b.desc="evaluates condition between A and B",b.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},b.prototype.onExecute=function(){var t=this.getInputData(0);void 0===t?t=this.properties.A:this.properties.A=t;var e=this.getInputData(1);void 0===e?e=this.properties.B:this.properties.B=e;var i=!0;switch(this.properties.OP){case">":i=t>e;break;case"<":i=t<e;break;case"==":i=t==e;break;case"!=":i=t!=e;break;case"<=":i=t<=e;break;case">=":i=t>=e;break;case"||":i=t||e;break;case"&&":i=t&&e}this.setOutputData(0,i),this.setOutputData(1,!i)},e.registerNodeType("math/condition",b),T.title="Branch",T.desc="If condition is true, outputs IN in true, otherwise in false",T.prototype.onExecute=function(){var t=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,t),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,t))},e.registerNodeType("math/branch",T),E.title="Accumulate",E.desc="Increments a value every time",E.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var t=this.getInputData(0);this.properties.value+=null!==t?t:this.properties.increment,this.setOutputData(0,this.properties.value)},e.registerNodeType("math/accumulate",E),w.title="Trigonometry",w.desc="Sin Cos Tan",w.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=0);var e=this.properties.amplitude,i=this.findInputSlot("amplitude");-1!=i&&(e=this.getInputData(i));var s=this.properties.offset;-1!=(i=this.findInputSlot("offset"))&&(s=this.getInputData(i));for(var o=0,r=this.outputs.length;o<r;++o){var n;switch(this.outputs[o].name){case"sin":n=Math.sin(t);break;case"cos":n=Math.cos(t);break;case"tan":n=Math.tan(t);break;case"asin":n=Math.asin(t);break;case"acos":n=Math.acos(t);break;case"atan":n=Math.atan(t)}this.setOutputData(o,e*n+s)}},w.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},w.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},e.registerNodeType("math/trigonometry",w),e.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),e.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),e.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"}),I.title="Formula",I.desc="Compute formula",I.size=[160,100],v.prototype.onPropertyChanged=function(t,e){"formula"==t&&(this.code_widget.value=e)},I.prototype.onExecute=function(){if(e.allow_scripts){var t,i=this.getInputData(0),s=this.getInputData(1);null!=i?this.properties.x=i:i=this.properties.x,null!=s?this.properties.y=s:s=this.properties.y,this.properties.formula;try{this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),t=this._func(i,s,this.graph.globaltime),this.boxcolor=null}catch(t){this.boxcolor="red"}this.setOutputData(0,t)}},I.prototype.getTitle=function(){return this._func_code||"Formula"},I.prototype.onDrawBackground=function(){var t=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=t)},e.registerNodeType("math/formula",I),O.title="Vec2->XY",O.desc="vector 2 to components",O.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]))},e.registerNodeType("math3d/vec2-to-xy",O),D.title="XY->Vec2",D.desc="components to vector2",D.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var i=this._data;i[0]=t,i[1]=e,this.setOutputData(0,i)},e.registerNodeType("math3d/xy-to-vec2",D),N.title="Vec3->XYZ",N.desc="vector 3 to components",N.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]))},e.registerNodeType("math3d/vec3-to-xyz",N),S.title="XYZ->Vec3",S.desc="components to vector3",S.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var i=this.getInputData(2);null==i&&(i=this.properties.z);var s=this._data;s[0]=t,s[1]=e,s[2]=i,this.setOutputData(0,s)},e.registerNodeType("math3d/xyz-to-vec3",S),C.title="Vec4->XYZW",C.desc="vector 4 to components",C.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]),this.setOutputData(3,t[3]))},e.registerNodeType("math3d/vec4-to-xyzw",C),A.title="XYZW->Vec4",A.desc="components to vector4",A.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.x);var e=this.getInputData(1);null==e&&(e=this.properties.y);var i=this.getInputData(2);null==i&&(i=this.properties.z);var s=this.getInputData(3);null==s&&(s=this.properties.w);var o=this._data;o[0]=t,o[1]=e,o[2]=i,o[3]=s,this.setOutputData(0,o)},e.registerNodeType("math3d/xyzw-to-vec4",A)}(this),function(t){var e=t.LiteGraph;function i(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}function s(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:s.values}),this._result=vec3.create()}function o(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}function r(){this.addInput("in","vec3"),this.addOutput("out","number")}function n(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}function a(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}function u(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}if(i.title="mat4",i.temp_quat=new Float32Array([0,0,0,1]),i.temp_mat4=new Float32Array(16),i.temp_vec3=new Float32Array(3),i.prototype.onPropertyChanged=function(t,e){this._must_update=!0},i.prototype.onExecute=function(){var t=this._result,e=i.temp_quat,s=i.temp_mat4,o=i.temp_vec3,r=this.getInputData(0),n=this.getInputData(1),a=this.getInputData(2);(this._must_update||r||n||a)&&(r=r||this.properties.T,n=n||this.properties.R,a=a||this.properties.S,mat4.identity(t),mat4.translate(t,t,r),this.properties.R_in_degrees?(o.set(n),vec3.scale(o,o,DEG2RAD),quat.fromEuler(e,o)):quat.fromEuler(e,n),mat4.fromQuat(s,e),mat4.multiply(t,t,s),mat4.scale(t,t,a)),this.setOutputData(0,t)},e.registerNodeType("math3d/mat4",i),s.values=["+","-","*","/","%","^","max","min","dot","cross"],e.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),e.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),s.title="Operation",s.desc="Easy math 3D operators",s["@OP"]={type:"enum",title:"operation",values:s.values},s.size=[100,60],s.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},s.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);if(null!=t&&null!=e){t.constructor===Number&&(t=[t,t,t]),e.constructor===Number&&(e=[e,e,e]);var i=this._result;switch(this.properties.OP){case"+":i=vec3.add(i,t,e);break;case"-":i=vec3.sub(i,t,e);break;case"x":case"X":case"*":i=vec3.mul(i,t,e);break;case"/":i=vec3.div(i,t,e);break;case"%":i[0]=t[0]%e[0],i[1]=t[1]%e[1],i[2]=t[2]%e[2];break;case"^":i[0]=Math.pow(t[0],e[0]),i[1]=Math.pow(t[1],e[1]),i[2]=Math.pow(t[2],e[2]);break;case"max":i[0]=Math.max(t[0],e[0]),i[1]=Math.max(t[1],e[1]),i[2]=Math.max(t[2],e[2]);break;case"min":i[0]=Math.min(t[0],e[0]),i[1]=Math.min(t[1],e[1]),i[2]=Math.min(t[2],e[2]);case"dot":i=vec3.dot(t,e);break;case"cross":vec3.cross(i,t,e);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,i)}},s.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+e.NODE_TITLE_HEIGHT)),t.textAlign="left")},e.registerNodeType("math3d/operation",s),o.title="vec3_scale",o.desc="scales the components of a vec3",o.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);null==e&&(e=this.properties.f);var i=this._data;i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,this.setOutputData(0,i)}},e.registerNodeType("math3d/vec3-scale",o),r.title="vec3_length",r.desc="returns the module of a vector",r.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.setOutputData(0,e)}},e.registerNodeType("math3d/vec3-length",r),n.title="vec3_normalize",n.desc="returns the vector normalized",n.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=this._data;i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,this.setOutputData(0,i)}},e.registerNodeType("math3d/vec3-normalize",n),a.title="vec3_lerp",a.desc="returns the interpolated vector",a.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var i=this.getInputOrProperty("f"),s=this._data;s[0]=t[0]*(1-i)+e[0]*i,s[1]=t[1]*(1-i)+e[1]*i,s[2]=t[2]*(1-i)+e[2]*i,this.setOutputData(0,s)}}},e.registerNodeType("math3d/vec3-lerp",a),u.title="vec3_dot",u.desc="returns the dot product",u.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var i=t[0]*e[0]+t[1]*e[1]+t[2]*e[2];this.setOutputData(0,i)}}},e.registerNodeType("math3d/vec3-dot",u),t.glMatrix){function h(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()}function p(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}function l(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()}function d(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()}function c(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}function _(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}function g(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}function f(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()}h.title="Quaternion",h.desc="quaternion",h.prototype.onExecute=function(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)},h.prototype.onGetInputs=function(){return[["x","number"],["y","number"],["z","number"],["w","number"]]},e.registerNodeType("math3d/quaternion",h),p.title="Rotation",p.desc="quaternion rotation",p.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.angle);var e=this.getInputData(1);null==e&&(e=this.properties.axis);var i=quat.setAxisAngle(this._value,e,.0174532925*t);this.setOutputData(0,i)},e.registerNodeType("math3d/rotation",p),l.title="Euler->Quat",l.desc="Converts euler angles (in degrees) to quaternion",l.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.euler),vec3.scale(this._degs,t,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var e=quat.fromEuler(this._value,this._degs);this.setOutputData(0,e)},e.registerNodeType("math3d/euler_to_quat",l),d.title="Euler->Quat",d.desc="Converts rotX,rotY,rotZ in degrees to quat",d.prototype.onExecute=function(){var t=this.getInputData(0);t&&(quat.toEuler(this._value,t),vec3.scale(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value))},e.registerNodeType("math3d/quat_to_euler",d),c.title="Rot. Vec3",c.desc="rotate a point",c.prototype.onExecute=function(){var t=this.getInputData(0);null==t&&(t=this.properties.vec);var e=this.getInputData(1);null==e?this.setOutputData(t):this.setOutputData(0,vec3.transformQuat(vec3.create(),t,e))},e.registerNodeType("math3d/rotate_vec3",c),_.title="Mult. Quat",_.desc="rotate quaternion",_.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var i=quat.multiply(this._value,t,e);this.setOutputData(0,i)}}},e.registerNodeType("math3d/mult-quat",_),g.title="Quat Slerp",g.desc="quaternion spherical interpolation",g.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t){var e=this.getInputData(1);if(null!=e){var i=this.properties.factor;null!=this.getInputData(2)&&(i=this.getInputData(2));var s=quat.slerp(this._value,t,e,i);this.setOutputData(0,s)}}},e.registerNodeType("math3d/quat-slerp",g),f.title="Remap Range",f.desc="remap a 3D range",f.prototype.onExecute=function(){var t=this.getInputData(0);t&&this._value.set(t);for(var e=this.properties.range_min,i=this.properties.range_max,s=this.properties.target_min,o=this.properties.target_max,r=0;r<3;++r){var n=i[r]-e[r];if(this._clamped[r]=Math.clamp(this._value[r],e[r],i[r]),0!=n){var a=(this._value[r]-e[r])/n;this.properties.clamp&&(a=Math.clamp(a,0,1));var u=o[r]-s[r];this._value[r]=s[r]+a*u}else this._value[r]=.5*(s[r]+o[r])}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)},e.registerNodeType("math3d/remap_range",f)}else console.warn("No glmatrix found, some Math3D nodes may not work")}(this),function(t){var e=t.LiteGraph;function i(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}e.wrapFunctionAsNode("string/toString",(function(t){if(t&&t.constructor===Object)try{return JSON.stringify(t)}catch(e){return String(t)}return String(t)}),[""],"String"),e.wrapFunctionAsNode("string/compare",(function(t,e){return t==e}),["string","string"],"boolean"),e.wrapFunctionAsNode("string/concatenate",(function(t,e){return void 0===t?e:void 0===e?t:t+e}),["string","string"],"string"),e.wrapFunctionAsNode("string/contains",(function(t,e){return void 0!==t&&void 0!==e&&-1!=t.indexOf(e)}),["string","string"],"boolean"),e.wrapFunctionAsNode("string/toUpperCase",(function(t){return null!=t&&t.constructor===String?t.toUpperCase():t}),["string"],"string"),e.wrapFunctionAsNode("string/split",(function(t,e){if(null==e&&(e=this.properties.separator),null==t)return[];if(t.constructor===String)return t.split(e||" ");if(t.constructor===Array){for(var i=[],s=0;s<t.length;++s)i[s]=t[s].split(e||" ");return i}return null}),["string,array","string"],"array",{separator:","}),e.wrapFunctionAsNode("string/toFixed",(function(t){return null!=t&&t.constructor===Number?t.toFixed(this.properties.precision):t}),["number"],"string",{precision:0}),i.title="toTable",i.desc="Splits a string to table",i.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.properties.separator||",";t==this._str&&e==this._last_separator||(this._last_separator=e,this._str=t,this._table=t.split("\n").map((function(t){return t.trim().split(e)}))),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}},e.registerNodeType("string/toTable",i)}(this),function(t){var e=t.LiteGraph;function i(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}function s(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}i.title="Selector",i.desc="selects an output",i.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){t.fillStyle="#AFB";var i=(this.selected+1)*e.NODE_SLOT_HEIGHT+6;t.beginPath(),t.moveTo(50,i),t.lineTo(50,i+e.NODE_SLOT_HEIGHT),t.lineTo(34,i+.5*e.NODE_SLOT_HEIGHT),t.fill()}},i.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&t.constructor===Number||(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1);var e=this.getInputData(t+1);void 0!==e&&this.setOutputData(0,e)},i.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},e.registerNodeType("logic/selector",i),s.title="Sequence",s.desc="select one element from a sequence from a string",s.prototype.onPropertyChanged=function(t,e){"sequence"==t&&(this.values=e.split(","))},s.prototype.onExecute=function(){var t=this.getInputData(1);t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t);var e=this.getInputData(0);null==e&&(e=0),this.index=e=Math.round(e)%this.values.length,this.setOutputData(0,this.values[e])},e.registerNodeType("logic/sequence",s)}(this),function(t){var e=t.LiteGraph;function i(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}function s(){this.addOutput("frame","image"),this.properties={url:""}}function o(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}function r(){this.addInput("","image,canvas"),this.size=[200,200]}function n(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}function a(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}function u(){this.addInput("clear",e.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}function h(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}function p(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}function l(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}function d(){this.addOutput("Webcam","image"),this.properties={facingMode:"user"},this.boxcolor="black",this.frame=0}i.title="Plot",i.desc="Plots data over time",i.colors=["#FFF","#F99","#9F9","#99F"],i.prototype.onExecute=function(t){if(!this.flags.collapsed)for(var e=this.size,i=0;i<4;++i){var s=this.getInputData(i);if(null!=s){var o=this.values[i];o.push(s),o.length>e[0]&&o.shift()}}},i.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this.size,s=.5*e[1]/this.properties.scale,o=i.colors,r=.5*e[1];if(t.fillStyle="#000",t.fillRect(0,0,e[0],e[1]),t.strokeStyle="#555",t.beginPath(),t.moveTo(0,r),t.lineTo(e[0],r),t.stroke(),this.inputs)for(var n=0;n<4;++n){var a=this.values[n];if(this.inputs[n]&&this.inputs[n].link){t.strokeStyle=o[n],t.beginPath();var u=a[0]*s*-1+r;t.moveTo(0,Math.clamp(u,0,e[1]));for(var h=1;h<a.length&&h<e[0];++h)u=a[h]*s*-1+r,t.lineTo(h,Math.clamp(u,0,e[1]));t.stroke()}}}},e.registerNodeType("graphics/plot",i),s.title="Image",s.desc="Image loader",s.widgets=[{name:"load",text:"Load",type:"button"}],s.supported_extensions=["jpg","jpeg","png","gif"],s.prototype.onAdded=function(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)},s.prototype.onDrawBackground=function(t){this.flags.collapsed||this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&t.drawImage(this.img,0,0,this.size[0],this.size[1])},s.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},s.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadImage(e),!0},s.prototype.loadImage=function(t,i){if(""!=t){this.img=document.createElement("img"),"http"==t.substr(0,4)&&e.proxy&&(t=e.proxy+t.substr(t.indexOf(":")+3)),this.img.src=t,this.boxcolor="#F95";var s=this;this.img.onload=function(){i&&i(this),console.log("Image loaded, size: "+s.img.width+"x"+s.img.height),this.dirty=!0,s.boxcolor="#9F9",s.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+t)}}else this.img=null},s.prototype.onWidget=function(t,e){"load"==e.name&&this.loadImage(this.properties.url)},s.prototype.onDropFile=function(t){var e=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(t),this.properties.url=this._url,this.loadImage(this._url,(function(t){e.size[1]=t.height/t.width*e.size[0]}))},e.registerNodeType("graphics/image",s),o.title="Palette",o.desc="Generates a color",o.prototype.onExecute=function(){var t=[];null!=this.properties.colorA&&t.push(hex2num(this.properties.colorA)),null!=this.properties.colorB&&t.push(hex2num(this.properties.colorB)),null!=this.properties.colorC&&t.push(hex2num(this.properties.colorC)),null!=this.properties.colorD&&t.push(hex2num(this.properties.colorD));var e=this.getInputData(0);if(null==e&&(e=.5),e>1?e=1:e<0&&(e=0),0!=t.length){var i=[0,0,0];if(0==e)i=t[0];else if(1==e)i=t[t.length-1];else{var s=(t.length-1)*e,o=t[Math.floor(s)],r=t[Math.floor(s)+1],n=s-Math.floor(s);i[0]=o[0]*(1-n)+r[0]*n,i[1]=o[1]*(1-n)+r[1]*n,i[2]=o[2]*(1-n)+r[2]*n}for(var a=0;a<i.length;a++)i[a]/=255;this.boxcolor=colorToString(i),this.setOutputData(0,i)}},e.registerNodeType("color/palette",o),r.title="Frame",r.desc="Frame viewerew",r.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],r.prototype.onDrawBackground=function(t){this.frame&&!this.flags.collapsed&&t.drawImage(this.frame,0,0,this.size[0],this.size[1])},r.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},r.prototype.onWidget=function(t,e){if("resize"==e.name&&this.frame){var i=this.frame.width,s=this.frame.height;i||null==this.frame.videoWidth||(i=this.frame.videoWidth,s=this.frame.videoHeight),i&&s&&(this.size=[i,s]),this.setDirtyCanvas(!0,!0)}else"view"==e.name&&this.show()},r.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},e.registerNodeType("graphics/frame",r),n.title="Image fade",n.desc="Fades between images",n.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],n.prototype.onAdded=function(){this.createCanvas();var t=this.canvas.getContext("2d");t.fillStyle="#000",t.fillRect(0,0,this.properties.width,this.properties.height)},n.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},n.prototype.onExecute=function(){var t=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var e=this.getInputData(0);null!=e&&t.drawImage(e,0,0,this.canvas.width,this.canvas.height);var i=this.getInputData(2);null==i?i=this.properties.fade:this.properties.fade=i,t.globalAlpha=i;var s=this.getInputData(1);null!=s&&t.drawImage(s,0,0,this.canvas.width,this.canvas.height),t.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},e.registerNodeType("graphics/imagefade",n),a.title="Crop",a.desc="Crop Image",a.prototype.onAdded=function(){this.createCanvas()},a.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},a.prototype.onExecute=function(){var t=this.getInputData(0);t&&(t.width?(this.canvas.getContext("2d").drawImage(t,-this.properties.x,-this.properties.y,t.width*this.properties.scale,t.height*this.properties.scale),this.setOutputData(0,this.canvas)):this.setOutputData(0,null))},a.prototype.onDrawBackground=function(t){this.flags.collapsed||this.canvas&&t.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},a.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"scale"==t?(this.properties[t]=parseFloat(e),0==this.properties[t]&&(console.error("Error in scale"),this.properties[t]=1)):this.properties[t]=parseInt(e),this.createCanvas(),!0},e.registerNodeType("graphics/cropImage",a),u.title="Canvas",u.desc="Canvas to render stuff",u.prototype.onExecute=function(){var t=this.canvas,e=0|this.properties.width,i=0|this.properties.height;t.width!=e&&(t.width=e),t.height!=i&&(t.height=i),this.properties.autoclear&&this.ctx.clearRect(0,0,t.width,t.height),this.setOutputData(0,t)},u.prototype.onAction=function(t,e){"clear"==t&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},e.registerNodeType("graphics/canvas",u),h.title="DrawImage",h.desc="Draws image into a canvas",h.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputOrProperty("img");if(e){var i=this.getInputOrProperty("x"),s=this.getInputOrProperty("y");t.getContext("2d").drawImage(e,i,s)}}},e.registerNodeType("graphics/drawImage",h),p.title="DrawRectangle",p.desc="Draws rectangle in canvas",p.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=this.getInputOrProperty("x"),i=this.getInputOrProperty("y"),s=this.getInputOrProperty("w"),o=this.getInputOrProperty("h");t.getContext("2d").fillRect(e,i,s,o)}},e.registerNodeType("graphics/drawRectangle",p),l.title="Video",l.desc="Video playback",l.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],l.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video&&0!=this._video.width)){var t=this.getInputData(0);t&&t>=0&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}},l.prototype.onStart=function(){this.play()},l.prototype.onStop=function(){this.stop()},l.prototype.loadVideo=function(t){this._video_url=t;var i=t.substr(0,10).indexOf(":"),s="";-1!=i&&(s=t.substr(0,i));var o="";s&&(o=(o=t.substr(0,t.indexOf("/",s.length+3))).substr(s.length+3)),this.properties.use_proxy&&s&&e.proxy&&o!=location.host&&(t=e.proxy+t.substr(t.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=t,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var r=this;this._video.addEventListener("loadedmetadata",(function(t){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),r.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight})),this._video.addEventListener("progress",(function(t){console.log("video loading...")})),this._video.addEventListener("error",(function(t){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.")}})),this._video.addEventListener("ended",(function(t){console.log("Video Ended."),this.play()}))},l.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadVideo(e),!0},l.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},l.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},l.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},l.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},l.prototype.onWidget=function(t,e){},e.registerNodeType("graphics/video",l),d.title="Webcam",d.desc="Webcam image",d.is_webcam_open=!1,d.prototype.openStream=function(){if(navigator.getUserMedia){this._waiting_confirmation=!0;var t={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch((function(t){console.log("Webcam rejected",t),e._webcam_stream=!1,d.is_webcam_open=!1,e.boxcolor="red",e.trigger("stream_error")}));var e=this}},d.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();d.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},d.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},d.prototype.onRemoved=function(){this.closeStream()},d.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,this._video=e,e.onloadedmetadata=function(t){console.log(t),d.is_webcam_open=!0}),this.trigger("stream_ready",e)},d.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var t=1;t<this.outputs.length;++t)if(this.outputs[t])switch(this.outputs[t].name){case"width":this.setOutputData(t,this._video.videoWidth);break;case"height":this.setOutputData(t,this._video.videoHeight)}}},d.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Frame":"Show Frame",callback:function(){e.properties.show=!e.properties.show}}]},d.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(t.save(),t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},d.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",e.EVENT],["stream_closed",e.EVENT],["stream_error",e.EVENT]]},e.registerNodeType("graphics/webcam",d)}(this),function(t){var e=t.LiteGraph,i=t.LGraphCanvas;function s(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[s.image_preview_size,s.image_preview_size]}function o(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[s.image_preview_size,s.image_preview_size]}function r(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}function n(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:s.DEFAULT},this.has_error=!1}function a(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:s.DEFAULT},this.properties.code=a.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}function u(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:s.DEFAULT}}function h(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:s.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}function p(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}function l(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:s.DEFAULT}}function d(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:s.DEFAULT}}function c(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:s.DEFAULT}}function _(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}function g(){this.addInput("Texture","Texture"),this.addOutput("min_t","Texture"),this.addOutput("max_t","Texture"),this.addOutput("min","vec4"),this.addOutput("max","vec4"),this.properties={mode:"max",use_previous_frame:!0},this._uniforms={u_texture:0},this._max=new Float32Array(4),this._min=new Float32Array(4),this._textures_chain=[]}function f(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}function v(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}function m(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}function y(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:s.DEFAULT,texture:null},y._shader||(y._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,y.pixel_shader))}function x(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:s.DEFAULT,generate_mipmaps:!1,texture:null},x._shader||(x._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,x.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}function b(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),b._shader||(b._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,b.pixel_shader))}function T(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:s.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}function E(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:s.DEFAULT}}function w(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},w._shader||(w._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,w.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}function I(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:s.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}function O(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:s.DEFAULT},O._shader||(O._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,O.pixel_shader))}function D(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}function N(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:s.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}function S(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:s.DEFAULT}}function C(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}function A(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:s.DEFAULT},this.fx=new C}function L(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}function k(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}function R(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}function P(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:s.LOW},this._uniforms={u_texture:0,u_factor:1}}function M(){this.addInput("in",""),this.properties={precision:s.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}function G(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:s.LOW,split_channels:!1},this._values=new Uint8Array(1024),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}function z(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:s.LOW},this._uniforms={u_texture:0,u_exposition:1}}function F(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:s.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}function B(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:s.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}function H(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:H.default_code,width:512,height:512,clear:!0,precision:s.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}function U(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:s.DEFAULT}}function V(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}t.LGraphTexture=null,"undefined"!=typeof GL&&(i.link_type_colors.Texture="#987",t.LGraphTexture=s,s.title="Texture",s.desc="Texture",s.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},s.loadTextureCallback=null,s.image_preview_size=256,s.UNDEFINED=0,s.PASS_THROUGH=1,s.COPY=2,s.LOW=3,s.HIGH=4,s.REUSE=5,s.DEFAULT=2,s.MODE_VALUES={undefined:s.UNDEFINED,"pass through":s.PASS_THROUGH,copy:s.COPY,low:s.LOW,high:s.HIGH,reuse:s.REUSE,default:s.DEFAULT},s.getTexturesContainer=function(){return gl.textures},s.loadTexture=function(t,i){i=i||{};var o=t;return"http://"==o.substr(0,7)&&e.proxy&&(o=e.proxy+o.substr(7)),s.getTexturesContainer()[t]=GL.Texture.fromURL(o,i)},s.getTexture=function(t){var e=this.getTexturesContainer();if(!e)throw"Cannot load texture, container of textures not found";var i=e[t];return!i&&t&&":"!=t[0]?this.loadTexture(t):i},s.getTargetTexture=function(t,e,i){if(!t)throw"LGraphTexture.getTargetTexture expects a reference texture";var o=null;switch(i){case s.LOW:o=gl.UNSIGNED_BYTE;break;case s.HIGH:o=gl.HIGH_PRECISION_FORMAT;break;case s.REUSE:return t;case s.COPY:default:o=t?t.type:gl.UNSIGNED_BYTE}return e&&e.width==t.width&&e.height==t.height&&e.type==o&&e.format==t.format||(e=new GL.Texture(t.width,t.height,{type:o,format:t.format,filter:gl.LINEAR})),e},s.getTextureType=function(t,e){var i=e?e.type:gl.UNSIGNED_BYTE;switch(t){case s.HIGH:i=gl.HIGH_PRECISION_FORMAT;break;case s.LOW:i=gl.UNSIGNED_BYTE}return i},s.getWhiteTexture=function(){return this._white_texture?this._white_texture:this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST})},s.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var t=new Uint8Array(1048576),e=0;e<1048576;++e)t[e]=255*Math.random();var i=GL.Texture.fromMemory(512,512,t,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=i,i},s.prototype.onDropFile=function(t,e,i){if(t){var s=null;if("string"==typeof t)s=GL.Texture.fromURL(t);else if(-1!=e.toLowerCase().indexOf(".dds"))s=GL.Texture.fromDDSInMemory(t);else{var o=new Blob([i]),r=URL.createObjectURL(o);s=GL.Texture.fromURL(r)}this._drop_texture=s,this.properties.name=e}else this._drop_texture=null,this.properties.name=""},s.prototype.getExtraMenuOptions=function(t){var e=this;if(this._drop_texture)return[{content:"Clear",callback:function(){e._drop_texture=null,e.properties.name=""}}]},s.prototype.onExecute=function(){var t=null;if(this.isOutputConnected(1)&&(t=this.getInputData(0)),!t&&this._drop_texture&&(t=this._drop_texture),!t&&this.properties.name&&(t=s.getTexture(this.properties.name)),!t)return this.setOutputData(0,null),void this.setOutputData(1,"");this._last_tex=t,!1===this.properties.filter?t.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):t.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,t),this.setOutputData(1,t.fullpath||t.filename);for(var e=2;e<this.outputs.length;e++){var i=this.outputs[e];if(i){var o=null;"width"==i.name?o=t.width:"height"==i.name?o=t.height:"aspect"==i.name&&(o=t.width/t.height),this.setOutputData(e,o)}}},s.prototype.onResourceRenamed=function(t,e){this.properties.name==t&&(this.properties.name=e)},s.prototype.onDrawBackground=function(t){if(!(this.flags.collapsed||this.size[1]<=20))if(this._drop_texture&&t.webgl)t.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);else{if(this._last_preview_tex!=this._last_tex)if(t.webgl)this._canvas=this._last_tex;else{var e=s.generateLowResTexturePreview(this._last_tex);if(!e)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(e)}this._canvas&&(t.save(),t.webgl||(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(this._canvas,0,0,this.size[0],this.size[1]),t.restore())}},s.generateLowResTexturePreview=function(t){if(!t)return null;var e=s.image_preview_size,i=t;if(t.format==gl.DEPTH_COMPONENT)return null;(t.width>e||t.height>e)&&(i=this._preview_temp_tex,this._preview_temp_tex||(i=new GL.Texture(e,e,{minFilter:gl.NEAREST}),this._preview_temp_tex=i),t.copyTo(i),t=i);var o=this._preview_canvas;return o||(o=createCanvas(e,e),this._preview_canvas=o),i&&i.toCanvas(o),o},s.prototype.getResources=function(t){return this.properties.name&&(t[this.properties.name]=GL.Texture),t},s.prototype.onGetInputs=function(){return[["in","Texture"]]},s.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},s.replaceCode=function(t,e){return t.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,(function(t){return t=t.replace(/[\{\}]/g,""),e[t]||""}))},e.registerNodeType("texture/texture",s),o.title="Preview",o.desc="Show a texture in the graph canvas",o.allow_preview=!1,o.prototype.onDrawBackground=function(t){if(!this.flags.collapsed&&(t.webgl||o.allow_preview)){var e=this.getInputData(0);if(e){var i;i=!e.handle&&t.webgl?e:s.generateLowResTexturePreview(e),t.save(),this.properties.flipY&&(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(i,0,0,this.size[0],this.size[1]),t.restore()}}},e.registerNodeType("texture/preview",o),r.title="Save",r.desc="Save a texture in the repository",r.prototype.getPreviewTexture=function(){return this._texture},r.prototype.onExecute=function(){var t=this.getInputData(0);t&&(this.properties.generate_mipmaps&&(t.bind(0),t.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(t.texture_type),t.unbind(0)),this.properties.name&&(s.storeTexture?s.storeTexture(this.properties.name,t):s.getTexturesContainer()[this.properties.name]=t),this._texture=t,this.setOutputData(0,t),this.setOutputData(1,this.properties.name))},e.registerNodeType("texture/save",r),n.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:s.MODE_VALUES}},n.title="Operation",n.desc="Texture shader operation",n.presets={},n.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Texture":"Show Texture",callback:function(){e.properties.show=!e.properties.show}}]},n.prototype.onPropertyChanged=function(){this.has_error=!1},n.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==t&&(t.save(),t.drawImage(this._tex,0,0,this.size[0],this.size[1]),t.restore())},n.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==s.PASS_THROUGH){var e=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var i=512,o=512;t?(i=t.width,o=t.height):e&&(i=e.width,o=e.height),e||(e=GL.Texture.getWhiteTexture());var r=s.getTextureType(this.properties.precision,t);t||this._tex?this._tex=s.getTargetTexture(t||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(i,o,{type:r,format:gl.RGBA,filter:gl.LINEAR});var a="";this.properties.uvcode&&(a="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(a=this.properties.uvcode));var u="";this.properties.pixelcode&&(u="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&(u=this.properties.pixelcode));var h=this._shader;if(!(this.has_error||h&&this._shader_code==a+"|"+u)){var p=s.replaceCode(n.pixel_shader,{UV_CODE:a,PIXEL_CODE:u});try{h=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,p),this.boxcolor="#00FF00"}catch(t){return GL.Shader.dumpErrorToConsole(t,Shader.SCREEN_VERTEX_SHADER,p),this.boxcolor="#FF0000",void(this.has_error=!0)}this._shader=h,this._shader_code=a+"|"+u}if(this._shader){var l=this.getInputData(2);null!=l?this.properties.value=l:l=parseFloat(this.properties.value);var d=this.graph.getTime();this._tex.drawTo((function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t&&t.bind(0),e&&e.bind(1);var s=Mesh.getScreenQuad();h.uniforms({u_texture:0,u_textureB:1,value:l,texSize:[i,o,1/i,1/o],time:d}).draw(s)})),this.setOutputData(0,this._tex)}}}else this.setOutputData(0,t)},n.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 texSize;\n\t\tuniform float time;\n\t\tuniform float value;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\t{{UV_CODE}};\n\t\t\tvec4 color4 = texture2D(u_texture, uv);\n\t\t\tvec3 color = color4.rgb;\n\t\t\tvec4 color4B = texture2D(u_textureB, uv);\n\t\t\tvec3 colorB = color4B.rgb;\n\t\t\tvec3 result = color;\n\t\t\tfloat alpha = 1.0;\n\t\t\t{{PIXEL_CODE}};\n\t\t\tgl_FragColor = vec4(result, alpha);\n\t\t}\n\t\t",n.registerPreset=function(t,e){n.presets[t]=e},n.registerPreset("",""),n.registerPreset("bypass","color"),n.registerPreset("add","color + colorB * value"),n.registerPreset("substract","(color - colorB) * value"),n.registerPreset("mate","mix( color, colorB, color4B.a * value)"),n.registerPreset("invert","vec3(1.0) - color"),n.registerPreset("multiply","color * colorB * value"),n.registerPreset("divide","(color / colorB) / value"),n.registerPreset("difference","abs(color - colorB) * value"),n.registerPreset("max","max(color, colorB) * value"),n.registerPreset("min","min(color, colorB) * value"),n.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),n.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),n.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),n.registerPreset("normalmap","\n\t\tfloat z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;\n\t\tfloat z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;\n\t\tfloat z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;\n\t\tfloat z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;\n\t\tfloat z4 = color.x;\n\t\tfloat z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;\n\t\tfloat z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;\n\t\tfloat z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;\n\t\tfloat z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;\n\t\tvec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );\n\t\tnormal.xy *= value;\n\t\tresult.xyz = normalize(normal) * 0.5 + vec3(0.5);\n\t"),n.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),n.prototype.onInspect=function(t){var e=this;t.addCombo("Presets","",{values:Object.keys(n.presets),callback:function(i){var s=n.presets[i];s&&(e.setProperty("pixelcode",s),e.title=i,t.refresh())}})},e.registerNodeType("texture/operation",n),a.title="Shader",a.desc="Texture shader",a.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:s.MODE_VALUES}},a.prototype.onPropertyChanged=function(t,e){if("code"==t){var i=this.getShader();if(i){var s=i.uniformInfo;if(this.inputs)for(var o={},r=0;r<this.inputs.length;++r)(n=this.getInputInfo(r))&&(!s[n.name]||o[n.name]?(this.removeInput(r),r--):o[n.name]=!0);for(var r in s){var n;if(null!==(n=i.uniformInfo[r]).loc&&"time"!=r){var a="number";if(this._shader.samplers[r])a="texture";else switch(n.size){case 1:a="number";break;case 2:a="vec2";break;case 3:a="vec3";break;case 4:a="vec4";break;case 9:a="mat3";break;case 16:a="mat4";break;default:continue}var u=this.findInputSlot(r);if(-1!=u){var h=this.getInputInfo(u);if(h){if(h.type==a)continue;this.removeInput(u,a),this.addInput(r,a)}else this.addInput(r,a)}else this.addInput(r,a)}}}}},a.prototype.getShader=function(){return this._shader&&this._shader_code==this.properties.code?this._shader:(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader?(this.boxcolor="green",this._shader):(this.boxcolor="red",null))},a.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getShader();if(t){var e=0,i=null;if(this.inputs)for(var o=0;o<this.inputs.length;++o){var r=this.getInputInfo(o),n=this.getInputData(o);null!=n&&(n.constructor===GL.Texture&&(n.bind(e),i||(i=n),n=e,e++),t.setUniform(r.name,n))}var a=this._uniforms,u=s.getTextureType(this.properties.precision,i),h=0|this.properties.width,p=0|this.properties.height;0==h&&(h=i?i.width:gl.canvas.width),0==p&&(p=i?i.height:gl.canvas.height),a.texSize[0]=h,a.texSize[1]=p,a.texSize[2]=1/h,a.texSize[3]=1/p,a.time=this.graph.getTime(),a.u_value=this.properties.u_value,a.u_color.set(this.properties.u_color),this._tex&&this._tex.type==u&&this._tex.width==h&&this._tex.height==p||(this._tex=new GL.Texture(h,p,{type:u,format:gl.RGBA,filter:gl.LINEAR})),this._tex.drawTo((function(){t.uniforms(a).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,this._tex)}}},a.pixel_shader="precision highp float;\n\nvarying vec2 v_coord;\nuniform float time; //time in seconds\nuniform vec4 texSize; //tex resolution\nuniform float u_value;\nuniform vec4 u_color;\n\nvoid main() {\n\tvec2 uv = v_coord;\n\tvec3 color = vec3(0.0);\n\t//your code here\n\tcolor.xy=uv;\n\n\tgl_FragColor = vec4(color, 1.0);\n}\n",e.registerNodeType("texture/shader",a),u.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},u.title="Scale/Offset",u.desc="Applies an scaling and offseting",u.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0)&&t)if(this.properties.precision!==s.PASS_THROUGH){var e=t.width,i=t.height,o=this.precision===s.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===s.DEFAULT&&(o=t.type),this._tex&&this._tex.width==e&&this._tex.height==i&&this._tex.type==o||(this._tex=new GL.Texture(e,i,{type:o,format:gl.RGBA,filter:gl.LINEAR}));var r=this._shader;r||(r=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,u.pixel_shader));var n=this.getInputData(1);n?(this.properties.scale[0]=n[0],this.properties.scale[1]=n[1]):n=this.properties.scale;var a=this.getInputData(2);a?(this.properties.offset[0]=a[0],this.properties.offset[1]=a[1]):a=this.properties.offset,this._tex.drawTo((function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t.bind(0);var e=Mesh.getScreenQuad();r.uniforms({u_texture:0,u_scale:n,u_offset:a}).draw(e)})),this.setOutputData(0,this._tex)}else this.setOutputData(0,t)},u.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_scale;\n\t\tuniform vec2 u_offset;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tuv = uv / u_scale - u_offset;\n\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t}\n\t\t",e.registerNodeType("texture/scaleOffset",u),h.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},h.title="Warp",h.desc="Texture warp operation",h.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==s.PASS_THROUGH){var e=this.getInputData(1),i=512,o=512;gl.UNSIGNED_BYTE,t?(i=t.width,o=t.height,t.type):e&&(i=e.width,o=e.height,e.type),t||this._tex?this._tex=s.getTargetTexture(t||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(i,o,{type:this.precision===s.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR});var r=this._shader;r||(r=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,h.pixel_shader));var n=this.getInputData(2);null!=n?this.properties.factor=n:n=parseFloat(this.properties.factor);var a=this._uniforms;a.u_factor=n,a.u_scale.set(this.properties.scale),a.u_offset.set(this.properties.offset),this._tex.drawTo((function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t&&t.bind(0),e&&e.bind(1);var i=Mesh.getScreenQuad();r.uniforms(a).draw(i)})),this.setOutputData(0,this._tex)}else this.setOutputData(0,t)},h.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform float u_factor;\n\t\tuniform vec2 u_scale;\n\t\tuniform vec2 u_offset;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tuv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;\n\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t}\n\t\t",e.registerNodeType("texture/warp",h),p.title="to Viewport",p.desc="Texture to viewport",p._prev_viewport=new Float32Array(4),p.prototype.onDrawBackground=function(t){if(!(this.flags.collapsed||this.size[1]<=40)){var e=this.getInputData(0);e&&t.drawImage(t==gl?e:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}},p.prototype.onExecute=function(){var t=this.getInputData(0);if(t){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var e=this.properties.gamma||1;this.isInputConnected(1)&&(e=this.getInputData(1)),t.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);var i=p._prev_viewport;i.set(gl.viewport_data);var s=this.properties.viewport;if(gl.viewport(i[0]+i[2]*s[0],i[1]+i[3]*s[1],i[2]*s[2],i[3]*s[3]),gl.getViewport(),this.properties.antialiasing){p._shader||(p._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,p.aa_pixel_shader));var o=Mesh.getScreenQuad();t.bind(0),p._shader.uniforms({u_texture:0,uViewportSize:[t.width,t.height],u_igamma:1/e,inverseVP:[1/t.width,1/t.height]}).draw(o)}else 1!=e?(p._gamma_shader||(p._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,p.gamma_pixel_shader)),t.toViewport(p._gamma_shader,{u_texture:0,u_igamma:1/e})):t.toViewport();gl.viewport(i[0],i[1],i[2],i[3])}},p.prototype.onGetInputs=function(){return[["gamma","number"]]},p.aa_pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 uViewportSize;\n\t\tuniform vec2 inverseVP;\n\t\tuniform float u_igamma;\n\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\n\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t{\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\n\t\t\tvec2 dir;\n\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\n\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\n\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\n\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\n\t\t\t//return vec4(rgbA,1.0);\n\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\telse\n\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\tif(u_igamma != 1.0)\n\t\t\t\tcolor.xyz = pow( color.xyz, vec3(u_igamma) );\n\t\t\treturn color;\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t}\n\t\t",p.gamma_pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_igamma;\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord);\n\t\t\tcolor.xyz = pow(color.xyz, vec3(u_igamma) );\n\t\t   gl_FragColor = color;\n\t\t}\n\t\t",e.registerNodeType("texture/toviewport",p),l.title="Copy",l.desc="Copy Texture",l.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:s.MODE_VALUES}},l.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)){if(t){var e=t.width,i=t.height;0!=this.properties.size&&(e=this.properties.size,i=this.properties.size);var o=this._temp_texture,r=t.type;if(this.properties.precision===s.LOW?r=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(r=gl.HIGH_PRECISION_FORMAT),!o||o.width!=e||o.height!=i||o.type!=r){var n=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(e)&&isPowerOfTwo(i)&&(n=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(e,i,{type:r,format:gl.RGBA,minFilter:n,magFilter:gl.LINEAR})}t.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},e.registerNodeType("texture/copy",l),d.title="Downsample",d.desc="Downsample Texture",d.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:s.MODE_VALUES}},d.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)&&t&&t.texture_type===GL.TEXTURE_2D)if(this.properties.iterations<1)this.setOutputData(0,t);else{var e=d._shader;e||(d._shader=e=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader));var i=0|t.width,o=0|t.height,r=t.type;this.properties.precision===s.LOW?r=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(r=gl.HIGH_PRECISION_FORMAT);var n=this.properties.iterations||1,a=t,u=null,h=[],p={type:r,format:t.format},l=vec2.create(),c={u_offset:l};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var _=0;_<n&&(l[0]=1/i,l[1]=1/o,i=i>>1||0,o=o>>1||0,u=GL.Texture.getTemporary(i,o,p),h.push(u),a.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),a.copyTo(u,e,c),1!=i||1!=o);++_)a=u;for(this._texture=h.pop(),_=0;_<h.length;++_)GL.Texture.releaseTemporary(h[_]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},d.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D(u_texture, v_coord );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n\t\t   gl_FragColor = color * 0.25;\n\t\t}\n\t\t",e.registerNodeType("texture/downsample",d),c.title="Resize",c.desc="Resize Texture",c.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:s.MODE_VALUES}},c.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)&&t&&t.texture_type===GL.TEXTURE_2D){var e=0|this.properties.size[0],i=0|this.properties.size[1];0==e&&(e=t.width),0==i&&(i=t.height);var o=t.type;this.properties.precision===s.LOW?o=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(o=gl.HIGH_PRECISION_FORMAT),this._texture&&this._texture.width==e&&this._texture.height==i&&this._texture.type==o||(this._texture=new GL.Texture(e,i,{type:o})),t.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},e.registerNodeType("texture/resize",c),_.title="Average",_.desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.\n If high_quality is true, then it generates the mipmaps first and reads from the lower one.",_.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var t=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,t),this.setOutputData(2,(t[0]+t[1]+t[2])/3)},_.prototype.onPreRenderExecute=function(){this.updateAverage()},_.prototype.updateAverage=function(){var t=this.getInputData(0);if(t&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!_._shader){_._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,_.pixel_shader);for(var e=new Float32Array(16),i=0;i<e.length;++i)e[i]=Math.random();_._shader.uniforms({u_samples_a:e.subarray(0,16),u_samples_b:e.subarray(16,32)})}var s=this._temp_texture,o=gl.UNSIGNED_BYTE;t.type!=o&&(o=gl.FLOAT),s&&s.type==o||(this._temp_texture=new GL.Texture(1,1,{type:o,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&(this._temp_pot2_texture&&this._temp_pot2_texture.type==o||(this._temp_pot2_texture=new GL.Texture(512,512,{type:o,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),t.copyTo(this._temp_pot2_texture),(t=this._temp_pot2_texture).bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var r=_._shader,n=this._uniforms;if(n.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo((function(){t.toViewport(r,n)})),this.isOutputConnected(1)||this.isOutputConnected(2)){var a=this._temp_texture.getPixels();if(a){var u=this._luminance;o=this._temp_texture.type,u.set(a),o==gl.UNSIGNED_BYTE?vec4.scale(u,u,1/255):o==GL.HALF_FLOAT||GL.HALF_FLOAT_OES}}}},_.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform mat4 u_samples_a;\n\t\tuniform mat4 u_samples_b;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_mipmap_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t//random average\n\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t{\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t}\n\t\t   gl_FragColor = color * 0.03125;\n\t\t}\n\t\t",e.registerNodeType("texture/average",_),g.widgets_info={mode:{widget:"combo",values:["min","max","avg"]}},g.title="MinMax",g.desc="Compute the scene min max",g.prototype.onExecute=function(){this.properties.use_previous_frame||this.update(),this.setOutputData(0,this._temp_texture),this.setOutputData(1,this._luminance)},g.prototype.onPreRenderExecute=function(){this.update()},g.prototype.update=function(){if((s=this.getInputData(0))&&(this.isOutputConnected(0)||this.isOutputConnected(1))){g._shader||(g._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,g.pixel_shader)),this._temp_texture;var t=gl.UNSIGNED_BYTE;s.type!=t&&(t=gl.FLOAT);var e=512;if(!this._textures_chain.length||this._textures_chain[0].type!=t)for(;i&&(this._textures_chain[i]=new GL.Texture(e,e,{type:t,format:gl.RGBA,filter:gl.NEAREST}),i++,1!=(e>>=2)););s.copyTo(this._textures_chain[0]),this._textures_chain[0];for(var i=1;i<=this._textures_chain.length;++i){var s;s=this._textures_chain[i]}var o=g._shader,r=this._uniforms;r.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo((function(){s.toViewport(o,r)}))}},g.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform mat4 u_samples_a;\n\t\tuniform mat4 u_samples_b;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_mipmap_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t//random average\n\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t{\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t}\n\t\t   gl_FragColor = color * 0.03125;\n\t\t}\n\t\t",f.title="Smooth",f.desc="Smooth texture over time",f.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){f._shader||(f._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,f.pixel_shader));var e=this._temp_texture;if(!e||e.type!=t.type||e.width!=t.width||e.height!=t.height){var i={type:t.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(t.width,t.height,i),this._temp_texture2=new GL.Texture(t.width,t.height,i),t.copyTo(this._temp_texture2)}var s=this._temp_texture,o=this._temp_texture2,r=f._shader,n=this._uniforms;n.u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),s.drawTo((function(){o.bind(1),t.toViewport(r,n)})),this.setOutputData(0,s),this._temp_texture=o,this._temp_texture2=s}},f.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_factor;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tgl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );\n\t\t}\n\t\t",e.registerNodeType("texture/temporal_smooth",f),v.title="Lineal Avg Smooth",v.desc="Smooth texture linearly over time",v["@samples"]={type:"number",min:1,max:64,step:1,precision:1},v.prototype.getPreviewTexture=function(){return this._temp_texture2},v.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){v._shader||(v._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,v.pixel_shader_copy),v._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,v.pixel_shader_avg));var e=Math.clamp(this.properties.samples,0,64),i=this.frame,s=this.properties.frames_interval;if(0==s||i%s==0){var o=this._temp_texture;if(!o||o.type!=t.type||o.width!=e){var r={type:t.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(e,1,r),this._temp_texture2=new GL.Texture(e,1,r),this._temp_texture_out=new GL.Texture(1,1,r)}var n=this._temp_texture,a=this._temp_texture2,u=v._shader_copy,h=v._shader_avg,p=this._uniforms;p.u_samples=e,p.u_isamples=1/e,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),n.drawTo((function(){a.bind(1),t.toViewport(u,p)})),this._temp_texture_out.drawTo((function(){n.toViewport(h,p)})),this.setOutputData(0,this._temp_texture_out),this._temp_texture=a,this._temp_texture2=n}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}},v.pixel_shader_copy="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_isamples;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tif( v_coord.x <= u_isamples )\n\t\t\t\tgl_FragColor = texture2D( u_texture, vec2(0.5) );\n\t\t\telse\n\t\t\t\tgl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );\n\t\t}\n\t\t",v.pixel_shader_avg="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform int u_samples;\n\t\tuniform float u_isamples;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\tfor(int i = 0; i < 64; ++i)\n\t\t\t{\n\t\t\t\tcolor += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );\n\t\t\t\tif(i == (u_samples - 1))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tgl_FragColor = color * u_isamples;\n\t\t}\n\t\t",e.registerNodeType("texture/linear_avg_smooth",v),m.title="Image to Texture",m.desc="Uploads an image to the GPU",m.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=t.videoWidth||t.width,i=t.videoHeight||t.height;if(t.gltexture)this.setOutputData(0,t.gltexture);else{var s=this._temp_texture;s&&s.width==e&&s.height==i||(this._temp_texture=new GL.Texture(e,i,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(t)}catch(t){return void console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+t)}this.setOutputData(0,this._temp_texture)}}},e.registerNodeType("texture/imageToTexture",m),y.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:s.MODE_VALUES}},y.title="LUT",y.desc="Apply LUT to Texture",y.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision!==s.PASS_THROUGH&&!1!==this.properties.enabled){if(t){var e=this.getInputData(1);if(e||(e=s.getTexture(this.properties.texture)),e){e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var i=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=i=this.getInputData(2)),this._tex=s.getTargetTexture(t,this._tex,this.properties.precision),this._tex.drawTo((function(){e.bind(1),t.toViewport(y._shader,{u_texture:0,u_textureB:1,u_amount:i})})),this.setOutputData(0,this._tex)}else this.setOutputData(0,t)}}else this.setOutputData(0,t)}},y.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_amount;\n\t\t\n\t\tvoid main() {\n\t\t\t lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t\t mediump vec2 quad1;\n\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t\t mediump vec2 quad2;\n\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t\t highp vec2 texPos1;\n\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t highp vec2 texPos2;\n\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n\t\t\t lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\t\t}\n\t\t",e.registerNodeType("texture/LUT",y),x.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:s.MODE_VALUES}},x.title="Encode",x.desc="Apply a texture atlas to encode a texture",x.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision!==s.PASS_THROUGH&&!1!==this.properties.enabled){if(t){var e=this.getInputData(1);if(e||(e=s.getTexture(this.properties.texture)),e){e.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var i=this._uniforms;i.u_row_simbols=Math.floor(this.properties.num_row_symbols),i.u_symbol_size=this.properties.symbol_size,i.u_brightness=this.properties.brightness,i.u_invert=this.properties.invert?1:0,i.u_colorize=this.properties.colorize?1:0,this._tex=s.getTargetTexture(t,this._tex,this.properties.precision),i.u_res[0]=this._tex.width,i.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo((function(){e.bind(1),t.toViewport(x._shader,i)})),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}else this.setOutputData(0,t)}}else this.setOutputData(0,t)}},x.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_row_simbols;\n\t\tuniform float u_symbol_size;\n\t\tuniform float u_brightness;\n\t\tuniform float u_invert;\n\t\tuniform float u_colorize;\n\t\tuniform vec2 u_res;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 total_symbols = u_res / u_symbol_size;\n\t\t\tvec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate \n\t\t\tvec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;\n\t\t\tlowp vec4 textureColor = texture2D(u_texture, uv );\n\t\t\tfloat lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);\n\t\t\tif( u_invert == 1.0 ) lum = 1.0 - lum;\n\t\t\tfloat index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));\n\t\t\tfloat col = mod( index, u_row_simbols );\n\t\t\tfloat row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;\n\t\t\tvec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;\n\t\t\tvec4 color = texture2D( u_textureB, simbol_uv );\n\t\t\tif(u_colorize == 1.0)\n\t\t\t\tcolor *= textureColor;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t",e.registerNodeType("texture/encode",x),b.title="Texture to Channels",b.desc="Split texture channels",b.prototype.onExecute=function(){var t=this.getInputData(0);if(t){this._channels||(this._channels=Array(4));for(var e=gl.RGB,i=0,s=0;s<4;s++)this.isOutputConnected(s)?(this._channels[s]&&this._channels[s].width==t.width&&this._channels[s].height==t.height&&this._channels[s].type==t.type&&this._channels[s].format==e||(this._channels[s]=new GL.Texture(t.width,t.height,{type:t.type,format:e,filter:gl.LINEAR})),i++):this._channels[s]=null;if(i){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var o=Mesh.getScreenQuad(),r=b._shader,n=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(s=0;s<4;s++)this._channels[s]&&(this._channels[s].drawTo((function(){t.bind(0),r.uniforms({u_texture:0,u_mask:n[s]}).draw(o)})),this.setOutputData(s,this._channels[s]))}}},b.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec4 u_mask;\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t}\n\t\t",e.registerNodeType("texture/textureChannels",b),T.title="Channels to Texture",T.desc="Split texture channels",T.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},T.prototype.onExecute=function(){var t=s.getWhiteTexture(),e=this.getInputData(0)||t,i=this.getInputData(1)||t,o=this.getInputData(2)||t,r=this.getInputData(3)||t;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var n=Mesh.getScreenQuad();T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader));var a=T._shader,u=Math.max(e.width,i.width,o.width,r.width),h=Math.max(e.height,i.height,o.height,r.height),p=this.properties.precision==s.HIGH?s.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._texture&&this._texture.width==u&&this._texture.height==h&&this._texture.type==p||(this._texture=new GL.Texture(u,h,{type:p,format:gl.RGBA,filter:gl.LINEAR}));var l=this._color;l[0]=this.properties.R,l[1]=this.properties.G,l[2]=this.properties.B,l[3]=this.properties.A;var d=this._uniforms;this._texture.drawTo((function(){e.bind(0),i.bind(1),o.bind(2),r.bind(3),a.uniforms(d).draw(n)})),this.setOutputData(0,this._texture)},T.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_textureR;\n\t\tuniform sampler2D u_textureG;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform sampler2D u_textureA;\n\t\tuniform vec4 u_color;\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = u_color * vec4( \t\t\t\t\ttexture2D(u_textureR, v_coord).r,\t\t\t\t\ttexture2D(u_textureG, v_coord).r,\t\t\t\t\ttexture2D(u_textureB, v_coord).r,\t\t\t\t\ttexture2D(u_textureA, v_coord).r);\n\t\t}\n\t\t",e.registerNodeType("texture/channelsTexture",T),E.title="Color",E.desc="Generates a 1x1 texture with a constant color",E.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},E.prototype.onDrawBackground=function(t){var e=this.properties.color;t.fillStyle="rgb("+Math.floor(255*Math.clamp(e[0],0,1))+","+Math.floor(255*Math.clamp(e[1],0,1))+","+Math.floor(255*Math.clamp(e[2],0,1))+")",this.flags.collapsed?this.boxcolor=t.fillStyle:t.fillRect(0,0,this.size[0],this.size[1])},E.prototype.onExecute=function(){var t=this.properties.precision==s.HIGH?s.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._tex&&this._tex.type==t||(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:t,minFilter:gl.NEAREST}));var e=this.properties.color;if(this.inputs)for(var i=0;i<this.inputs.length;i++){var o=this.inputs[i],r=this.getInputData(i);if(void 0!==r)switch(o.name){case"RGB":case"RGBA":e.set(r);break;case"R":e[0]=r;break;case"G":e[1]=r;break;case"B":e[2]=r;break;case"A":e[3]=r}}vec4.sqrDist(this._tex_color,e)>.001&&(this._tex_color.set(e),this._tex.fill(e)),this.setOutputData(0,this._tex)},E.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},e.registerNodeType("texture/color",E),w.title="Gradient",w.desc="Generates a gradient",w["@A"]={type:"color"},w["@B"]={type:"color"},w["@texture_size"]={type:"enum",values:[32,64,128,256,512]},w.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var t=GL.Mesh.getScreenQuad(),e=w._shader,i=this.getInputData(0);i||(i=this.properties.A);var s=this.getInputData(1);s||(s=this.properties.B);for(var o=2;o<this.inputs.length;o++){var r=this.inputs[o],n=this.getInputData(o);void 0!==n&&(this.properties[r.name]=n)}var a=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(a.u_colorA,i),vec3.copy(a.u_colorB,s);var u=parseInt(this.properties.texture_size);this._tex&&this._tex.width==u||(this._tex=new GL.Texture(u,u,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo((function(){e.uniforms(a).draw(t)})),this.setOutputData(0,this._tex)},w.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},w.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform float u_angle;\n\t\tuniform float u_scale;\n\t\tuniform vec3 u_colorA;\n\t\tuniform vec3 u_colorB;\n\t\t\n\t\tvec2 rotate(vec2 v, float angle)\n\t\t{\n\t\t\tvec2 result;\n\t\t\tfloat _cos = cos(angle);\n\t\t\tfloat _sin = sin(angle);\n\t\t\tresult.x = v.x * _cos - v.y * _sin;\n\t\t\tresult.y = v.x * _sin + v.y * _cos;\n\t\t\treturn result;\n\t\t}\n\t\tvoid main() {\n\t\t\tfloat f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n\t\t\tvec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n\t\t   gl_FragColor = vec4(color,1.0);\n\t\t}\n\t\t",e.registerNodeType("texture/gradient",w),I.title="Mix",I.desc="Generates a texture mixing two textures",I.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},I.prototype.onExecute=function(){var t=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==s.PASS_THROUGH){var e=this.getInputData(1);if(t&&e){var i=this.getInputData(2),o=this.getInputData(3);this._tex=s.getTargetTexture(this.properties.size_from_biggest&&e.width>t.width?e:t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var r=Mesh.getScreenQuad(),n=null,a=this._uniforms;if(i)(n=I._shader_tex)||(n=I._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.pixel_shader,{MIX_TEX:""}));else{(n=I._shader_factor)||(n=I._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.pixel_shader));var u=null==o?this.properties.factor:o;a.u_mix.set([u,u,u,u])}var h=this.properties.invert;this._tex.drawTo((function(){t.bind(h?1:0),e.bind(h?0:1),i&&i.bind(2),n.uniforms(a).draw(r)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,t)},I.prototype.onGetInputs=function(){return[["factor","number"]]},I.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_textureA;\n\t\tuniform sampler2D u_textureB;\n\t\t#ifdef MIX_TEX\n\t\t\tuniform sampler2D u_textureMix;\n\t\t#else\n\t\t\tuniform vec4 u_mix;\n\t\t#endif\n\t\t\n\t\tvoid main() {\n\t\t\t#ifdef MIX_TEX\n\t\t\t   vec4 f = texture2D(u_textureMix, v_coord);\n\t\t\t#else\n\t\t\t   vec4 f = u_mix;\n\t\t\t#endif\n\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );\n\t\t}\n\t\t",e.registerNodeType("texture/mix",I),O.title="Edges",O.desc="Detects edges",O.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},O.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision!==s.PASS_THROUGH){if(t){this._tex=s.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var e=Mesh.getScreenQuad(),i=O._shader,o=this.properties.invert,r=this.properties.factor,n=this.properties.threshold?1:0;this._tex.drawTo((function(){t.bind(0),i.uniforms({u_texture:0,u_isize:[1/t.width,1/t.height],u_factor:r,u_threshold:n,u_invert:o?1:0}).draw(e)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,t)}},O.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_isize;\n\t\tuniform int u_invert;\n\t\tuniform float u_factor;\n\t\tuniform float u_threshold;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 center = texture2D(u_texture, v_coord);\n\t\t\tvec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n\t\t\tvec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n\t\t\tvec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n\t\t\tvec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n\t\t\tvec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n\t\t\tdiff *= u_factor;\n\t\t\tif(u_invert == 1)\n\t\t\t\tdiff.xyz = vec3(1.0) - diff.xyz;\n\t\t\tif( u_threshold == 0.0 )\n\t\t\t\tgl_FragColor = vec4( diff.xyz, center.a );\n\t\t\telse\n\t\t\t\tgl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n\t\t}\n\t\t",e.registerNodeType("texture/edges",O),D.title="Depth Range",D.desc="Generates a texture with a depth range",D.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var e=gl.UNSIGNED_BYTE;this.properties.high_precision&&(e=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==e&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:e,format:gl.RGBA,filter:gl.LINEAR}));var i=this._uniforms,s=this.properties.distance;this.isInputConnected(1)&&(s=this.getInputData(1),this.properties.distance=s);var o=this.properties.range;this.isInputConnected(2)&&(o=this.getInputData(2),this.properties.range=o),i.u_distance=s,i.u_range=o,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var r=Mesh.getScreenQuad();D._shader||(D._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,D.pixel_shader),D._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,D.pixel_shader,{ONLY_DEPTH:""}));var n,a=this.properties.only_depth?D._shader_onlydepth:D._shader;n=t.near_far_planes?t.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3],i.u_camera_planes=n,this._temp_texture.drawTo((function(){t.bind(0),a.uniforms(i).draw(r)})),this._temp_texture.near_far_planes=n,this.setOutputData(0,this._temp_texture)}}},D.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform float u_distance;\n\t\tuniform float u_range;\n\t\t\n\t\tfloat LinearDepth()\n\t\t{\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\tfloat depth = texture2D(u_texture, v_coord).x;\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\treturn zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t\tfloat depth = LinearDepth();\n\t\t\t#ifdef ONLY_DEPTH\n\t\t\t   gl_FragColor = vec4(depth);\n\t\t\t#else\n\t\t\t\tfloat diff = abs(depth * u_camera_planes.y - u_distance);\n\t\t\t\tfloat dof = 1.0;\n\t\t\t\tif(diff <= u_range)\n\t\t\t\t\tdof = diff / u_range;\n\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t#endif\n\t\t}\n\t\t",e.registerNodeType("texture/depth_range",D),N.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},N.title="Linear Depth",N.desc="Creates a color texture with linear depth",N.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t&&(t.format==gl.DEPTH_COMPONENT||t.format==gl.DEPTH_STENCIL)){var e=this.properties.precision==s.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._temp_texture&&this._temp_texture.type==e&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:e,format:gl.RGB,filter:gl.LINEAR}));var i=this._uniforms;i.u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var o=Mesh.getScreenQuad();N._shader||(N._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,N.pixel_shader));var r,n=N._shader;r=t.near_far_planes?t.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3],i.u_camera_planes=r,i.u_ires.set([0,0]),this._temp_texture.drawTo((function(){t.bind(0),n.uniforms(i).draw(o)})),this._temp_texture.near_far_planes=r,this.setOutputData(0,this._temp_texture)}}},N.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform int u_invert;\n\t\tuniform vec2 u_ires;\n\t\t\n\t\tvoid main() {\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\tfloat depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;\n\t\t\tfloat f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tif( u_invert == 1 )\n\t\t\t\tf = 1.0 - f;\n\t\t\tgl_FragColor = vec4(vec3(f),1.0);\n\t\t}\n\t\t",e.registerNodeType("texture/linear_depth",N),S.title="Blur",S.desc="Blur a texture",S.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},S.max_iterations=20,S.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var i=this._final_texture;i&&i.width==t.width&&i.height==t.height&&i.type==t.type||(i=this._final_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var s=this.properties.iterations;if(this.isInputConnected(1)&&(s=this.getInputData(1),this.properties.iterations=s),0!=(s=Math.min(Math.floor(s),S.max_iterations))){var o=this.properties.intensity;this.isInputConnected(2)&&(o=this.getInputData(2),this.properties.intensity=o);var r=e.camera_aspect;r||void 0===window.gl||(r=gl.canvas.height/gl.canvas.width),r||(r=1),r=this.properties.preserve_aspect?r:1;var n=this.properties.scale||[1,1];t.applyBlur(r*n[0],n[1],o,i);for(var a=1;a<s;++a)i.applyBlur(r*n[0]*(a+1),n[1]*(a+1),o);this.setOutputData(0,i)}else this.setOutputData(0,t)}},e.registerNodeType("texture/blur",S),C.prototype.applyFX=function(t,e,i,s){var o=t.width,r=t.height,n={format:t.format,type:t.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},a=this._uniforms,u=this._textures;(d=C._cut_shader)||(d=C._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),a.u_threshold=this.threshold;var h=u[0]=GL.Texture.getTemporary(o,r,n);t.blit(h,d.uniforms(a));var p=h,l=this.iterations;l=0|Math.clamp(l,1,16);var d,c=a.u_texel_size,_=this.intensity;a.u_intensity=1,a.u_delta=this.scale,(d=C._shader)||(d=C._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.scale_pixel_shader));for(var g=1;g<l&&((0|r)>1&&(r>>=1),!((o>>=1)<2));g++)h=u[g]=GL.Texture.getTemporary(o,r,n),c[0]=1/p.width,c[1]=1/p.height,p.blit(h,d.uniforms(a)),p=h;for(s&&(c[0]=1/p.width,c[1]=1/p.height,a.u_intensity=_,a.u_delta=1,p.blit(s,d.uniforms(a))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),a.u_intensity=this.persistence,a.u_delta=.5,g-=2;g>=0;g--)h=u[g],u[g]=null,c[0]=1/p.width,c[1]=1/p.height,p.blit(h,d.uniforms(a)),GL.Texture.releaseTemporary(p),p=h;if(gl.disable(gl.BLEND),i&&p.blit(i),e){var f=e,v=this.dirt_texture,m=this.dirt_factor;a.u_intensity=_,(d=v?C._dirt_final_shader:C._final_shader)||(d=v?C._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.final_pixel_shader,{USE_DIRT:""}):C._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,C.final_pixel_shader)),f.drawTo((function(){t.bind(0),p.bind(1),v&&(d.setUniform("u_dirt_factor",m),d.setUniform("u_dirt_texture",v.bind(2))),d.toViewport(a)}))}GL.Texture.releaseTemporary(p)},C.cut_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform float u_threshold;\n\tvoid main() {\n\t\tgl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n\t}",C.scale_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform vec2 u_texel_size;\n\tuniform float u_delta;\n\tuniform float u_intensity;\n\t\n\tvec4 sampleBox(vec2 uv) {\n\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\tvec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n\t\treturn s * 0.25;\n\t}\n\tvoid main() {\n\t\tgl_FragColor = u_intensity * sampleBox( v_coord );\n\t}",C.final_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform sampler2D u_glow_texture;\n\t#ifdef USE_DIRT\n\t\tuniform sampler2D u_dirt_texture;\n\t#endif\n\tuniform vec2 u_texel_size;\n\tuniform float u_delta;\n\tuniform float u_intensity;\n\tuniform float u_dirt_factor;\n\t\n\tvec4 sampleBox(vec2 uv) {\n\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\tvec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n\t\treturn s * 0.25;\n\t}\n\tvoid main() {\n\t\tvec4 glow = sampleBox( v_coord );\n\t\t#ifdef USE_DIRT\n\t\t\tglow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n\t\t#endif\n\t\tgl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n\t}",A.title="Glow",A.desc="Filters a texture giving it a glow effect",A.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:s.MODE_VALUES}},A.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},A.prototype.onGetOutputs=function(){return[["average","Texture"]]},A.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isAnyOutputConnected())if(this.properties.precision!==s.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){t.width,t.height;var e=this.fx;e.threshold=this.getInputOrProperty("threshold"),e.iterations=this.getInputOrProperty("iterations"),e.intensity=this.getInputOrProperty("intensity"),e.persistence=this.getInputOrProperty("persistence"),e.dirt_texture=this.getInputData(1),e.dirt_factor=this.getInputOrProperty("dirt_factor"),e.scale=this.properties.scale;var i=s.getTextureType(this.properties.precision,t),o=null;this.isOutputConnected(2)&&((o=this._average_texture)&&o.type==t.type&&o.format==t.format||(o=this._average_texture=new GL.Texture(1,1,{type:t.type,format:t.format,filter:gl.LINEAR})));var r=null;this.isOutputConnected(1)&&((r=this._glow_texture)&&r.width==t.width&&r.height==t.height&&r.type==i&&r.format==t.format||(r=this._glow_texture=new GL.Texture(t.width,t.height,{type:i,format:t.format,filter:gl.LINEAR})));var n=null;this.isOutputConnected(0)&&((n=this._final_texture)&&n.width==t.width&&n.height==t.height&&n.type==i&&n.format==t.format||(n=this._final_texture=new GL.Texture(t.width,t.height,{type:i,format:t.format,filter:gl.LINEAR}))),e.applyFX(t,n,r,o),this.isOutputConnected(0)&&this.setOutputData(0,n),this.isOutputConnected(1)&&this.setOutputData(1,o),this.isOutputConnected(2)&&this.setOutputData(2,r)}else this.setOutputData(0,t)},e.registerNodeType("texture/glow",A),L.title="Kuwahara Filter",L.desc="Filters a texture giving an artistic oil canvas painting",L.max_radius=10,L._shaders=[],L.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var i=this._temp_texture;i&&i.width==t.width&&i.height==t.height&&i.type==t.type||(this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var s=this.properties.radius;if(0!=(s=Math.min(Math.floor(s),L.max_radius))){var o=this.properties.intensity,r=e.camera_aspect;r||void 0===window.gl||(r=gl.canvas.height/gl.canvas.width),r||(r=1),r=this.properties.preserve_aspect?r:1,L._shaders[s]||(L._shaders[s]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,L.pixel_shader,{RADIUS:s.toFixed(0)}));var n=L._shaders[s],a=GL.Mesh.getScreenQuad();t.bind(0),this._temp_texture.drawTo((function(){n.uniforms({u_texture:0,u_intensity:o,u_resolution:[t.width,t.height],u_iResolution:[1/t.width,1/t.height]}).draw(a)})),this.setOutputData(0,this._temp_texture)}else this.setOutputData(0,t)}},L.pixel_shader="\nprecision highp float;\nvarying vec2 v_coord;\nuniform sampler2D u_texture;\nuniform float u_intensity;\nuniform vec2 u_resolution;\nuniform vec2 u_iResolution;\n#ifndef RADIUS\n\t#define RADIUS 7\n#endif\nvoid main() {\n\n\tconst int radius = RADIUS;\n\tvec2 fragCoord = v_coord;\n\tvec2 src_size = u_iResolution;\n\tvec2 uv = v_coord;\n\tfloat n = float((radius + 1) * (radius + 1));\n\tint i;\n\tint j;\n\tvec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n\tvec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n\tvec3 c;\n\t\n\tfor (int j = -radius; j <= 0; ++j)  {\n\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm0 += c;\n\t\t\ts0 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = -radius; j <= 0; ++j)  {\n\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm1 += c;\n\t\t\ts1 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = 0; j <= radius; ++j)  {\n\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm2 += c;\n\t\t\ts2 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = 0; j <= radius; ++j)  {\n\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm3 += c;\n\t\t\ts3 += c * c;\n\t\t}\n\t}\n\t\n\tfloat min_sigma2 = 1e+2;\n\tm0 /= n;\n\ts0 = abs(s0 / n - m0 * m0);\n\t\n\tfloat sigma2 = s0.r + s0.g + s0.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m0, 1.0);\n\t}\n\t\n\tm1 /= n;\n\ts1 = abs(s1 / n - m1 * m1);\n\t\n\tsigma2 = s1.r + s1.g + s1.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m1, 1.0);\n\t}\n\t\n\tm2 /= n;\n\ts2 = abs(s2 / n - m2 * m2);\n\t\n\tsigma2 = s2.r + s2.g + s2.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m2, 1.0);\n\t}\n\t\n\tm3 /= n;\n\ts3 = abs(s3 / n - m3 * m3);\n\t\n\tsigma2 = s3.r + s3.g + s3.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m3, 1.0);\n\t}\n}\n",e.registerNodeType("texture/kuwahara",L),k.title="XDoG Filter",k.desc="Filters a texture giving an artistic ink style",k.max_radius=10,k._shaders=[],k.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR})),k._xdog_shader||(k._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,k.xdog_pixel_shader));var i=k._xdog_shader,s=GL.Mesh.getScreenQuad(),o=this.properties.sigma,r=this.properties.k,n=this.properties.p,a=this.properties.epsilon,u=this.properties.phi;t.bind(0),this._temp_texture.drawTo((function(){i.uniforms({src:0,sigma:o,k:r,p:n,epsilon:a,phi:u,cvsWidth:t.width,cvsHeight:t.height}).draw(s)})),this.setOutputData(0,this._temp_texture)}},k.xdog_pixel_shader="\nprecision highp float;\nuniform sampler2D src;\n\nuniform float cvsHeight;\nuniform float cvsWidth;\n\nuniform float sigma;\nuniform float k;\nuniform float p;\nuniform float epsilon;\nuniform float phi;\nvarying vec2 v_coord;\n\nfloat cosh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat cosH = (tmp + 1.0 / tmp) / 2.0;\n\treturn cosH;\n}\n\nfloat tanh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);\n\treturn tanH;\n}\n\nfloat sinh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat sinH = (tmp - 1.0 / tmp) / 2.0;\n\treturn sinH;\n}\n\nvoid main(void){\n\tvec3 destColor = vec3(0.0);\n\tfloat tFrag = 1.0 / cvsHeight;\n\tfloat sFrag = 1.0 / cvsWidth;\n\tvec2 Frag = vec2(sFrag,tFrag);\n\tvec2 uv = gl_FragCoord.st;\n\tfloat twoSigmaESquared = 2.0 * sigma * sigma;\n\tfloat twoSigmaRSquared = twoSigmaESquared * k * k;\n\tint halfWidth = int(ceil( 1.0 * sigma * k ));\n\n\tconst int MAX_NUM_ITERATION = 99999;\n\tvec2 sum = vec2(0.0);\n\tvec2 norm = vec2(0.0);\n\n\tfor(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){\n\t\tif(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}\n\t\tint i = int(cnt / (2*halfWidth+1)) - halfWidth;\n\t\tint j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);\n\n\t\tfloat d = length(vec2(i,j));\n\t\tvec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), \n\t\t\t\t\t\t\texp( -d * d / twoSigmaRSquared ));\n\n\t\tvec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;\n\n\t\tnorm += kernel;\n\t\tsum += kernel * L;\n\t}\n\n\tsum /= norm;\n\n\tfloat H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);\n\tfloat edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));\n\tdestColor = vec3(edge);\n\tgl_FragColor = vec4(destColor, 1.0);\n}",e.registerNodeType("texture/xDoG",k),R.title="Webcam",R.desc="Webcam texture",R.is_webcam_open=!1,R.prototype.openStream=function(){if(navigator.getUserMedia){this._waiting_confirmation=!0;var t={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch((function(t){R.is_webcam_open=!1,console.log("Webcam rejected",t),e._webcam_stream=!1,e.boxcolor="red",e.trigger("stream_error")}));var e=this}},R.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();R.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},R.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,this._video=e,e.onloadedmetadata=function(t){R.is_webcam_open=!0,console.log(t)}),this.trigger("stream_ready",e)},R.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},R.prototype.onRemoved=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();this._webcam_stream=null,this._video=null}},R.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||this._video&&(t.save(),t.webgl?this._video_texture&&t.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},R.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){var t=this._video.videoWidth,e=this._video.videoHeight,i=this._video_texture;i&&i.width==t&&i.height==e||(this._video_texture=new GL.Texture(t,e,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name&&(s.getTexturesContainer()[this.properties.texture_name]=this._video_texture),this.setOutputData(0,this._video_texture);for(var o=1;o<this.outputs.length;++o)if(this.outputs[o])switch(this.outputs[o].name){case"width":this.setOutputData(o,this._video.videoWidth);break;case"height":this.setOutputData(o,this._video.videoHeight)}}},R.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",e.EVENT],["stream_closed",e.EVENT],["stream_error",e.EVENT]]},e.registerNodeType("texture/webcam",R),P.title="Lens FX",P.desc="distortion and chromatic aberration",P.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},P.prototype.onGetInputs=function(){return[["enabled","boolean"]]},P.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0))if(this.properties.precision!==s.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var i=P._shader;i||(i=P._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,P.pixel_shader));var o=this.getInputData(1);null==o&&(o=this.properties.factor);var r=this._uniforms;r.u_factor=o,gl.disable(gl.DEPTH_TEST),e.drawTo((function(){t.bind(0),i.uniforms(r).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,e)}else this.setOutputData(0,t)},P.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_factor;\n\t\tvec2 barrelDistortion(vec2 coord, float amt) {\n\t\t\tvec2 cc = coord - 0.5;\n\t\t\tfloat dist = dot(cc, cc);\n\t\t\treturn coord + cc * dist * amt;\n\t\t}\n\t\t\n\t\tfloat sat( float t )\n\t\t{\n\t\t\treturn clamp( t, 0.0, 1.0 );\n\t\t}\n\t\t\n\t\tfloat linterp( float t ) {\n\t\t\treturn sat( 1.0 - abs( 2.0*t - 1.0 ) );\n\t\t}\n\t\t\n\t\tfloat remap( float t, float a, float b ) {\n\t\t\treturn sat( (t - a) / (b - a) );\n\t\t}\n\t\t\n\t\tvec4 spectrum_offset( float t ) {\n\t\t\tvec4 ret;\n\t\t\tfloat lo = step(t,0.5);\n\t\t\tfloat hi = 1.0-lo;\n\t\t\tfloat w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n\t\t\tret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n\t\t\n\t\t\treturn pow( ret, vec4(1.0/2.2) );\n\t\t}\n\t\t\n\t\tconst float max_distort = 2.2;\n\t\tconst int num_iter = 12;\n\t\tconst float reci_num_iter_f = 1.0 / float(num_iter);\n\t\t\n\t\tvoid main()\n\t\t{\t\n\t\t\tvec2 uv=v_coord;\n\t\t\tvec4 sumcol = vec4(0.0);\n\t\t\tvec4 sumw = vec4(0.0);\t\n\t\t\tfor ( int i=0; i<num_iter;++i )\n\t\t\t{\n\t\t\t\tfloat t = float(i) * reci_num_iter_f;\n\t\t\t\tvec4 w = spectrum_offset( t );\n\t\t\t\tsumw += w;\n\t\t\t\tsumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n\t\t\t}\n\t\t\tgl_FragColor = sumcol / sumw;\n\t\t}",e.registerNodeType("texture/lensfx",P),M.title="Data->Tex",M.desc="Generates or applies a curve to a texture",M.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},M.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var e=this.properties.channels,i=this.properties.width,o=this.properties.height;i&&o||(i=Math.floor(t.length/e),o=1);var r=gl.RGBA;3==e?r=gl.RGB:1==e&&(r=gl.LUMINANCE);var n=this._temp_texture,a=s.getTextureType(this.properties.precision);n&&n.width==i&&n.height==o&&n.type==a||(n=this._temp_texture=new GL.Texture(i,o,{type:a,format:r,filter:gl.LINEAR})),n.uploadData(t),this.setOutputData(0,n)}}},e.registerNodeType("texture/fromdata",M),G.title="Curve",G.desc="Generates or applies a curve to a texture",G.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},G.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0),e=this._temp_texture;if(!t)return!this._must_update&&this._curve_texture||this.updateCurve(),void this.setOutputData(0,this._curve_texture);var i=s.getTextureType(this.properties.precision,t);e&&e.type==i&&e.width==t.width&&e.height==t.height&&e.format==t.format||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:i,format:t.format,filter:gl.LINEAR}));var o=G._shader;o||(o=G._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,G.pixel_shader)),!this._must_update&&this._curve_texture||this.updateCurve();var r=this._uniforms,n=this._curve_texture;e.drawTo((function(){gl.disable(gl.DEPTH_TEST),t.bind(0),n.bind(1),o.uniforms(r).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,e)}},G.prototype.sampleCurve=function(t,e){if(e=e||this._points.RGB){for(var i=0;i<e.length-1;++i){var s=e[i],o=e[i+1];if(!(o[0]<t)){var r=o[0]-s[0];if(Math.abs(r)<1e-5)return s[1];var n=(t-s[0])/r;return s[1]*(1-n)+o[1]*n}}return 0}},G.prototype.updateCurve=function(){for(var t=this._values,e=t.length/4,i=this.properties.split_channels,s=0;s<e;++s){if(i)t[4*s]=Math.clamp(255*this.sampleCurve(s/e,this._points.R),0,255),t[4*s+1]=Math.clamp(255*this.sampleCurve(s/e,this._points.G),0,255),t[4*s+2]=Math.clamp(255*this.sampleCurve(s/e,this._points.B),0,255);else{var o=this.sampleCurve(s/e);t[4*s]=t[4*s+1]=t[4*s+2]=Math.clamp(255*o,0,255)}t[4*s+3]=255}this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(t,null,!0)},G.prototype.onSerialize=function(t){var e={};for(var i in this._points)e[i]=this._points[i].concat();t.curves=e},G.prototype.onConfigure=function(t){this._points=t.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},G.prototype.onMouseDown=function(t,e,i){if(this.curve_editor){var s=this.curve_editor.onMouseDown([e[0],e[1]-this.curve_offset],i);return s&&this.captureInput(!0),s}},G.prototype.onMouseMove=function(t,e,i){if(this.curve_editor)return this.curve_editor.onMouseMove([e[0],e[1]-this.curve_offset],i)},G.prototype.onMouseUp=function(t,e,i){if(this.curve_editor)return this.curve_editor.onMouseUp([e[0],e[1]-this.curve_offset],i);this.captureInput(!1)},G.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},G.prototype.onDrawBackground=function(t,i){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new e.CurveEditor(this._points.R)),t.save(),t.translate(0,this.curve_offset);var s=this.widgets[1].value;this.properties.split_channels?("RGB"==s&&(this.widgets[1].value=s="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],i,"#111",G.channel_line_colors.R,!0),t.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],i,null,G.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],i,null,G.channel_line_colors.B,!0),t.globalCompositeOperation="source-over"):(this.widgets[1].value=s="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[s],this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],i,this.properties.split_channels?null:"#111",G.channel_line_colors[s]),t.restore()}},G.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_curve;\n\t\tuniform float u_range;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord ) * u_range;\n\t\t\tcolor.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;\n\t\t\tcolor.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;\n\t\t\tcolor.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;\n\t\t\t//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;\n\t\t\tgl_FragColor = color;\n\t\t}",e.registerNodeType("texture/curve",G),z.title="Exposition",z.desc="Controls texture exposition",z.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:s.MODE_VALUES}},z.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var i=z._shader;i||(i=z._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,z.pixel_shader)),this.properties.exposition;var s=this.getInputData(1);null!=s&&(this.properties.exposition=s);var o=this._uniforms;e.drawTo((function(){gl.disable(gl.DEPTH_TEST),t.bind(0),i.uniforms(o).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,e)}},z.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_exposition;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\tgl_FragColor = vec4( color.xyz * u_exposition, color.a );\n\t\t}",e.registerNodeType("texture/exposition",z),F.title="Tone Mapping",F.desc="Applies Tone Mapping to convert from high to low",F.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},F.prototype.onGetInputs=function(){return[["enabled","boolean"]]},F.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0))if(this.properties.precision!==s.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){var e=this._temp_texture;e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR}));var i=this.getInputData(1);null==i&&(i=this.properties.average_lum);var o=this._uniforms,r=null;i.constructor===Number?(this.properties.average_lum=i,o.u_average_lum=this.properties.average_lum,(r=F._shader)||(r=F._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,F.pixel_shader))):i.constructor===GL.Texture&&(o.u_average_texture=i.bind(1),(r=F._shader_texture)||(r=F._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,F.pixel_shader,{AVG_TEXTURE:""}))),o.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,o.u_scale=this.properties.scale,o.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),e.drawTo((function(){t.bind(0),r.uniforms(o).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,this._temp_texture)}else this.setOutputData(0,t)},F.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_scale;\n\t\t#ifdef AVG_TEXTURE\n\t\t\tuniform sampler2D u_average_texture;\n\t\t#else\n\t\t\tuniform float u_average_lum;\n\t\t#endif\n\t\tuniform float u_lumwhite2;\n\t\tuniform float u_igamma;\n\t\tvec3 RGB2xyY (vec3 rgb)\n\t\t{\n\t\t\t const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n\t\t\t\t\t\t\t\t\t   0.2126, 0.7152, 0.0722,\n\t\t\t\t\t\t\t\t\t   0.0193, 0.1192, 0.9505);\n\t\t\tvec3 XYZ = RGB2XYZ * rgb;\n\t\t\t\n\t\t\tfloat f = (XYZ.x + XYZ.y + XYZ.z);\n\t\t\treturn vec3(XYZ.x / f,\n\t\t\t\t\t\tXYZ.y / f,\n\t\t\t\t\t\tXYZ.y);\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\tvec3 rgb = color.xyz;\n\t\t\tfloat average_lum = 0.0;\n\t\t\t#ifdef AVG_TEXTURE\n\t\t\t\tvec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;\n\t\t\t\taverage_lum = (pixel.x + pixel.y + pixel.z) / 3.0;\n\t\t\t#else\n\t\t\t\taverage_lum = u_average_lum;\n\t\t\t#endif\n\t\t\t//Ld - this part of the code is the same for both versions\n\t\t\tfloat lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n\t\t\tfloat L = (u_scale / average_lum) * lum;\n\t\t\tfloat Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n\t\t\t//first\n\t\t\t//vec3 xyY = RGB2xyY(rgb);\n\t\t\t//xyY.z *= Ld;\n\t\t\t//rgb = xyYtoRGB(xyY);\n\t\t\t//second\n\t\t\trgb = (rgb / lum) * Ld;\n\t\t\trgb = max(rgb,vec3(0.001));\n\t\t\trgb = pow( rgb, vec3( u_igamma ) );\n\t\t\tgl_FragColor = vec4( rgb, color.a );\n\t\t}",e.registerNodeType("texture/tonemapping",F),B.title="Perlin",B.desc="Generates a perlin noise texture",B.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},B.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},B.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=0|this.properties.width,e=0|this.properties.height;0==t&&(t=gl.viewport_data[2]),0==e&&(e=gl.viewport_data[3]);var i=s.getTextureType(this.properties.precision),o=this._texture;o&&o.width==t&&o.height==e&&o.type==i||(o=this._texture=new GL.Texture(t,e,{type:i,format:gl.RGB,filter:gl.LINEAR}));var r=this.getInputOrProperty("persistence"),n=this.getInputOrProperty("octaves"),a=this.getInputOrProperty("offset"),u=this.getInputOrProperty("scale"),h=this.getInputOrProperty("amplitude"),p=this.getInputOrProperty("seed"),l=""+t+e+i+r+n+u+p+a[0]+a[1]+h;if(l!=this._key){this._key=l;var d=this._uniforms;d.u_persistence=r,d.u_octaves=n,d.u_offset.set(a),d.u_scale=u,d.u_amplitude=h,d.u_seed=128*p,d.u_viewport[0]=t,d.u_viewport[1]=e;var c=B._shader;c||(c=B._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,B.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),o.drawTo((function(){c.uniforms(d).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,o)}else this.setOutputData(0,o)}},B.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_offset;\n\t\tuniform float u_scale;\n\t\tuniform float u_persistence;\n\t\tuniform int u_octaves;\n\t\tuniform float u_amplitude;\n\t\tuniform vec2 u_viewport;\n\t\tuniform float u_seed;\n\t\t#define M_PI 3.14159265358979323846\n\t\t\n\t\tfloat rand(vec2 c){\treturn fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n\t\t\n\t\tfloat noise(vec2 p, float freq ){\n\t\t\tfloat unit = u_viewport.x/freq;\n\t\t\tvec2 ij = floor(p/unit);\n\t\t\tvec2 xy = mod(p,unit)/unit;\n\t\t\t//xy = 3.*xy*xy-2.*xy*xy*xy;\n\t\t\txy = .5*(1.-cos(M_PI*xy));\n\t\t\tfloat a = rand((ij+vec2(0.,0.)));\n\t\t\tfloat b = rand((ij+vec2(1.,0.)));\n\t\t\tfloat c = rand((ij+vec2(0.,1.)));\n\t\t\tfloat d = rand((ij+vec2(1.,1.)));\n\t\t\tfloat x1 = mix(a, b, xy.x);\n\t\t\tfloat x2 = mix(c, d, xy.x);\n\t\t\treturn mix(x1, x2, xy.y);\n\t\t}\n\t\t\n\t\tfloat pNoise(vec2 p, int res){\n\t\t\tfloat persistance = u_persistence;\n\t\t\tfloat n = 0.;\n\t\t\tfloat normK = 0.;\n\t\t\tfloat f = 4.;\n\t\t\tfloat amp = 1.0;\n\t\t\tint iCount = 0;\n\t\t\tfor (int i = 0; i<50; i++){\n\t\t\t\tn+=amp*noise(p, f);\n\t\t\t\tf*=2.;\n\t\t\t\tnormK+=amp;\n\t\t\t\tamp*=persistance;\n\t\t\t\tif (iCount >= res)\n\t\t\t\t\tbreak;\n\t\t\t\tiCount++;\n\t\t\t}\n\t\t\tfloat nf = n/normK;\n\t\t\treturn nf*nf*nf*nf;\n\t\t}\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n\t\t\tvec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n\t\t\tgl_FragColor = color;\n\t\t}",e.registerNodeType("texture/perlin",B),H.title="Canvas2D",H.desc="Executes Canvas2D code inside a texture or the viewport.",H.help="Set width and height to 0 to match viewport size.",H.default_code="//vars: canvas,ctx,time\nctx.fillStyle='red';\nctx.fillRect(0,0,50,50);\n",H.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},H.prototype.onPropertyChanged=function(t,e){"code"==t&&this.compileCode(e)},H.prototype.compileCode=function(t){if(this._func=null,e.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",t),this.boxcolor="#00FF00"}catch(t){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(t)}},H.prototype.onExecute=function(){var t=this._func;t&&this.isOutputConnected(0)&&this.executeDraw(t)},H.prototype.executeDraw=function(e){var i=this.properties.width||gl.canvas.width,o=this.properties.height||gl.canvas.height,r=this._temp_texture,n=s.getTextureType(this.properties.precision);r&&r.width==i&&r.height==o&&r.type==n||(r=this._temp_texture=new GL.Texture(i,o,{format:gl.RGBA,filter:gl.LINEAR,type:n}));var a=this.getInputData(0),u=this.properties,h=this,p=this.graph.getTime(),l=gl,d=gl.canvas;if(!this.properties.use_html_canvas&&t.enableWebGLCanvas||(this._canvas?(d=this._canvas,l=this._ctx):(d=this._canvas=createCanvas(i.height),l=this._ctx=d.getContext("2d")),d.width=i,d.height=o),l==gl)r.drawTo((function(){gl.start2D(),u.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{e.draw?e.draw.call(h,d,l,p,e,a):e.call(h,d,l,p,e,a),h.boxcolor="#00FF00"}catch(t){h.boxcolor="#FF0000",console.error("Error executing script"),console.error(t)}gl.finish2D()}));else{u.clear&&l.clearRect(0,0,d.width,d.height);try{e.draw?e.draw.call(this,d,l,p,e,a):e.call(this,d,l,p,e,a),this.boxcolor="#00FF00"}catch(t){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(t)}r.uploadImage(d)}this.setOutputData(0,r)},e.registerNodeType("texture/canvas2D",H),U.title="Matte",U.desc="Extracts background",U.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:s.MODE_VALUES}},U.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision!==s.PASS_THROUGH){if(t){this._tex=s.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var e=this._uniforms,i=Mesh.getScreenQuad(),o=U._shader;o||(o=U._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,U.pixel_shader)),e.u_key_color=this.properties.key_color,e.u_threshold=this.properties.threshold,e.u_slope=this.properties.slope,this._tex.drawTo((function(){t.bind(0),o.uniforms(e).draw(i)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,t)}},U.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec3 u_key_color;\n\t\tuniform float u_threshold;\n\t\tuniform float u_slope;\n\t\t\n\t\tvoid main() {\n\t\t\tvec3 color = texture2D( u_texture, v_coord ).xyz;\n\t\t\tfloat diff = length( normalize(color) - normalize(u_key_color) );\n\t\t\tfloat edge = u_threshold * (1.0 - u_slope);\n\t\t\tfloat alpha = smoothstep( edge, u_threshold, diff);\n\t\t\tgl_FragColor = vec4( color, alpha );\n\t\t}",e.registerNodeType("texture/matte",U),V.title="CubemapToTexture2D",V.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",V.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t&&t.texture_type==GL.TEXTURE_CUBE_MAP){!this._last_tex||this._last_tex.height==t.height&&this._last_tex.type==t.type||(this._last_tex=null);var e=this.getInputOrProperty("yaw");this._last_tex=GL.Texture.cubemapToTexture2D(t,t.height,this._last_tex,!0,e),this.setOutputData(0,this._last_tex)}}},e.registerNodeType("texture/cubemapToTexture2D",V))}(this),function(t){if("undefined"!=typeof GL){var e=t.LiteGraph,i=(t.LGraphCanvas,"#345"),s=e.Shaders={},o=(s.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"],s.GLSL_types_const=["float","vec2","vec3","vec4"]),r={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},n={},a=[];d(),s.ALL_TYPES="float,vec2,vec3,vec4",s.registerShaderNode=c,s.getInputLinkID=g,s.getOutputLinkID=f,s.getShaderNodeVarName=_,s.parseGLSLDescriptions=d;var u=e.valueToGLSL=function(t,e,i){var s=5;if(null!=i&&(s=i),!e)if(t.constructor===Number)e="float";else{if(!t.length)throw"unknown type for glsl value: "+t.constructor;switch(t.length){case 2:e="vec2";break;case 3:e="vec3";break;case 4:e="vec4";break;case 9:e="mat3";break;case 16:e="mat4";break;default:throw"unknown type for glsl value size"}}switch(e){case"float":return t.toFixed(s);case"vec2":return"vec2("+t[0].toFixed(s)+","+t[1].toFixed(s)+")";case"color3":case"vec3":return"vec3("+t[0].toFixed(s)+","+t[1].toFixed(s)+","+t[2].toFixed(s)+")";case"color4":case"vec4":return"vec4("+t[0].toFixed(s)+","+t[1].toFixed(s)+","+t[2].toFixed(s)+","+t[3].toFixed(s)+")";case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw e}return""},h=e.varToTypeGLSL=function(t,e,i){if(e==i)return t;if(null==t)switch(i){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!i)throw"error: no output type specified";if("float"==i)switch(e){case"vec2":case"vec3":case"vec4":return t+".x";default:return"0.0"}else if("vec2"==i)switch(e){case"float":return"vec2("+t+")";case"vec3":case"vec4":return t+".xy";default:return"vec2(0.0)"}else if("vec3"==i)switch(e){case"float":return"vec3("+t+")";case"vec2":return"vec3("+t+",0.0)";case"vec4":return t+".xyz";default:return"vec3(0.0)"}else if("vec4"==i)switch(e){case"float":return"vec4("+t+")";case"vec2":return"vec4("+t+",0.0,1.0)";case"vec3":return"vec4("+t+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw"type cannot be converted"},l=e.convertVarToGLSLType=function(t,e,i){if(e==i)return t;if("float"==e)return i+"("+t+")";if("vec2"==i)return"vec2("+t+".xy)";if("vec3"==i){if("vec2"==e)return"vec3("+t+",0.0)";if("vec4"==e)return"vec4("+t+".xyz)"}if("vec4"==i){if("vec2"==e)return"vec4("+t+",0.0,0.0)";if("vec3"==i)return"vec4("+t+",1.0)"}return null};v.prototype.clear=function(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}},v.prototype.addUniform=function(t,e,i){this._uniforms[t]=e,null!=i&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[t]=i)},v.prototype.addFunction=function(t,e){this._functions[t]=e},v.prototype.addCode=function(t,e,i){for(var s in i=i||{"":""}){var o=s?s+"_"+t:t;this._codeparts[o]?this._codeparts[o]+=e+"\n":this._codeparts[o]=e+"\n"}},v.prototype.computeCodeBlocks=function(t,e){this.clear();var i=t.findNodesByType("shader::output/vertex");i=i&&i.length?i[0]:null;var s=t.findNodesByType("shader::output/fragcolor");if(!(s=s&&s.length?s[0]:null))return null;t.sendEventToAllNodes("clearDestination"),i&&i.propagateDestination("vs"),s&&s.propagateDestination("fs"),t.sendEventToAllNodes("onGetCode",this);var o="";for(var r in this._uniforms)o+="uniform "+this._uniforms[r]+" "+r+";\n";if(e)for(var r in e)o+="uniform "+e[r]+" "+r+";\n";var n="";for(var r in this._functions)n+="//"+r+"\n"+this._functions[r]+"\n";var a=this._codeparts;return a.uniforms=o,a.functions=n,a},v.prototype.computeShaderCode=function(t){var e=this.computeCodeBlocks(t);return{vs_code:GL.Shader.replaceCodeUsingContext(this.vs_template,e),fs_code:GL.Shader.replaceCodeUsingContext(this.fs_template,e)}},v.prototype.computeShader=function(t,i){var s=this.computeShaderCode(t);if(console.log(s.vs_code,s.fs_code),!e.catch_exceptions)return this._shader_error=!0,i?i.updateShader(s.vs_code,s.fs_code):i=new GL.Shader(s.vs_code,s.fs_code),this._shader_error=!1,i;try{return i?i.updateShader(s.vs_code,s.fs_code):i=new GL.Shader(s.vs_code,s.fs_code),this._shader_error=!1,i}catch(t){return this._shader_error||(console.error(t),-1!=t.indexOf("Fragment shader")?console.log(s.fs_code.split("\n").map((function(t,e){return e+".- "+t})).join("\n")):console.log(s.vs_code)),this._shader_error=!0,null}return null},v.prototype.getShader=function(t){if(this._shader&&this._shader._version==t._version)return this._shader;var e=this.computeShader(t,this._shader);return e?(this._shader=e,e._version=t._version,e):null},v.prototype.fillUniforms=function(t,e){if(this._uniform_value)for(var i in this._uniform_value){var s=this._uniform_value[i];null!=s&&(s.constructor===Function?t[i]=s.call(this,e):s.constructor===GL.Texture||(t[i]=s))}},e.ShaderContext=e.Shaders.Context=v,m.template="\n#define FRAGMENT\nprecision highp float;\nvarying vec2 v_coord;\n{{varying}}\n{{uniforms}}\n{{functions}}\n{{fs_functions}}\nvoid main() {\n\nvec2 uv = v_coord;\nvec4 fragcolor = vec4(0.0);\nvec4 fragcolor1 = vec4(0.0);\n{{fs_code}}\ngl_FragColor = fragcolor;\n}\n\t",m.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},m.title="ShaderGraph",m.desc="Builds a shader using a graph",m.input_node_type="input/uniform",m.output_node_type="output/fragcolor",m.title_color=i,m.prototype.onSerialize=function(t){t.subgraph=this.subgraph.serialize()},m.prototype.onConfigure=function(t){this.subgraph.configure(t.subgraph)},m.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);t&&t.constructor!=GL.Texture&&(t=null);var e=0|this.properties.width,i=0|this.properties.height;0==e&&(e=t?t.width:gl.viewport_data[2]),0==i&&(i=t?t.height:gl.viewport_data[3]);var s=LGraphTexture.getTextureType(this.properties.precision,t),o=this._texture;o&&o.width==e&&o.height==i&&o.type==s||(o=this._texture=new GL.Texture(e,i,{type:s,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR}));var r=this.getShader(this.subgraph);if(r){var n=this._uniforms;this._context.fillUniforms(n);var a=0;if(this.inputs)for(var u=0;u<this.inputs.length;++u){var h=this.inputs[u],p=this.getInputData(u);"texture"==h.type&&(p||(p=GL.Texture.getWhiteTexture()),p=p.bind(a++)),null!=p&&(n["u_"+h.name]=p)}var l=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),o.drawTo((function(){r.uniforms(n),r.draw(l)})),this.setOutputData(0,o)}}},m.prototype.onInputAdded=function(t){var i=e.createNode("shader::input/uniform");i.setProperty("name",t.name),i.setProperty("type",t.type),this.subgraph.add(i)},m.prototype.onInputRemoved=function(t,e){for(var i=this.subgraph.findNodesByType("shader::input/uniform"),s=0;s<i.length;++s){var o=i[s];o.properties.name==e.name&&this.subgraph.remove(o)}},m.prototype.computeSize=function(){var t=this.inputs?this.inputs.length:0,i=this.outputs?this.outputs.length:0;return[200,Math.max(t,i)*e.NODE_SLOT_HEIGHT+e.NODE_TITLE_HEIGHT+10]},m.prototype.getShader=function(){var t=this._context.getShader(this.subgraph);return this.boxcolor=t?null:"red",t},m.prototype.onDrawBackground=function(t,i,s,o){if(!this.flags.collapsed){var r=this.getOutputData(0),n=this.inputs?this.inputs.length*e.NODE_SLOT_HEIGHT:0;r&&t==r.gl&&this.size[1]>n+e.NODE_TITLE_HEIGHT&&t.drawImage(r,10,a,this.size[0]-20,this.size[1]-n-e.NODE_TITLE_HEIGHT);var a=this.size[1]-e.NODE_TITLE_HEIGHT+.5,u=e.isInsideRectangle(o[0],o[1],this.pos[0],this.pos[1]+a,this.size[0],e.NODE_TITLE_HEIGHT);t.fillStyle=u?"#555":"#222",t.beginPath(),this._shape==e.BOX_SHAPE?t.rect(0,a,this.size[0]+1,e.NODE_TITLE_HEIGHT):t.roundRect(0,a,this.size[0]+1,e.NODE_TITLE_HEIGHT,0,8),t.fill(),t.textAlign="center",t.font="24px Arial",t.fillStyle=u?"#DDD":"#999",t.fillText("+",.5*this.size[0],a+24)}},m.prototype.onMouseDown=function(t,i,s){var o=this.size[1]-e.NODE_TITLE_HEIGHT+.5;i[1]>o&&s.showSubgraphPropertiesDialog(this)},m.prototype.onDrawSubgraphBackground=function(t){},m.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Print Code",callback:function(){var t=e._context.computeShaderCode();console.log(t.vs_code,t.fs_code)}}]},e.registerNodeType("texture/shaderGraph",m),y.title="Uniform",y.desc="Input data for the shader",y.prototype.getTitle=function(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"},y.prototype.onPropertyChanged=function(t,e){this.outputs[0].name=this.properties.type+" "+this.properties.name},y.prototype.onGetCode=function(t){if(this.shader_destination){var e=this.properties.type;if(!e){if(!t.onGetPropertyInfo)return;var i=t.onGetPropertyInfo(this.property.name);if(!i)return;e=i.type}"number"==e?e="float":"texture"==e&&(e="sampler2D"),-1!=s.GLSL_types.indexOf(e)&&(t.addUniform("u_"+this.properties.name,e),this.setOutputData(0,e))}},y.prototype.getOutputVarName=function(t){return"u_"+this.properties.name},c("input/uniform",y),x.title="Attribute",x.desc="Input data from mesh attribute",x.prototype.getTitle=function(){return"att. "+this.properties.name},x.prototype.onGetCode=function(t){if(this.shader_destination){var e=this.properties.type;e&&-1!=s.GLSL_types.indexOf(e)&&("number"==e&&(e="float"),"coord"!=this.properties.name&&t.addCode("varying"," varying "+e+" v_"+this.properties.name+";"),this.setOutputData(0,e))}},x.prototype.getOutputVarName=function(t){return"v_"+this.properties.name},c("input/attribute",x),b.title="Sampler2D",b.desc="Reads a pixel from a texture",b.prototype.onGetCode=function(t){if(this.shader_destination){var e=g(this,0),i=_(this),s="vec4 "+i+" = vec4(0.0);\n";e&&(s+=i+" = texture2D("+e+","+(g(this,1)||t.buffer_names.uvs)+");\n"),f(this,0)&&(s+="vec4 "+f(this,0)+" = "+i+";\n"),f(this,1)&&(s+="vec3 "+f(this,1)+" = "+i+".xyz;\n"),t.addCode("code",s,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3")}},c("texture/sampler2D",b),T.title="const",T.prototype.getTitle=function(){return this.flags.collapsed?u(this.properties.value,this.properties.type,2):"Const"},T.prototype.onPropertyChanged=function(t,e){"type"==t&&(this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e),this.widgets.length=1,this.updateWidgets()),"value"==t&&(e.length?(this.widgets[1].value=e[1],e.length>2&&(this.widgets[2].value=e[2]),e.length>3&&(this.widgets[3].value=e[3])):this.widgets[1].value=e)},T.prototype.updateWidgets=function(t){var e=this,i=(t=this.properties.value,{step:.01});switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=t&&2==t.length?[t[0],t[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],(function(t){e.properties.value[0]=t}),i),this.addWidget("number","y",this.properties.value[1],(function(t){e.properties.value[1]=t}),i);break;case"vec3":this.properties.value=t&&3==t.length?[t[0],t[1],t[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],(function(t){e.properties.value[0]=t}),i),this.addWidget("number","y",this.properties.value[1],(function(t){e.properties.value[1]=t}),i),this.addWidget("number","z",this.properties.value[2],(function(t){e.properties.value[2]=t}),i);break;case"vec4":this.properties.value=t&&4==t.length?[t[0],t[1],t[2],t[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],(function(t){e.properties.value[0]=t}),i),this.addWidget("number","y",this.properties.value[1],(function(t){e.properties.value[1]=t}),i),this.addWidget("number","z",this.properties.value[2],(function(t){e.properties.value[2]=t}),i),this.addWidget("number","w",this.properties.value[3],(function(t){e.properties.value[3]=t}),i);break;default:console.error("unknown type for constant")}},T.prototype.onGetCode=function(t){if(this.shader_destination){var e=u(this.properties.value,this.properties.type),i=f(this,0);if(i){var s="\t"+this.properties.type+" "+i+" = "+e+";";t.addCode("code",s,this.shader_destination),this.setOutputData(0,this.properties.type)}}},c("const/const",T),E.title="vec2",E.varmodes=["xy","x","y"],E.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},E.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=_(this),s="\tvec2 "+i+" = "+u([e.x,e.y])+";\n",r=0;r<E.varmodes.length;++r){var n=E.varmodes[r],a=g(this,r);a&&(s+="\t"+i+"."+n+" = "+a+";\n")}for(r=0;r<E.varmodes.length;++r){n=E.varmodes[r];var h=f(this,r);if(h){var p=o[n.length-1];s+="\t"+p+" "+h+" = "+i+"."+n+";\n",this.setOutputData(r,p)}}t.addCode("code",s,this.shader_destination)}},c("const/vec2",E),w.title="vec3",w.varmodes=["xyz","x","y","z","xy","xz","yz"],w.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},w.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=_(this),s="vec3 "+i+" = "+u([e.x,e.y,e.z])+";\n",r=0;r<w.varmodes.length;++r){var n=w.varmodes[r],a=g(this,r);a&&(s+="\t"+i+"."+n+" = "+a+";\n")}for(r=0;r<w.varmodes.length;++r){n=w.varmodes[r];var h=f(this,r);if(h){var p=o[n.length-1];s+="\t"+p+" "+h+" = "+i+"."+n+";\n",this.setOutputData(r,p)}}t.addCode("code",s,this.shader_destination)}},c("const/vec3",w),I.title="vec4",I.varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"],I.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},I.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=_(this),s="vec4 "+i+" = "+u([e.x,e.y,e.z,e.w])+";\n",r=0;r<I.varmodes.length;++r){var n=I.varmodes[r],a=g(this,r);a&&(s+="\t"+i+"."+n+" = "+a+";\n")}for(r=0;r<I.varmodes.length;++r){n=I.varmodes[r];var h=f(this,r);if(h){var p=o[n.length-1];s+="\t"+p+" "+h+" = "+i+"."+n+";\n",this.setOutputData(r,p)}}t.addCode("code",s,this.shader_destination)}},c("const/vec4",I),O.title="FragColor",O.desc="Pixel final color",O.prototype.onGetCode=function(t){var e=g(this,0);if(e){var i=this.getInputData(0),s=h(e,i,"vec4");t.addCode("fs_code","fragcolor = "+s+";")}},c("output/fragcolor",O),D.title="Operation",D.operations=["+","-","*","/"],D.prototype.getTitle=function(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"},D.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],i=0;i<3;++i)e.push({name:g(this,i),type:this.getInputData(i)||"float"});var s=f(this,0);if(s){var o=e[0].type,r=o,n=this.properties.operation,a=[];for(i=0;i<2;++i){var u=e[i].name;null==u&&(u=null!=p.value?p.value:"(1.0)",e[i].type="float"),e[i].type!=o&&("float"!=e[i].type||"*"!=n&&"/"!=n)&&(u=l(u,e[i].type,o)),a.push(u)}t.addCode("code",r+" "+s+" = "+a[0]+n+a[1]+";",this.shader_destination),this.setOutputData(0,r)}}},c("math/operation",D),N.title="Func",N.prototype.onPropertyChanged=function(t,e){if(this.graph&&this.graph._version++,"func"==t){var i=n[e];if(!i)return;for(var o=i.params.length;o<this.inputs.length;++o)this.removeInput(o);for(o=0;o<i.params.length;++o){var r=i.params[o];this.inputs[o]?this.inputs[o].name=r.name+(r.value?" ("+r.value+")":""):this.addInput(r.name,s.ALL_TYPES)}}},N.prototype.getTitle=function(){return this.flags.collapsed?this.properties.func:"Func"},N.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],i=0;i<3;++i)e.push({name:g(this,i),type:this.getInputData(i)||"float"});var s=f(this,0);if(s){var o=n[this.properties.func];if(o){var r=e[0].type,a=o.return_type;"T"==a&&(a=r);var u=[];for(i=0;i<o.params.length;++i){var h=o.params[i],p=e[i].name;null==p&&(p=null!=h.value?h.value:"(1.0)",e[i].type="float"),("T"==h.type&&e[i].type!=r||"T"!=h.type&&e[i].type!=r)&&(p=l(p,e[i].type,r)),u.push(p)}t.addFunction("round","float round(float v){ return floor(v+0.5); }\nvec2 round(vec2 v){ return floor(v+vec2(0.5));}\nvec3 round(vec3 v){ return floor(v+vec3(0.5));}\nvec4 round(vec4 v){ return floor(v+vec4(0.5)); }\n"),t.addCode("code",a+" "+s+" = "+o.func+"("+u.join(",")+");",this.shader_destination),this.setOutputData(0,a)}}}},c("math/func",N),S.title="Snippet",S.prototype.onPropertyChanged=function(t,e){this.graph&&this.graph._version++,"type"==t&&this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e)},S.prototype.getTitle=function(){return this.flags.collapsed?this.properties.code:"Snippet"},S.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=g(this,0);e||(e="1.0");var i=g(this,1);i||(i="1.0");var s=f(this,0);if(s){var o=this.getInputData(0)||"float",r=this.getInputData(1)||"float",n=this.properties.type;if("T"==o||"T"==r)return null;var a="funcSnippet"+this.id,u="\n"+n+" "+a+"( "+o+" A, "+r+" B) {\n";u+="\t"+n+" C = "+n+"(0.0);\n",u+="\t"+this.properties.code+";\n",u+="\treturn C;\n}\n",t.addCode("functions",u,this.shader_destination),t.addCode("code",n+" "+s+" = "+a+"("+e+","+i+");",this.shader_destination),this.setOutputData(0,n)}}},c("utils/snippet",S),C.title="Rand",C.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=f(this,0);t.addUniform("u_rand"+this.id,"float",(function(){return Math.random()})),t.addCode("code","float "+e+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},c("input/rand",C),A.NOISE_TYPES=["noise","rand"],A.title="noise",A.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=g(this,0),i=f(this,0),s=this.getInputData(0);e||(s="vec2",e=t.buffer_names.uvs),t.addFunction("noise",A.shader_functions),t.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),"float"==s?t.addCode("code","float "+i+" = snoise( vec2("+e+") * u_noise_scale"+this.id+");",this.shader_destination):"vec2"==s||"vec3"==s?t.addCode("code","float "+i+" = snoise("+e+" * u_noise_scale"+this.id+");",this.shader_destination):"vec4"==s&&t.addCode("code","float "+i+" = snoise("+e+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float")}},c("math/noise",A),A.shader_functions="\nvec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }\n\nfloat snoise(vec2 v){\n  const vec4 C = vec4(0.211324865405187, 0.366025403784439,-0.577350269189626, 0.024390243902439);\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod(i, 289.0);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n  + i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );\n}\n\nvec3 hash3( vec2 p ){\n    vec3 q = vec3( dot(p,vec2(127.1,311.7)), \n\t\t\t\t   dot(p,vec2(269.5,183.3)), \n\t\t\t\t   dot(p,vec2(419.2,371.9)) );\n\treturn fract(sin(q)*43758.5453);\n}\nvec4 hash4( vec3 p ){\n    vec4 q = vec4( dot(p,vec3(127.1,311.7,257.3)), \n\t\t\t\t   dot(p,vec3(269.5,183.3,335.1)), \n\t\t\t\t   dot(p,vec3(314.5,235.1,467.3)), \n\t\t\t\t   dot(p,vec3(419.2,371.9,114.9)) );\n\treturn fract(sin(q)*43758.5453);\n}\n\nfloat iqnoise( in vec2 x, float u, float v ){\n    vec2 p = floor(x);\n    vec2 f = fract(x);\n\t\n\tfloat k = 1.0+63.0*pow(1.0-v,4.0);\n\t\n\tfloat va = 0.0;\n\tfloat wt = 0.0;\n    for( int j=-2; j<=2; j++ )\n    for( int i=-2; i<=2; i++ )\n    {\n        vec2 g = vec2( float(i),float(j) );\n\t\tvec3 o = hash3( p + g )*vec3(u,u,1.0);\n\t\tvec2 r = g - f + o.xy;\n\t\tfloat d = dot(r,r);\n\t\tfloat ww = pow( 1.0-smoothstep(0.0,1.414,sqrt(d)), k );\n\t\tva += o.z*ww;\n\t\twt += ww;\n    }\n\t\n    return va/wt;\n}\n",L.title="Time",L.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=f(this,0);t.addUniform("u_time"+this.id,"float",(function(){return.001*getTime()})),t.addCode("code","float "+e+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},c("input/time",L),k.title="Dither",k.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=g(this,0),i=f(this,0),s=this.getInputData(0);e=h(e,s,"float"),t.addFunction("dither8x8",k.dither_func),t.addCode("code","float "+i+" = dither8x8("+e+");",this.shader_destination),this.setOutputData(0,"float")}},k.dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375],k.dither_func="\n\t\tfloat dither8x8(float brightness) {\n\t\t  vec2 position = vec2(0.0);\n\t\t  #ifdef FRAGMENT\n\t\t\tposition = gl_FragCoord.xy;\n\t\t  #endif\n\t\t  int x = int(mod(position.x, 8.0));\n\t\t  int y = int(mod(position.y, 8.0));\n\t\t  int index = x + y * 8;\n\t\t  float limit = 0.0;\n\t\t  if (x < 8) {\n\t\t\tif(index==0) limit = 0.015625;\n\t\t\t"+k.dither_values.map((function(t,e){return"else if(index== "+(e+1)+") limit = "+t+";"})).join("\n")+"\n\t\t  }\n\t\t  return brightness < limit ? 0.0 : 1.0;\n\t\t}\n",c("math/dither",k),R.title="Remap",R.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},R.prototype.onConnectionsChange=function(){var t=this.getInputDataType(0);this.outputs[0].type=t||"T"},R.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=g(this,0),i=f(this,0);if(e||i){var s=this.getInputDataType(0);if(this.outputs[0].type=s,"T"!=s)if(e){var o=u(this.properties.min_value),r=u(this.properties.max_value),n=u(this.properties.min_value2),a=u(this.properties.max_value2);t.addCode("code",s+" "+i+" = ( ("+e+" - "+o+") / ("+r+" - "+o+") ) * ("+a+" - "+n+") + "+n+";",this.shader_destination),this.setOutputData(0,s)}else t.addCode("code","\t"+s+" "+i+" = "+s+"(0.0);\n");else console.warn("node type is T and cannot be resolved")}}},c("math/remap",R)}function d(){for(var t in a.length=0,r){var e=r[t],i=e.indexOf(" "),s=e.substr(0,i),o=e.indexOf("(",i),u=e.substr(i,o-i).trim(),h=e.substr(o+1,e.length-o-2).split(",");for(var p in h){var l=h[p].split(" ").filter((function(t){return t}));h[p]={type:l[0].trim(),name:l[1].trim()},"="==l[2]&&(h[p].value=l[3].trim())}n[t]={return_type:s,func:u,params:h},a.push(u)}}function c(t,s){s.color=i,s.filter="shader",s.prototype.clearDestination=function(){this.shader_destination={}},s.prototype.propagateDestination=function(t){if(this.shader_destination[t]=!0,this.inputs)for(var e=0;e<this.inputs.length;++e){var i=this.getInputNode(e);i&&i.propagateDestination(t)}},s.prototype.onPropertyChanged||(s.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),e.registerNodeType("shader::"+t,s)}function _(t,e){return"VAR_"+(e||"TEMP")+"_"+t.id}function g(t,e){if(!t.inputs)return null;var i=t.getInputLink(e);if(!i)return null;var s=t.graph.getNodeById(i.origin_id);return s?s.getOutputVarName?s.getOutputVarName(i.origin_slot):"link_"+s.id+"_"+i.origin_slot:null}function f(t,e){return t.isOutputConnected(e)?"link_"+t.id+"_"+e:null}function v(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}function m(){this.subgraph=new e.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:"undefined"!=typeof LGraphTexture?LGraphTexture.DEFAULT:2};var t=this.subgraph.findNodesByType("shader::input/uniform")[0];t.pos=[200,300];var i=e.createNode("shader::texture/sampler2D");i.pos=[400,300],this.subgraph.add(i);var s=e.createNode("shader::output/fragcolor");s.pos=[600,300],this.subgraph.add(s),t.connect(0,i),i.connect(0,s),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new v,this._context.vs_template="#define VERTEX\n"+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=m.template}function y(){this.addOutput("out",""),this.properties={name:"",type:""}}function x(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}function b(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}function T(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:o,property:"type"}),this.updateWidgets()}function E(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}function w(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}function I(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}function O(){this.addInput("color",s.ALL_TYPES),this.block_delete=!0}function D(){this.addInput("A",s.ALL_TYPES),this.addInput("B",s.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:D.operations})}function N(){this.addInput("A",s.ALL_TYPES),this.addInput("B",s.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:a})}function S(){this.addInput("A",s.ALL_TYPES),this.addInput("B",s.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}function C(){this.addOutput("out","float")}function A(){this.addInput("out",s.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:A.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}function L(){this.addOutput("out","float")}function k(){this.addInput("in","T"),this.addOutput("out","float")}function R(){this.addInput("",s.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}}(this),function(t){var e=t.LiteGraph,s=new Float32Array(16),o=new Float32Array(16),r=new Float32Array(16),n=new Float32Array(16),a={u_view:s,u_projection:o,u_viewprojection:r,u_model:n};function u(){return 1e5*Math.random()|0}function h(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:h.SPHERE,force_update:!1},this.points=new Float32Array(3*this.properties.num_points),this.normals=new Float32Array(3*this.properties.num_points),this.must_update=!0,this.version=0;var t=this;this.addWidget("button","update",null,(function(){t.must_update=!0})),this.geometry={vertices:null,_id:u()},this._old_obj=null,this._last_radius=null}function p(t,e){var i=t.length,s=0,o=0,r=i;if(0==i)return-1;if(1==i)return 0;for(;r>=s;){var n=t[o=.5*(r+s)|0];if(n==e)return o;if(s==r-1)return s;n<e?s=o:r=o}return o}function l(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}function d(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:u(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}function c(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:u()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}function _(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}function g(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}function f(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}function v(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}function m(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}function y(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}function x(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=1e5*Math.random()|0,this.last_info={type:-1,size:-1,subdivisions:-1}}function b(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}e.LGraphRender={onRequestCameraMatrices:null},t.LGraphPoints3D=h,h.RECTANGLE=1,h.CIRCLE=2,h.CUBE=10,h.SPHERE=11,h.HEMISPHERE=12,h.INSIDE_SPHERE=13,h.OBJECT=20,h.OBJECT_UNIFORMLY=21,h.OBJECT_INSIDE=22,h.MODE_VALUES={rectangle:h.RECTANGLE,circle:h.CIRCLE,cube:h.CUBE,sphere:h.SPHERE,hemisphere:h.HEMISPHERE,inside_sphere:h.INSIDE_SPHERE,object:h.OBJECT,object_uniformly:h.OBJECT_UNIFORMLY,object_inside:h.OBJECT_INSIDE},h.widgets_info={mode:{widget:"combo",values:h.MODE_VALUES}},h.title="list of points",h.desc="returns an array of points",h.prototype.onPropertyChanged=function(t,e){this.must_update=!0},h.prototype.onExecute=function(){var t=this.getInputData(0);(t!=this._old_obj||t&&t._version!=this._old_obj_version)&&(this._old_obj=t,this.must_update=!0);var e=this.getInputData(1);null==e&&(e=this.properties.radius),this._last_radius!=e&&(this._last_radius=e,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)},h.prototype.updatePoints=function(){var t=0|this.properties.num_points;t<1&&(t=1),this.points&&this.points.length==3*t||(this.points=new Float32Array(3*t)),this.properties.generate_normals?this.normals&&this.normals.length==this.points.length||(this.normals=new Float32Array(this.points.length)):this.normals=null;var e=this._last_radius||this.properties.radius,i=this.properties.mode,s=this.getInputData(0);this._old_obj_version=s?s._version:null,this.points=h.generatePoints(e,t,i,this.points,this.normals,this.properties.regular,s),this.version++},h.generatePoints=function(t,e,i,s,o,r,n){var a=3*e;s&&s.length==a||(s=new Float32Array(a));var u=new Float32Array(3),p=new Float32Array([0,1,0]);if(r){if(i==h.RECTANGLE){for(var l=Math.floor(Math.sqrt(e)),d=0;d<l;++d)for(var c=0;c<l;++c)s[_=3*d+3*c*l]=(d/l-.5)*t*2,s[_+1]=0,s[_+2]=(c/l-.5)*t*2;if(s=new Float32Array(s.subarray(0,l*l*3)),o)for(d=0;d<o.length;d+=3)o.set(p,d)}else if(i==h.SPHERE){for(l=Math.floor(Math.sqrt(e)),d=0;d<l;++d)for(c=0;c<l;++c){var _=3*d+3*c*l;polarToCartesian(u,d/l*2*Math.PI,2*(c/l-.5)*Math.PI,t),s[_]=u[0],s[_+1]=u[1],s[_+2]=u[2]}s=new Float32Array(s.subarray(0,l*l*3)),o&&h.generateSphericalNormals(s,o)}else if(i==h.CIRCLE){for(d=0;d<a;d+=3){var g=2*Math.PI*(d/a);s[d]=Math.cos(g)*t,s[d+1]=0,s[d+2]=Math.sin(g)*t}if(o)for(d=0;d<o.length;d+=3)o.set(p,d)}}else if(i==h.RECTANGLE){for(d=0;d<a;d+=3)s[d]=(Math.random()-.5)*t*2,s[d+1]=0,s[d+2]=(Math.random()-.5)*t*2;if(o)for(d=0;d<o.length;d+=3)o.set(p,d)}else if(i==h.CUBE){for(d=0;d<a;d+=3)s[d]=(Math.random()-.5)*t*2,s[d+1]=(Math.random()-.5)*t*2,s[d+2]=(Math.random()-.5)*t*2;if(o)for(d=0;d<o.length;d+=3)o.set(p,d)}else i==h.SPHERE?(h.generateSphere(s,a,t),o&&h.generateSphericalNormals(s,o)):i==h.HEMISPHERE?(h.generateHemisphere(s,a,t),o&&h.generateSphericalNormals(s,o)):i==h.CIRCLE?(h.generateInsideCircle(s,a,t),o&&h.generateSphericalNormals(s,o)):i==h.INSIDE_SPHERE?(h.generateInsideSphere(s,a,t),o&&h.generateSphericalNormals(s,o)):i==h.OBJECT?h.generateFromObject(s,o,a,n,!1):i==h.OBJECT_UNIFORMLY?h.generateFromObject(s,o,a,n,!0):i==h.OBJECT_INSIDE?h.generateFromInsideObject(s,a,n):console.warn("wrong mode in LGraphPoints3D");return s},h.generateSphericalNormals=function(t,e){for(var i=new Float32Array(3),s=0;s<e.length;s+=3)i[0]=t[s],i[1]=t[s+1],i[2]=t[s+2],vec3.normalize(i,i),e.set(i,s)},h.generateSphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),r=Math.random(),n=2*Math.cos(2*Math.PI*o)*Math.sqrt(r*(1-r)),a=1-2*r,u=2*Math.sin(2*Math.PI*o)*Math.sqrt(r*(1-r));t[s]=n*i,t[s+1]=a*i,t[s+2]=u*i}},h.generateHemisphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),r=Math.random(),n=Math.cos(2*Math.PI*o)*Math.sqrt(1-r*r),a=r,u=Math.sin(2*Math.PI*o)*Math.sqrt(1-r*r);t[s]=n*i,t[s+1]=a*i,t[s+2]=u*i}},h.generateInsideCircle=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),r=Math.random(),n=Math.cos(2*Math.PI*o)*Math.sqrt(1-r*r),a=Math.sin(2*Math.PI*o)*Math.sqrt(1-r*r);t[s]=n*i,t[s+1]=0,t[s+2]=a*i}},h.generateInsideSphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),r=Math.random(),n=2*o*Math.PI,a=Math.acos(2*r-1),u=Math.cbrt(Math.random())*i,h=Math.sin(n),p=Math.cos(n),l=Math.sin(a),d=Math.cos(a);t[s]=u*l*p,t[s+1]=u*l*h,t[s+2]=u*d}},h.generateFromObject=function(t,e,i,s,o){if(s){var r=null,n=null,a=null,u=null;if(s.constructor===GL.Mesh&&(r=s.vertexBuffers.vertices.data,n=s.vertexBuffers.normals?s.vertexBuffers.normals.data:null,(a=s.indexBuffers.indices?s.indexBuffers.indices.data:null)||(a=s.indexBuffers.triangles?s.indexBuffers.triangles.data:null)),!r)return null;var h=a?a.length/3:r.length/9,l=0;if(o){u=new Float32Array(h);for(var d=0;d<h;++d){a?(T=3*a[3*d],E=3*a[3*d+1],w=3*a[3*d+2]):(T=9*d,E=9*d+3,w=9*d+6);var c=r.subarray(T,T+3),_=r.subarray(E,E+3),g=r.subarray(w,w+3),f=vec3.distance(c,_),v=vec3.distance(_,g),m=vec3.distance(g,c),y=(f+v+m)/2;l+=Math.sqrt(y*(y-f)*(y-v)*(y-m)),u[d]=l}for(d=0;d<h;++d)u[d]/=l}for(d=0;d<i;d+=3){var x=Math.random(),b=o?p(u,x):Math.floor(x*h),T=0,E=0,w=0;a?(T=3*a[3*b],E=3*a[3*b+1],w=3*a[3*b+2]):(T=9*b,E=9*b+3,w=9*b+6),y=Math.random();var I=Math.random(),O=Math.sqrt(y),D=1-O,N=O*(1-I),S=I*O;if(t[d]=D*r[T]+N*r[E]+S*r[w],t[d+1]=D*r[T+1]+N*r[E+1]+S*r[w+1],t[d+2]=D*r[T+2]+N*r[E+2]+S*r[w+2],e&&n){e[d]=D*n[T]+N*n[E]+S*n[w],e[d+1]=D*n[T+1]+N*n[E+1]+S*n[w+1],e[d+2]=D*n[T+2]+N*n[E+2]+S*n[w+2];var C=e.subarray(d,d+3);vec3.normalize(C,C)}}}},h.generateFromInsideObject=function(t,e,i){if(i&&i.constructor===GL.Mesh){var s=i.getBoundingBox();i.octree||(i.octree=new GL.Octree(i));for(var o=i.octree,r=vec3.create(),n=vec3.fromValues(1,0,0),a=vec3.create(),u=0,h=0;u<e&&h<10*t.length;){h+=1;var p=vec3.random(a);p[0]=(2*p[0]-1)*s[3]+s[0],p[1]=(2*p[1]-1)*s[4]+s[1],p[2]=(2*p[2]-1)*s[5]+s[2],r.set(p);var l=o.testRay(r,n,0,1e4,!0,GL.Octree.ALL);l&&l.length%2!=0&&(t.set(p,u),u+=3)}}},e.registerNodeType("geometry/points3D",h),l.NORMAL=0,l.VERTICAL=1,l.SPHERICAL=2,l.RANDOM=3,l.RANDOM_VERTICAL=4,l.modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4},l.widgets_info={mode:{widget:"combo",values:l.modes}},l.title="points to inst",l.prototype.onExecute=function(){var t=this.getInputData(0);t?this.isOutputConnected(0)&&(((t._version!=this._version||t._id!=this._geometry_id)&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(t)),this.setOutputData(0,this.matrices)):this.setOutputData(0,null)},l.prototype.updateInstances=function(t){var e=t.vertices;if(!e)return null;var i=t.normals,s=this.matrices,o=e.length/3;s.length!=o&&(s.length=o);for(var r=mat4.create(),n=vec3.create(),a=(vec3.create(),vec3.fromValues(0,1,0)),u=vec3.fromValues(0,0,-1),h=(vec3.fromValues(1,0,0),quat.create()),p=vec3.create(),d=vec3.create(),c=vec3.create(),_=0;_<e.length;_+=3){var g=_/3,f=s[g];f||(f=s[g]=mat4.create()),f.set(r);var v=e.subarray(_,_+3);switch(this.properties.mode){case l.NORMAL:if(mat4.setTranslation(f,v),i){var m=i.subarray(_,_+3);c.set(m),vec3.normalize(c,c),vec3.cross(d,u,c),vec3.normalize(d,d),vec3.cross(p,d,c),vec3.normalize(p,p),f.set(d,0),f.set(c,4),f.set(p,8),mat4.setTranslation(f,v)}break;case l.VERTICAL:mat4.setTranslation(f,v);break;case l.SPHERICAL:p.set(v),vec3.normalize(p,p),vec3.cross(d,a,p),vec3.normalize(d,d),vec3.cross(c,p,d),vec3.normalize(c,c),f.set(d,0),f.set(c,4),f.set(p,8),mat4.setTranslation(f,v);break;case l.RANDOM:n[0]=2*Math.random()-1,n[1]=2*Math.random()-1,n[2]=2*Math.random()-1,vec3.normalize(n,n),quat.setAxisAngle(h,n,2*Math.random()*Math.PI),mat4.fromQuat(f,h),mat4.setTranslation(f,v);break;case l.RANDOM_VERTICAL:quat.setAxisAngle(h,a,2*Math.random()*Math.PI),mat4.fromQuat(f,h),mat4.setTranslation(f,v)}}this._version=t._version,this._geometry_id=t._id},e.registerNodeType("geometry/points_to_instances",l),d.title="Transform",d.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);if(t)if(t.constructor!==Array){if(t.vertices&&t.vertices.length){var i=t;if(this.outputs[0].type="geometry",this.isOutputConnected(0))if(e){var s=typedArrayToArray(e).join(",");(this.must_update||i._id!=this._last_geometry_id||i._version!=this._last_version||s!=this._last_key)&&(this.updateGeometry(i,e),this._last_key=s,this._last_version=i._version,this._last_geometry_id=i._id,this.must_update=!1),this.setOutputData(0,this.geometry)}else this.setOutputData(0,i)}}else{if(0==t.length)return;if(this.outputs[0].type="[mat4]",!this.isOutputConnected(0))return;if(!e)return void this.setOutputData(0,t);this._output||(this._output=new Array),this._output.length!=t.length&&(this._output.length=t.length);for(var o=0;o<t.length;++o){var r=this._output[o];r||(r=this._output[o]=mat4.create()),mat4.multiply(r,t[o],e)}this.setOutputData(0,this._output)}},d.prototype.updateGeometry=function(t,e){var i=t.vertices,s=this.geometry.vertices;s&&s.length==i.length||(s=this.geometry.vertices=new Float32Array(i.length));for(var o=vec3.create(),r=0,n=s.length;r<n;r+=3)o[0]=i[r],o[1]=i[r+1],o[2]=i[r+2],mat4.multiplyVec3(o,e,o),s[r]=o[0],s[r+1]=o[1],s[r+2]=o[2];if(t.normals){this.geometry.normals&&this.geometry.normals.length==t.normals.length||(this.geometry.normals=new Float32Array(t.normals.length));var a=this.geometry.normals,u=mat4.invert(mat4.create(),e);u&&mat4.transpose(u,u);var h=t.normals;for(r=0,n=a.length;r<n;r+=3)o[0]=h[r],o[1]=h[r+1],o[2]=h[r+2],mat4.multiplyVec3(o,u,o),a[r]=o[0],a[r+1]=o[1],a[r+2]=o[2]}this.geometry.type=t.type,this.geometry._version++},e.registerNodeType("geometry/transform",d),c.title="Polygon",c.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputOrProperty("sides"),e=this.getInputOrProperty("radius");t=0|Math.max(3,t),this.last_info.sides==t&&this.last_info.radius==e||this.updateGeometry(t,e),this.setOutputData(0,this.geometry)}},c.prototype.updateGeometry=function(t,e){var i=3*t,s=this.geometry.vertices;s&&s.length==i||(s=this.geometry.vertices=new Float32Array(3*t));var o=2*Math.PI/t;this.properties.uvs&&(uvs=this.geometry.coords=new Float32Array(3*t));for(var r=0;r<t;++r){var n=o*-r,a=Math.cos(n)*e,u=Math.sin(n)*e;s[3*r]=a,s[3*r+1]=0,s[3*r+2]=u}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=t,this.last_info.radius=e},e.registerNodeType("geometry/polygon",c),_.title="extrude",_.prototype.onPropertyChanged=function(t,e){this._must_update=!0},_.prototype.onExecute=function(){var t=this.getInputData(0);t&&this.isOutputConnected(0)&&((t.version!=this._last_geo_version||this._must_update)&&(this._geo=this.extrudeGeometry(t,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))},_.prototype.extrudeGeometry=function(t){var e=t.vertices,i=e.length/3,s=vec3.create(),o=vec3.create(),r=vec3.create(),n=vec3.create(),a=new Float32Array(this.properties.offset);if("line_loop"==t.type)for(var h=new Float32Array(6*i*3),p=0,l=0,d=e.length;l<d;l+=3)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],l+3<d?(o[0]=e[l+3],o[1]=e[l+4],o[2]=e[l+5]):(o[0]=e[0],o[1]=e[1],o[2]=e[2]),vec3.add(r,s,a),vec3.add(n,o,a),h.set(s,p),p+=3,h.set(o,p),p+=3,h.set(r,p),p+=3,h.set(o,p),p+=3,h.set(n,p),p+=3,h.set(r,p),p+=3;return{_id:u(),type:"triangles",vertices:h}},e.registerNodeType("geometry/extrude",_),g.title="geoeval",g.desc="eval code",g.widgets_info={code:{widget:"code"}},g.prototype.onConfigure=function(t){this.compileCode()},g.prototype.compileCode=function(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch(t){this.boxcolor="red"}},g.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.compileCode())},g.prototype.onExecute=function(){var t=this.getInputData(0);if(t)if(this.func){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=t._id,this.properties.execute_every_frame?this.version++:this.version=t._version;var e=this.func,i=getTime();for(var s in this.geometry||(this.geometry={}),t)null!=t[s]&&(t[s].constructor==Float32Array?this.geometry[s]=new Float32Array(t[s]):this.geometry[s]=t[s]);this.geometry._id=t._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=t._version+1;var o=vec3.create(),r=this.vertices;for(r&&this.vertices.length==t.vertices.length?r.set(t.vertices):r=this.vertices=new Float32Array(t.vertices),s=0;s<r.length;s+=3)o[0]=r[s],o[1]=r[s+1],o[2]=r[s+2],e(o,s/3,i),r[s]=o[0],r[s+1]=o[1],r[s+2]=o[2];this.geometry.vertices=r}this.setOutputData(0,this.geometry)}else this.setOutputData(0,t)},e.registerNodeType("geometry/eval",g),f.title="connect points",f.desc="adds indices between near points",f.prototype.onPropertyChanged=function(t,e){this.must_update=!0},f.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update){for(var e in this.must_update=!1,this.geometry_id=t._id,this.version=t._version,this.geometry={},t)this.geometry[e]=t[e];this.geometry._id=u(),this.geometry._version=this.my_version++;var i=t.vertices,s=i.length,o=this.properties.min_dist,r=this.properties.max_dist,n=this.properties.probability,a=this.properties.max_connections,h=[];for(e=0;e<s;e+=3)for(var p=i[e],l=i[e+1],d=i[e+2],c=0,_=e+3;_<s;_+=3){var g=i[_],f=i[_+1],v=i[_+2],m=Math.sqrt((p-g)*(p-g)+(l-f)*(l-f)+(d-v)*(d-v));if(!(m>r||m<o||n<1&&n<Math.random())&&(h.push(e/3,_/3),c+=1,a&&c>a))break}this.geometry.indices=this.indices=new Uint32Array(h)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}},e.registerNodeType("geometry/connectPoints",f),"undefined"!=typeof GL&&(v.title="to geometry",v.desc="converts a mesh to geometry",v.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(t!=this.last_mesh){for(i in this.last_mesh=t,t.vertexBuffers){var e=t.vertexBuffers[i];this.geometry[i]=e.data}t.indexBuffers.triangles&&(this.geometry.indices=t.indexBuffers.triangles.data),this.geometry._id=u(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}},e.registerNodeType("geometry/toGeometry",v),m.title="Geo to Mesh",m.prototype.updateMesh=function(t){for(var e in this.mesh||(this.mesh=new GL.Mesh),t)if("_"!=e[0]){var i=t[e],s=GL.Mesh.common_buffers[e];if(s||"indices"==e){var o=s?s.spacing:3,r=this.mesh.vertexBuffers[e];r&&r.data.length==i.length?(r.data.set(i),r.upload(GL.DYNAMIC_DRAW)):r=new GL.Buffer("indices"==e?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,i,o,GL.DYNAMIC_DRAW),this.mesh.addBuffer(e,r)}}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){var n=new Float32Array([0,1,0]),a=new Float32Array(this.mesh.vertexBuffers.vertices.data.length);for(e=0;e<a.length;e+=3)a.set(n,e);r=new GL.Buffer(GL.ARRAY_BUFFER,a,3),this.mesh.addBuffer("normals",r)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version,this.mesh},m.prototype.onExecute=function(){var t=this.getInputData(0);t&&(this.version==t._version&&this.geometry_id==t._id||this.updateMesh(t),this.setOutputData(0,this.mesh))},e.registerNodeType("geometry/toMesh",m),y.title="Render Mesh",y.desc="renders a mesh flat",y.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP},y.widgets_info={primitive:{widget:"combo",values:y.PRIMITIVE_VALUES},color:{widget:"color"}},y.prototype.onExecute=function(){if(this.properties.enabled){var t=this.getInputData(0);if(t)if(e.LGraphRender.onRequestCameraMatrices){e.LGraphRender.onRequestCameraMatrices(s,o,r);var i=null;this.getInputData(2)?(i=gl.shaders.textured)||(i=gl.shaders.textured=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_TEXTURE:""})):(i=gl.shaders.flat)||(i=gl.shaders.flat=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code)),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var n=this.model_matrix,u=this.getInputData(1);u?n.set(u):mat4.identity(n),this.uniforms.u_point_size=1;var h=this.properties.primitive;i.uniforms(a),i.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var p="indices";t.indexBuffers.triangles&&(p="triangles"),i.draw(t,h,p),gl.disable(gl.BLEND),gl.depthMask(!0)}else console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph")}},e.registerNodeType("geometry/render_mesh",y),x.title="Primitive",x.VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9},x.widgets_info={type:{widget:"combo",values:x.VALID}},x.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputOrProperty("size");this.last_info.type==this.properties.type&&this.last_info.size==t&&this.last_info.subdivisions==this.properties.subdivisions||this.updateMesh(this.properties.type,t,this.properties.subdivisions),this.setOutputData(0,this._mesh)}},x.prototype.updateMesh=function(t,e,i){switch(i=0|Math.max(0,i),t){case 1:this._mesh=GL.Mesh.cube({size:e,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:e,xz:!0,detail:i,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:e,subdivisions:i,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:e,long:i,lat:i,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:e,slices:i,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:e,long:i,lat:i,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:e,subdivisions:i});break;case 8:this._mesh=GL.Mesh.cone({radius:e,height:e,subdivisions:i});break;case 9:this._mesh=GL.Mesh.plane({size:e,xz:!1,detail:i,normals:!0,coords:!0})}this.last_info.type=t,this.last_info.size=e,this.last_info.subdivisions=i,this._mesh.version=this.version++},e.registerNodeType("geometry/mesh_primitive",x),b.title="renderPoints",b.desc="render points with a texture",b.widgets_info={color:{widget:"color"}},b.prototype.updateMesh=function(t){this.buffer,this.buffer&&this.buffer.data&&this.buffer.data.length==t.vertices.length?(this.buffer.data.set(t.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)):this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,t.vertices,3,GL.DYNAMIC_DRAW),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version},b.prototype.onExecute=function(){if(this.properties.enabled){var t=this.getInputData(0);if(t)if(this.version==t._version&&this.geometry_id==t._id||this.updateMesh(t),e.LGraphRender.onRequestCameraMatrices){e.LGraphRender.onRequestCameraMatrices(s,o,r);var i=null;this.getInputData(2)?(i=gl.shaders.textured_points)||(i=gl.shaders.textured_points=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_TEXTURED_POINTS:""})):(i=gl.shaders.points)||(i=gl.shaders.points=new GL.Shader(b.vertex_shader_code,b.fragment_shader_code,{USE_POINTS:""})),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var u=this.getInputData(1);u?n.set(u):mat4.identity(n),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*o[5],i.uniforms(a),i.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),i.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)}else console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph")}},e.registerNodeType("geometry/render_points",b),b.vertex_shader_code="\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tvarying vec3 v_vertex;\n\t\tattribute vec3 a_normal;\n\t\tvarying vec3 v_normal;\n\t\t#ifdef USE_COLOR\n\t\t\tattribute vec4 a_color;\n\t\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\t#ifdef USE_SIZE\n\t\t\tattribute float a_extra;\n\t\t#endif\n\t\t#ifdef USE_INSTANCING\n\t\t\tattribute mat4 u_model;\n\t\t#else\n\t\t\tuniform mat4 u_model;\n\t\t#endif\n\t\tuniform mat4 u_viewprojection;\n\t\tuniform float u_point_size;\n\t\tuniform float u_perspective;\n\t\tuniform float u_point_perspective;\n\t\tfloat computePointSize(float radius, float w)\n\t\t{\n\t\t\tif(radius < 0.0)\n\t\t\t\treturn -radius;\n\t\t\treturn u_perspective * radius / w;\n\t\t}\n\t\tvoid main() {\n\t\t\tv_coord = a_coord;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tv_color = a_color;\n\t\t\t#endif\n\t\t\tv_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\tv_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;\n\t\t\tgl_Position = u_viewprojection * vec4(v_vertex,1.0);\n\t\t\tgl_PointSize = u_point_size;\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tgl_PointSize = a_extra;\n\t\t\t#endif\n\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t}\t",b.fragment_shader_code="\t\tprecision mediump float;\n\t\tuniform vec4 u_color;\n\t\t#ifdef USE_COLOR\n\t\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color;\n\t\t\t#ifdef USE_TEXTURED_POINTS\n\t\t\t\tcolor *= texture2D(u_texture, gl_PointCoord.xy);\n\t\t\t#else\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t\tfloat dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tgl_FragColor = color;\n\t\t}\t")}(this),function(t){var e=t.LiteGraph,i=t.LGraphTexture;if("undefined"!=typeof GL){function s(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:i.DEFAULT},s._shader||(s._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,s.pixel_shader),s._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}function o(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}function r(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:i.DEFAULT}}function n(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:i.DEFAULT},n._shader||(n._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,n.pixel_shader))}s.title="Lens",s.desc="Camera Lens distortion",s.widgets_info={precision:{widget:"combo",values:i.MODE_VALUES}},s.prototype.onExecute=function(){var t=this.getInputData(0);if(this.properties.precision!==i.PASS_THROUGH){if(t){this._tex=i.getTargetTexture(t,this._tex,this.properties.precision);var e=this.properties.aberration;this.isInputConnected(1)&&(e=this.getInputData(1),this.properties.aberration=e);var o=this.properties.distortion;this.isInputConnected(2)&&(o=this.getInputData(2),this.properties.distortion=o);var r=this.properties.blur;this.isInputConnected(3)&&(r=this.getInputData(3),this.properties.blur=r),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var n=Mesh.getScreenQuad(),a=s._shader;this._tex.drawTo((function(){t.bind(0),a.uniforms({u_texture:0,u_aberration:e,u_distortion:o,u_blur:r}).draw(n)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,t)},s.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_aberration;\n\t\t\tuniform float u_distortion;\n\t\t\tuniform float u_blur;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = v_coord;\n\t\t\t\tfloat dist = distance(vec2(0.5), coord);\n\t\t\t\tvec2 dist_coord = coord - vec2(0.5);\n\t\t\t\tfloat percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n\t\t\t\tdist_coord *= percent;\n\t\t\t\tcoord = dist_coord + vec2(0.5);\n\t\t\t\tvec4 color = texture2D(u_texture,coord, u_blur * dist);\n\t\t\t\tcolor.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n\t\t\t\tcolor.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t",e.registerNodeType("fx/lens",s),t.LGraphFXLens=s,o.title="Bokeh",o.desc="applies an Bokeh effect",o.widgets_info={shape:{widget:"texture"}},o.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),s=this.getInputData(2);if(t&&s&&this.properties.shape){e||(e=t);var r=i.getTexture(this.properties.shape);if(r){var n=this.properties.threshold;this.isInputConnected(3)&&(n=this.getInputData(3),this.properties.threshold=n);var a=gl.UNSIGNED_BYTE;this.properties.high_precision&&(a=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==a&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:a,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size;var u=o._first_shader;u||(u=o._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,o._first_pixel_shader));var h=o._second_shader;h||(h=o._second_shader=new GL.Shader(o._second_vertex_shader,o._second_pixel_shader));var p=this._points_mesh;p&&p._width==t.width&&p._height==t.height&&2==p._spacing||(p=this.createPointsMesh(t.width,t.height,2));var l=Mesh.getScreenQuad(),d=this.properties.size,c=(this.properties.min_light,this.properties.alpha);gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo((function(){t.bind(0),e.bind(1),s.bind(2),u.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[t.width,t.height]}).draw(l)})),this._temp_texture.drawTo((function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),t.bind(0),r.bind(3),h.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:c,u_threshold:n,u_pointSize:d,u_itexsize:[1/t.width,1/t.height]}).draw(p,gl.POINTS)})),this.setOutputData(0,this._temp_texture)}}else this.setOutputData(0,t)},o.prototype.createPointsMesh=function(t,e,i){for(var s=Math.round(t/i),o=Math.round(e/i),r=new Float32Array(s*o*2),n=-1,a=2/t*i,u=2/e*i,h=0;h<o;++h){for(var p=-1,l=0;l<s;++l){var d=h*s*2+2*l;r[d]=p,r[d+1]=n,p+=a}n+=u}return this._points_mesh=GL.Mesh.load({vertices2D:r}),this._points_mesh._width=t,this._points_mesh._height=e,this._points_mesh._spacing=i,this._points_mesh},o._first_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_blur;\n\t\t\tuniform sampler2D u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 blurred_color = texture2D(u_texture_blur, v_coord);\n\t\t\t\tfloat mask = texture2D(u_mask, v_coord).x;\n\t\t\t   gl_FragColor = mix(color, blurred_color, mask);\n\t\t\t}\n\t\t\t",o._second_vertex_shader="precision highp float;\n\t\t\tattribute vec2 a_vertex2D;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_mask;\n\t\t\tuniform vec2 u_itexsize;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform float u_threshold;\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = a_vertex2D * 0.5 + 0.5;\n\t\t\t\tv_color = texture2D( u_texture, coord );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n\t\t\t\tv_color += texture2D( u_texture, coord + u_itexsize);\n\t\t\t\tv_color *= 0.25;\n\t\t\t\tfloat mask = texture2D(u_mask, coord).x;\n\t\t\t\tfloat luminance = length(v_color) * mask;\n\t\t\t\t/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n\t\t\t\tluminance -= u_threshold;\n\t\t\t\tif(luminance < 0.0)\n\t\t\t\t{\n\t\t\t\t\tgl_Position.x = -100.0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\tgl_Position = vec4(a_vertex2D,0.0,1.0);\n\t\t\t}\n\t\t\t",o._second_pixel_shader="precision highp float;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_shape;\n\t\t\tuniform float u_alpha;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_shape, gl_PointCoord );\n\t\t\t\tcolor *= v_color * u_alpha;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",e.registerNodeType("fx/bokeh",o),t.LGraphFXBokeh=o,r.title="FX",r.desc="applies an FX from a list",r.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:i.MODE_VALUES}},r.shaders={},r.prototype.onExecute=function(){if(this.isOutputConnected(0)){var e=this.getInputData(0);if(this.properties.precision!==i.PASS_THROUGH){if(e){this._tex=i.getTargetTexture(e,this._tex,this.properties.precision);var s=this.properties.value1;this.isInputConnected(1)&&(s=this.getInputData(1),this.properties.value1=s);var o=this.properties.value2;this.isInputConnected(2)&&(o=this.getInputData(2),this.properties.value2=o);var n=this.properties.fx,a=r.shaders[n];if(!a){var u=r["pixel_shader_"+n];if(!u)return;a=r.shaders[n]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,u)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var h,p=Mesh.getScreenQuad(),l=t.LS?LS.Renderer._current_camera:null;h=l?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100];var d=null;"noise"==n&&(d=i.getNoiseTexture()),this._tex.drawTo((function(){e.bind(0),"noise"==n&&d.bind(1),a.uniforms({u_texture:0,u_noise:1,u_size:[e.width,e.height],u_rand:[Math.random(),Math.random()],u_value1:s,u_value2:o,u_camera_planes:h}).draw(p)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,e)}},r.pixel_shader_halftone="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tfloat pattern() {\n\t\t\t\tfloat s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_size.xy;\n\t\t\t\tvec2 point = vec2(\n\t\t\t\t   c * tex.x - s * tex.y ,\n\t\t\t\t   s * tex.x + c * tex.y \n\t\t\t\t) * u_value2;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\n\t\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n\t\t\t}\n",r.pixel_shader_pixelate="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n\t\t\t\tvec4 color = texture2D(u_texture, coord);\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",r.pixel_shader_lowpalette="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tgl_FragColor = floor(color * u_value1) / u_value1;\n\t\t\t}\n",r.pixel_shader_noise="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_noise;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\tuniform vec2 u_rand;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n\t\t\t\tgl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n\t\t\t}\n",r.pixel_shader_gamma="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_value1;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat gamma = 1.0 / u_value1;\n\t\t\t\tgl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n\t\t\t}\n",e.registerNodeType("fx/generic",r),t.LGraphFXGeneric=r,n.title="Vigneting",n.desc="Vigneting",n.widgets_info={precision:{widget:"combo",values:i.MODE_VALUES}},n.prototype.onExecute=function(){var t=this.getInputData(0);if(this.properties.precision!==i.PASS_THROUGH){if(t){this._tex=i.getTargetTexture(t,this._tex,this.properties.precision);var e=this.properties.intensity;this.isInputConnected(1)&&(e=this.getInputData(1),this.properties.intensity=e),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var s=Mesh.getScreenQuad(),o=n._shader,r=this.properties.invert;this._tex.drawTo((function(){t.bind(0),o.uniforms({u_texture:0,u_intensity:e,u_isize:[1/t.width,1/t.height],u_invert:r?1:0}).draw(s)})),this.setOutputData(0,this._tex)}}else this.setOutputData(0,t)},n.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_intensity;\n\t\t\tuniform int u_invert;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tluminance = 1.0 - luminance;\n\t\t\t\tluminance = mix(1.0, luminance, u_intensity);\n\t\t\t   gl_FragColor = vec4( luminance * color.xyz, color.a);\n\t\t\t}\n\t\t\t",e.registerNodeType("fx/vigneting",n),t.LGraphFXVigneting=n}}(this),function(t){var e=t.LiteGraph,i="#243";function s(t){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),t&&this.setup(t)}for(var o in e.MIDIEvent=s,s.prototype.fromJSON=function(t){this.setup(t.data)},s.prototype.setup=function(t){var e=t;t.constructor===Object&&(e=t.data),this.data.set(e);var i=e[0];this.status=i;var o=240&i;this.cmd=i>=240?i:o,this.cmd==s.NOTEON&&0==this.velocity&&(this.cmd=s.NOTEOFF),this.cmd_str=s.commands[this.cmd]||"",(o>=s.NOTEON||o<=s.NOTEOFF)&&(this.channel=15&i)},Object.defineProperty(s.prototype,"velocity",{get:function(){return this.cmd==s.NOTEON?this.data[2]:-1},set:function(t){this.data[2]=t},enumerable:!0}),s.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],s.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(s.prototype,"note",{get:function(){return this.cmd!=s.NOTEON?-1:s.toNoteString(this.data[1],!0)},set:function(t){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(s.prototype,"octave",{get:function(){if(this.cmd!=s.NOTEON)return-1;var t=this.data[1]-24;return Math.floor(t/12+1)},set:function(t){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),s.prototype.getPitch=function(){return 440*Math.pow(2,(this.data[1]-69)/12)},s.computePitch=function(t){return 440*Math.pow(2,(t-69)/12)},s.prototype.getCC=function(){return this.data[1]},s.prototype.getCCValue=function(){return this.data[2]},s.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},s.computePitchBend=function(t,e){return t+(e<<7)-8192},s.prototype.setCommandFromString=function(t){this.cmd=s.computeCommandFromString(t)},s.computeCommandFromString=function(t){if(!t)return 0;if(t&&t.constructor===Number)return t;switch(t=t.toUpperCase()){case"NOTE ON":case"NOTEON":return s.NOTEON;case"NOTE OFF":case"NOTEOFF":return s.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return s.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return s.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return s.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return s.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return s.PITCHBEND;case"TIME TICK":case"TIMETICK":return s.TIMETICK;default:return Number(t)}},s.toNoteString=function(t,e){var i=(t=Math.round(t))-21,o=Math.floor((t-24)/12+1);return(i%=12)<0&&(i=12+i),s.notes[i]+(e?"":o)},s.NoteStringToPitch=function(t){var e=(t=t.toUpperCase())[0],i=4;"#"==t[1]?(e+="#",t.length>2&&(i=Number(t[2]))):t.length>1&&(i=Number(t[1]));var o=s.note_to_index[e];return null==o?null:12*(i-1)+o+21},s.prototype.toString=function(){var t=this.channel+". ";switch(this.cmd){case s.NOTEON:t+="NOTEON "+s.toNoteString(this.data[1]);break;case s.NOTEOFF:t+="NOTEOFF "+s.toNoteString(this.data[1]);break;case s.CONTROLLERCHANGE:t+="CC "+this.data[1]+" "+this.data[2];break;case s.PROGRAMCHANGE:t+="PC "+this.data[1];break;case s.PITCHBEND:t+="PITCHBEND "+this.getPitchBend();break;case s.KEYPRESSURE:t+="KEYPRESS "+this.data[1]}return t},s.prototype.toHexString=function(){for(var t=0;t<this.data.length;t++)this.data[t].toString(16)},s.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},s.NOTEOFF=128,s.NOTEON=144,s.KEYPRESSURE=160,s.CONTROLLERCHANGE=176,s.PROGRAMCHANGE=192,s.CHANNELPRESSURE=208,s.PITCHBEND=224,s.TIMETICK=248,s.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},s.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},s.commands_reversed={},s.commands)s.commands_reversed[s.commands[o]]=o;function r(t,e){if(!navigator.requestMIDIAccess)return this.error="not suppoorted",void(e?e("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags"));this.on_ready=t,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}function n(){this.addOutput("on_midi",e.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var t=this;new r((function(e){t._midi=e,t._waiting&&t.onStart(),t._waiting=!1}))}function a(){this.addInput("send",e.EVENT),this.properties={port:0};var t=this;new r((function(e){t._midi=e,t.widget.options.values=t.getMIDIOutputs()})),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}function u(){this.addInput("on_midi",e.EVENT),this._str="",this.size=[200,40]}function h(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var t=this;this._learning=!1,this.addWidget("button","Learn","",(function(){t._learning=!0,t.boxcolor="#FA3"})),this.addInput("in",e.EVENT),this.addOutput("on_midi",e.EVENT),this.boxcolor="#AAA"}function p(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",e.EVENT),this.addInput("assign",e.EVENT),this.addOutput("on_midi",e.EVENT),this.midi_event=new s,this.gate=!1}function l(){this.properties={cc:1,value:0},this.addOutput("value","number")}function d(){this.addInput("generate",e.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",e.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=d.processScale(this.properties.notes),this.sequence_index=0}function c(){this.properties={amount:0},this.addInput("in",e.ACTION),this.addInput("amount","number"),this.addOutput("out",e.EVENT),this.midi_event=new s}function _(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",e.ACTION),this.addInput("scale","string"),this.addOutput("out",e.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}function g(){this.properties={url:"",autoplay:!0},this.addInput("play",e.ACTION),this.addInput("pause",e.ACTION),this.addOutput("note",e.EVENT),this._midi=null,this._current_time=0,this._playing=!1,"undefined"==typeof MidiParser&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}function f(){if(this.properties={volume:.5,duration:1},this.addInput("note",e.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",e.EVENT),"undefined"==typeof AudioSynth)console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var t=this.synth=new AudioSynth;this.instrument=t.createInstrument("piano")}}function v(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",e.ACTION),this.addInput("reset",e.ACTION),this.addOutput("note",e.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}r.input=null,r.MIDIEvent=s,r.prototype.onMIDISuccess=function(t){console.log("MIDI ready!"),console.log(t),this.midi=t,this.updatePorts(),this.on_ready&&this.on_ready(this)},r.prototype.updatePorts=function(){var t,e=this.midi;this.input_ports=e.inputs,this.input_ports_info=[],this.output_ports=e.outputs,this.output_ports_info=[];for(var i=0,s=(t=this.input_ports.values()).next();s&&!1===s.done;){var o=s.value;this.input_ports_info.push(o),console.log("Input port [type:'"+o.type+"'] id:'"+o.id+"' manufacturer:'"+o.manufacturer+"' name:'"+o.name+"' version:'"+o.version+"'"),i++,s=t.next()}for(this.num_input_ports=i,i=0,s=(t=this.output_ports.values()).next();s&&!1===s.done;)o=s.value,this.output_ports_info.push(o),console.log("Output port [type:'"+o.type+"'] id:'"+o.id+"' manufacturer:'"+o.manufacturer+"' name:'"+o.name+"' version:'"+o.version+"'"),i++,s=t.next();this.num_output_ports=i},r.prototype.onMIDIFailure=function(t){console.error("Failed to get MIDI access - "+t)},r.prototype.openInputPort=function(t,e){var i=this.input_ports.get("input-"+t);if(!i)return!1;r.input=this;var o=this;return i.onmidimessage=function(t){var i=new s(t.data);o.updateState(i),e&&e(t.data,i),r.on_message&&r.on_message(t.data,i)},console.log("port open: ",i),!0},r.parseMsg=function(t){},r.prototype.updateState=function(t){switch(t.cmd){case s.NOTEON:this.state.note[0|t.value1]=t.value2;break;case s.NOTEOFF:this.state.note[0|t.value1]=0;break;case s.CONTROLLERCHANGE:this.state.cc[t.getCC()]=t.getCCValue()}},r.prototype.sendMIDI=function(t,e){if(e){var i=this.output_ports_info[t];i&&(r.output=this,e.constructor===s?i.send(e.data):i.send(e))}},n.MIDIInterface=r,n.title="MIDI Input",n.desc="Reads MIDI from a input port",n.color=i,n.prototype.getPropertyInfo=function(t){if(this._midi&&"port"==t){for(var e={},i=0;i<this._midi.input_ports_info.length;++i){var s=this._midi.input_ports_info[i];e[i]=i+".- "+s.name+" version:"+s.version}return{type:"enum",values:e}}},n.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},n.prototype.onMIDIEvent=function(t,i){this._last_midi_event=i,this.boxcolor="#AFA",this._last_time=e.getTime(),this.trigger("on_midi",i),i.cmd==s.NOTEON?this.trigger("on_noteon",i):i.cmd==s.NOTEOFF?this.trigger("on_noteoff",i):i.cmd==s.CONTROLLERCHANGE?this.trigger("on_cc",i):i.cmd==s.PROGRAMCHANGE?this.trigger("on_pc",i):i.cmd==s.PITCHBEND&&this.trigger("on_pitchbend",i)},n.prototype.onDrawBackground=function(t){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){t.fillStyle="white";var i=e.getTime(),s=1-Math.max(0,.001*(i-this._last_time));if(s>0){var o=t.globalAlpha;t.globalAlpha*=s,t.font="12px Tahoma",t.fillText(this._last_midi_event.toString(),2,.5*this.size[1]+3),t.globalAlpha=o}}},n.prototype.onExecute=function(){if(this.outputs)for(var t=this._last_midi_event,e=0;e<this.outputs.length;++e){var i=null;switch(this.outputs[e].name){case"midi":i=this._midi;break;case"last_midi":i=t;break;default:continue}this.setOutputData(e,i)}},n.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",e.EVENT],["on_noteon",e.EVENT],["on_noteoff",e.EVENT],["on_cc",e.EVENT],["on_pc",e.EVENT],["on_pitchbend",e.EVENT]]},e.registerNodeType("midi/input",n),a.MIDIInterface=r,a.title="MIDI Output",a.desc="Sends MIDI to output channel",a.color=i,a.prototype.onGetPropertyInfo=function(t){if(this._midi&&"port"==t)return{type:"enum",values:this.getMIDIOutputs()}},a.default_ports={0:"unknown"},a.prototype.getMIDIOutputs=function(){var t={};if(!this._midi)return a.default_ports;if(this._midi.output_ports_info)for(var e=0;e<this._midi.output_ports_info.length;++e){var i=this._midi.output_ports_info[e];if(i){var s=e+".- "+i.name+" version:"+i.version;t[e]=s}}return t},a.prototype.onAction=function(t,e){this._midi&&("send"==t&&this._midi.sendMIDI(this.properties.port,e),this.trigger("midi",e))},a.prototype.onGetInputs=function(){return[["send",e.ACTION]]},a.prototype.onGetOutputs=function(){return[["on_midi",e.EVENT]]},e.registerNodeType("midi/output",a),u.title="MIDI Show",u.desc="Shows MIDI in the graph",u.color=i,u.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},u.prototype.onAction=function(t,e){e&&(e.constructor===s?this._str=e.toString():this._str="???")},u.prototype.onDrawForeground=function(t){this._str&&!this.flags.collapsed&&(t.font="30px Arial",t.fillText(this._str,10,.8*this.size[1]))},u.prototype.onGetInputs=function(){return[["in",e.ACTION]]},u.prototype.onGetOutputs=function(){return[["on_midi",e.EVENT]]},e.registerNodeType("midi/show",u),h.title="MIDI Filter",h.desc="Filters MIDI messages",h.color=i,h["@cmd"]={type:"enum",title:"Command",values:s.commands_reversed},h.prototype.getTitle=function(){var t=null;return t=-1==this.properties.cmd?"Nothing":s.commands_short[this.properties.cmd]||"Unknown",-1!=this.properties.min_value&&-1!=this.properties.max_value&&(t+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+t},h.prototype.onPropertyChanged=function(t,e){if("cmd"==t){var i=Number(e);isNaN(i)&&(i=s.commands[e]||0),this.properties.cmd=i}},h.prototype.onAction=function(t,e){if(e&&e.constructor===s){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.min_value=this.properties.max_value=e.data[1];else{if(-1!=this.properties.channel&&e.channel!=this.properties.channel)return;if(-1!=this.properties.cmd&&e.cmd!=this.properties.cmd)return;if(-1!=this.properties.min_value&&e.data[1]<this.properties.min_value)return;if(-1!=this.properties.max_value&&e.data[1]>this.properties.max_value)return}this.trigger("on_midi",e)}},e.registerNodeType("midi/filter",h),p.title="MIDIEvent",p.desc="Create a MIDI Event",p.color=i,p.prototype.onAction=function(t,e){if("assign"==t)return this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.value1=e.data[1],this.properties.value2=e.data[2],void(e.cmd==s.NOTEON?this.gate=!0:e.cmd==s.NOTEOFF&&(this.gate=!1));(e=this.midi_event).channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?e.setCommandFromString(this.properties.cmd):e.cmd=this.properties.cmd,e.data[0]=e.cmd|e.channel,e.data[1]=Number(this.properties.value1),e.data[2]=Number(this.properties.value2),this.trigger("on_midi",e)},p.prototype.onExecute=function(){var t=this.properties;if(this.inputs)for(var e=0;e<this.inputs.length;++e){var i=this.inputs[e];if(-1!=i.link)switch(i.name){case"note":null!=(o=this.getInputData(e))&&(o.constructor===String&&(o=s.NoteStringToPitch(o)),this.properties.value1=(0|o)%255);break;case"cmd":null!=(o=this.getInputData(e))&&(this.properties.cmd=o);break;case"value1":null!=(o=this.getInputData(e))&&(this.properties.value1=Math.clamp(0|o,0,127));break;case"value2":null!=(o=this.getInputData(e))&&(this.properties.value2=Math.clamp(0|o,0,127))}}if(this.outputs)for(e=0;e<this.outputs.length;++e){var o=null;switch(this.outputs[e].name){case"midi":(o=new s).setup([t.cmd,t.value1,t.value2]),o.channel=t.channel;break;case"command":o=t.cmd;break;case"cc":o=t.value1;break;case"cc_value":o=t.value2;break;case"note":o=t.cmd==s.NOTEON||t.cmd==s.NOTEOFF?t.value1:null;break;case"velocity":o=t.cmd==s.NOTEON?t.value2:null;break;case"pitch":o=t.cmd==s.NOTEON?s.computePitch(t.value1):null;break;case"pitchbend":o=t.cmd==s.PITCHBEND?s.computePitchBend(t.value1,t.value2):null;break;case"gate":o=this.gate;break;default:continue}null!==o&&this.setOutputData(e,o)}},p.prototype.onPropertyChanged=function(t,e){"cmd"==t&&(this.properties.cmd=s.computeCommandFromString(e))},p.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},p.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",e.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},e.registerNodeType("midi/event",p),l.title="MIDICC",l.desc="gets a Controller Change",l.color=i,l.prototype.onExecute=function(){this.properties,r.input&&(this.properties.value=r.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},e.registerNodeType("midi/cc",l),d.title="MIDI Generator",d.desc="Generates a random MIDI note",d.color=i,d.processScale=function(t){for(var i=t.split(","),o=0;o<i.length;++o){var r=i[o];2==r.length&&"#"!=r[1]||r.length>2?i[o]=-e.MIDIEvent.NoteStringToPitch(r):i[o]=s.note_to_index[r]||0}return i},d.prototype.onPropertyChanged=function(t,e){"notes"==t&&(this.notes_pitches=d.processScale(e))},d.prototype.onExecute=function(){var t=this.getInputData(2);null!=t&&(this.properties.octave=t);var e=this.getInputData(1);e&&(this.notes_pitches=d.processScale(e))},d.prototype.onAction=function(t,e){var i,o=this.notes_pitches.length,r=0;"sequence"==this.properties.mode?r=this.sequence_index=(this.sequence_index+1)%o:"random"==this.properties.mode&&(r=Math.floor(Math.random()*o));var n=this.notes_pitches[r];i=n>=0?n+12*(this.properties.octave-1)+33:-n,(e=new s).setup([s.NOTEON,i,10]);var a=this.properties.duration||1;this.trigger("note",e),setTimeout(function(){var t=new s;t.setup([s.NOTEOFF,i,0]),this.trigger("note",t)}.bind(this),1e3*a)},e.registerNodeType("midi/generator",d),c.title="MIDI Transpose",c.desc="Transpose a MIDI note",c.color=i,c.prototype.onAction=function(t,e){e&&e.constructor===s&&(e.data[0]==s.NOTEON||e.data[0]==s.NOTEOFF?(this.midi_event=new s,this.midi_event.setup(e.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",e))},c.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&(this.properties.amount=t)},e.registerNodeType("midi/transpose",c),_.title="MIDI Quantize Pitch",_.desc="Transpose a MIDI note tp fit an scale",_.color=i,_.prototype.onPropertyChanged=function(t,e){"scale"==t&&this.processScale(e)},_.prototype.processScale=function(t){this._current_scale=t,this.notes_pitches=d.processScale(t);for(var e=0;e<12;++e)this.valid_notes[e]=-1!=this.notes_pitches.indexOf(e);for(e=0;e<12;++e)if(this.valid_notes[e])this.offset_notes[e]=0;else for(var i=1;i<12;++i){if(this.valid_notes[(e-i)%12]){this.offset_notes[e]=-i;break}if(this.valid_notes[(e+i)%12]){this.offset_notes[e]=i;break}}},_.prototype.onAction=function(t,e){if(e&&e.constructor===s)if(e.data[0]==s.NOTEON||e.data[0]==s.NOTEOFF){this.midi_event=new s,this.midi_event.setup(e.data);var i=e.note,o=s.note_to_index[i],r=this.offset_notes[o];this.midi_event.data[1]+=r,this.trigger("out",this.midi_event)}else this.trigger("out",e)},_.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&t!=this._current_scale&&this.processScale(t)},e.registerNodeType("midi/quantize",_),g.title="MIDI fromFile",g.desc="Plays a MIDI file",g.color=i,g.prototype.onAction=function(t){"play"==t?this.play():"pause"==t&&(this._playing=!this._playing)},g.prototype.onPropertyChanged=function(t,e){"url"==t&&this.loadMIDIFile(e)},g.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var t=100*this._current_time,e=0;e<this._midi.tracks;++e){var i=this._midi.track[e];i._last_pos||(i._last_pos=0,i._time=0);var o=i.event[i._last_pos];if(o&&i._time+o.deltaTime<=t&&(i._last_pos++,i._time+=o.deltaTime,o.data)){var r=o.type<<4+o.channel,n=new s;n.setup([r,o.data[0],o.data[1]]),this.trigger("note",n)}}}},g.prototype.play=function(){if(this._playing=!0,this._current_time=0,this._midi)for(var t=0;t<this._midi.tracks;++t){var e=this._midi.track[t];e._last_pos=0,e._time=0}},g.prototype.loadMIDIFile=function(t){var i=this;e.fetchFile(t,"arraybuffer",(function(t){i.boxcolor="#AFA",i._midi=MidiParser.parse(new Uint8Array(t)),i.properties.autoplay&&i.play()}),(function(t){i.boxcolor="#FAA",i._midi=null}))},g.prototype.onDropFile=function(t){this.properties.url="",this.loadMIDIFile(t)},e.registerNodeType("midi/fromFile",g),f.title="MIDI Play",f.desc="Plays a MIDI note",f.color=i,f.prototype.onAction=function(t,e){if(e&&e.constructor===s){if(this.instrument&&e.data[0]==s.NOTEON){var i=e.note;if(!i||"undefined"==i||i.constructor!==String)return;this.instrument.play(i,e.octave,this.properties.duration,this.properties.volume)}this.trigger("note",e)}},f.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&(this.properties.volume=t);var e=this.getInputData(2);null!=e&&(this.properties.duration=e)},e.registerNodeType("midi/play",f),v.title="MIDI Keys",v.desc="Keyboard to play notes",v.color=i,v.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],v.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=12*this.properties.num_octaves;this.keys.length=e;var i=this.size[0]/(7*this.properties.num_octaves),s=this.size[1];t.globalAlpha=1;for(var o=0;o<2;o++)for(var r=0;r<e;++r){var n=v.keys[r%12];if(n.t==o){var a=7*Math.floor(r/12)*i+n.x*i;t.fillStyle=0==o?this.keys[r]?"#CCC":"white":this.keys[r]?"#333":"black",t.fillRect(a+1,0,i*n.w-2,s*n.h)}}}},v.prototype.getKeyIndex=function(t){this.properties.num_octaves;for(var e=this.size[0]/(7*this.properties.num_octaves),i=this.size[1],s=1;s>=0;s--)for(var o=0;o<this.keys.length;++o){var r=v.keys[o%12];if(r.t==s){var n=7*Math.floor(o/12)*e+r.x*e,a=e*r.w,u=i*r.h;if(!(t[0]<n||t[0]>n+a||t[1]>u))return o}}return-1},v.prototype.onAction=function(t,e){if("reset"!=t){if(e&&e.constructor===s){var i=e,o=12*(this.properties.start_octave-1)+29,r=i.data[1]-o;r>=0&&r<this.keys.length&&(i.data[0]==s.NOTEON?this.keys[r]=!0:i.data[0]==s.NOTEOFF&&(this.keys[r]=!1)),this.trigger("note",i)}}else for(var n=0;n<this.keys.length;++n)this.keys[n]=!1},v.prototype.onMouseDown=function(t,e){if(!(e[1]<0)){var i=this.getKeyIndex(e);this.keys[i]=!0,this._last_key=i;var o=12*(this.properties.start_octave-1)+29+i,r=new s;return r.setup([s.NOTEON,o,100]),this.trigger("note",r),!0}},v.prototype.onMouseMove=function(t,e){if(!(e[1]<0||-1==this._last_key)){this.setDirtyCanvas(!0);var i=this.getKeyIndex(e);if(this._last_key==i)return!0;this.keys[this._last_key]=!1;var o,r=12*(this.properties.start_octave-1)+29+this._last_key;return(o=new s).setup([s.NOTEOFF,r,100]),this.trigger("note",o),this.keys[i]=!0,r=12*(this.properties.start_octave-1)+29+i,(o=new s).setup([s.NOTEON,r,100]),this.trigger("note",o),this._last_key=i,!0}},v.prototype.onMouseUp=function(t,e){if(!(e[1]<0)){var i=this.getKeyIndex(e);this.keys[i]=!1,this._last_key=-1;var o=12*(this.properties.start_octave-1)+29+i,r=new s;return r.setup([s.NOTEOFF,o,100]),this.trigger("note",r),!0}},e.registerNodeType("midi/keys",v)}(this),function(t){var e=t.LiteGraph,i={};function s(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=i.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}function o(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=i.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}function r(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var t=i.getAudioContext();this.audionode=t.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}function n(){this.properties={gain:1},this.audionode=i.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}function a(){this.properties={impulse_src:"",normalize:!0},this.audionode=i.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}function u(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=i.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}function h(){this.properties={},this.audionode=i.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}function p(){this.properties={gain1:.5,gain2:.5},this.audionode=i.getAudioContext().createGain(),this.audionode1=i.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=i.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}function l(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=i.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","bool"),this.addOutput("out","audio"),this.gate=!1}function d(){this.properties={delayTime:.5},this.audionode=i.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}function c(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=i.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}function _(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=i.getAudioContext().createOscillator(),this.addOutput("out","audio")}function g(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}function f(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}function v(){if(!v.default_code){var t=v.default_function.toString(),e=t.indexOf("{")+1,s=t.lastIndexOf("}");v.default_code=t.substr(e,s-e)}this.properties={code:v.default_code};var o=i.getAudioContext();o.createScriptProcessor?this.audionode=o.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=o.createGain()),this.processCode(),v._bypass_function||(v._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}function m(){this.audionode=i.getAudioContext().destination,this.addInput("in","audio")}t.LGAudio=i,i.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(t){console.log("msg",t)},this._audio_context.onended=function(t){console.log("ended",t)},this._audio_context.oncomplete=function(t){console.log("complete",t)}}return this._audio_context},i.connect=function(t,e){try{t.connect(e)}catch(t){console.warn("LGraphAudio:",t)}},i.disconnect=function(t,e){try{t.disconnect(e)}catch(t){console.warn("LGraphAudio:",t)}},i.changeAllAudiosConnections=function(t,e){if(t.inputs)for(var s=0;s<t.inputs.length;++s){var o=t.inputs[s];if(p=t.graph.links[o.link]){var r=t.graph.getNodeById(p.origin_id),n=null;n=r.getAudioNodeInOutputSlot?r.getAudioNodeInOutputSlot(p.origin_slot):r.audionode;var a=null;a=t.getAudioNodeInInputSlot?t.getAudioNodeInInputSlot(s):t.audionode,e?i.connect(n,a):i.disconnect(n,a)}}if(t.outputs)for(s=0;s<t.outputs.length;++s)for(var u=t.outputs[s],h=0;h<u.links.length;++h){var p;if(p=t.graph.links[u.links[h]]){n=null,n=t.getAudioNodeInOutputSlot?t.getAudioNodeInOutputSlot(s):t.audionode;var l=t.graph.getNodeById(p.target_id);a=null,a=l.getAudioNodeInInputSlot?l.getAudioNodeInInputSlot(p.target_slot):l.audionode,e?i.connect(n,a):i.disconnect(n,a)}}},i.onConnectionsChange=function(t,s,o,r){if(t==e.OUTPUT){var n=null;if(r&&(n=this.graph.getNodeById(r.target_id)),n){var a;a=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(s):this.audionode;var u;u=n.getAudioNodeInInputSlot?n.getAudioNodeInInputSlot(r.target_slot):n.audionode,o?i.connect(a,u):i.disconnect(a,u)}}},i.createAudioNodeWrapper=function(t){var e=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(t,i){e&&e.call(this,t,i),this.audionode&&void 0!==this.audionode[t]&&(void 0!==this.audionode[t].value?this.audionode[t].value=i:this.audionode[t]=i)},t.prototype.onConnectionsChange=i.onConnectionsChange},i.cached_audios={},i.loadSound=function(t,e,s){if(!i.cached_audios[t]||-1!=t.indexOf("blob:")){i.onProcessAudioURL&&(t=i.onProcessAudioURL(t));var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer";var r=i.getAudioContext();return o.onload=function(){console.log("AudioSource loaded"),r.decodeAudioData(o.response,(function(s){console.log("AudioSource decoded"),i.cached_audios[t]=s,e&&e(s)}),n)},o.send(),o}function n(t){console.log("Audio loading sample error:",t),s&&s(t)}e&&e(i.cached_audios[t])},s.desc="Plays an audio file",s["@src"]={widget:"resource"},s.supported_extensions=["wav","ogg","mp3"],s.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},s.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},s.prototype.onStop=function(){this.stopAllSounds()},s.prototype.onPause=function(){this.pauseAllSounds()},s.prototype.onUnpause=function(){this.unpauseAllSounds()},s.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},s.prototype.stopAllSounds=function(){for(var t=0;t<this._audionodes.length;++t)this._audionodes[t].started&&(this._audionodes[t].started=!1,this._audionodes[t].stop());this._audionodes.length=0},s.prototype.pauseAllSounds=function(){i.getAudioContext().suspend()},s.prototype.unpauseAllSounds=function(){i.getAudioContext().resume()},s.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);if(void 0!==i)if("gain"==e.name)this.audionode.gain.value=i;else if("src"==e.name)this.setProperty("src",i);else if("playbackRate"==e.name){this.properties.playbackRate=i;for(var s=0;s<this._audionodes.length;++s)this._audionodes[s].playbackRate.value=i}}}if(this.outputs)for(t=0;t<this.outputs.length;++t)"buffer"==this.outputs[t].name&&this._audiobuffer&&this.setOutputData(t,this._audiobuffer)},s.prototype.onAction=function(t){this._audiobuffer&&("Play"==t?this.playBuffer(this._audiobuffer):"Stop"==t&&this.stopAllSounds())},s.prototype.onPropertyChanged=function(t,e){if("src"==t)this.loadSound(e);else if("gain"==t)this.audionode.gain.value=e;else if("playbackRate"==t)for(var i=0;i<this._audionodes.length;++i)this._audionodes[i].playbackRate.value=e},s.prototype.playBuffer=function(t){var e=this,s=i.getAudioContext().createBufferSource();return this._last_sourcenode=s,s.graphnode=this,s.buffer=t,s.loop=this.properties.loop,s.playbackRate.value=this.properties.playbackRate,this._audionodes.push(s),s.connect(this.audionode),this._audionodes.push(s),this.trigger("start"),s.onended=function(){e.trigger("ended");var t=e._audionodes.indexOf(s);-1!=t&&e._audionodes.splice(t,1)},s.started||(s.started=!0,s.start()),s},s.prototype.loadSound=function(t){var s=this;this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,t&&(this._request=i.loadSound(t,(function(t){this.boxcolor=e.NODE_DEFAULT_BOXCOLOR,s._audiobuffer=t,s._loading_audio=!1,s.graph&&s.graph.status===LGraph.STATUS_RUNNING&&s.onStart()})),this._loading_audio=!0,this.boxcolor="#AA4")},s.prototype.onConnectionsChange=i.onConnectionsChange,s.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",e.ACTION],["Stop",e.ACTION]]},s.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",e.EVENT],["ended",e.EVENT]]},s.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var e=URL.createObjectURL(t);this.properties.src=e,this.loadSound(e),this._dropped_url=e},s.title="Source",s.desc="Plays audio",e.registerNodeType("audio/source",s),o.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},o.prototype.onStart=function(){null!=this._media_stream||this._waiting_confirmation||this.openStream()},o.prototype.onStop=function(){this.audionode.gain.value=0},o.prototype.onPause=function(){this.audionode.gain.value=0},o.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},o.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var t=this._media_stream.getTracks();t.length&&t[0].stop()}},o.prototype.openStream=function(){if(navigator.mediaDevices){this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch((function(e){console.log("Media rejected",e),t._media_stream=!1,t.boxcolor="red"}));var t=this}else console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")},o.prototype.streamReady=function(t){this._media_stream=t,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var e=i.getAudioContext();this.audiosource_node=e.createMediaStreamSource(t),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},o.prototype.onExecute=function(){if(null!=this._media_stream||this._waiting_confirmation||this.openStream(),this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);void 0!==i&&"gain"==e.name&&(this.audionode.gain.value=this.properties.gain=i)}}},o.prototype.onAction=function(t){"Play"==t?this.audionode.gain.value=this.properties.gain:"Stop"==t&&(this.audionode.gain.value=0)},o.prototype.onPropertyChanged=function(t,e){"gain"==t&&(this.audionode.gain.value=e)},o.prototype.onConnectionsChange=i.onConnectionsChange,o.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",e.ACTION],["Stop",e.ACTION]]},o.title="MediaSource",o.desc="Plays microphone",e.registerNodeType("audio/media_source",o),r.prototype.onPropertyChanged=function(t,e){this.audionode[t]=e},r.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.audionode.frequencyBinCount;this._freq_bin&&this._freq_bin.length==t||(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}this.isOutputConnected(1)&&(t=this.audionode.frequencyBinCount,this._time_bin&&this._time_bin.length==t||(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin));for(var e=1;e<this.inputs.length;++e){var i=this.inputs[e];if(null!=i.link){var s=this.getInputData(e);void 0!==s&&(this.audionode[i.name].value=s)}}},r.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},r.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},r.title="Analyser",r.desc="Audio Analyser",e.registerNodeType("audio/analyser",r),n.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t],i=this.getInputData(t);void 0!==i&&(this.audionode[e.name].value=i)}},i.createAudioNodeWrapper(n),n.title="Gain",n.desc="Audio gain",e.registerNodeType("audio/gain",n),i.createAudioNodeWrapper(a),a.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},a.prototype.onPropertyChanged=function(t,e){"impulse_src"==t?this.loadImpulse(e):"normalize"==t&&(this.audionode.normalize=e)},a.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},a.prototype.loadImpulse=function(t){var e=this;this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,t&&(this._request=i.loadSound(t,(function(t){e._impulse_buffer=t,e.audionode.buffer=t,console.log("Impulse signal set"),e._loading_impulse=!1})),this._loading_impulse=!0)},a.title="Convolver",a.desc="Convolves the signal (used for reverb)",e.registerNodeType("audio/convolver",a),i.createAudioNodeWrapper(u),u.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);void 0!==i&&(this.audionode[e.name].value=i)}}},u.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},u.title="DynamicsCompressor",u.desc="Dynamics Compressor",e.registerNodeType("audio/dynamicsCompressor",u),h.prototype.onExecute=function(){if(this.inputs&&this.inputs.length){var t=this.getInputData(1);void 0!==t&&(this.audionode.curve=t)}},h.prototype.setWaveShape=function(t){this.audionode.curve=t},i.createAudioNodeWrapper(h),p.prototype.getAudioNodeInInputSlot=function(t){return 0==t?this.audionode1:2==t?this.audionode2:void 0},p.prototype.onPropertyChanged=function(t,e){"gain1"==t?this.audionode1.gain.value=e:"gain2"==t&&(this.audionode2.gain.value=e)},p.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link&&"audio"!=e.type){var i=this.getInputData(t);void 0!==i&&(1==t?this.audionode1.gain.value=i:3==t&&(this.audionode2.gain.value=i))}}},i.createAudioNodeWrapper(p),p.title="Mixer",p.desc="Audio mixer",e.registerNodeType("audio/mixer",p),l.prototype.onExecute=function(){var t=i.getAudioContext().currentTime,e=this.audionode.gain,s=this.getInputData(1),o=this.getInputOrProperty("A"),r=this.getInputOrProperty("D"),n=this.getInputOrProperty("S"),a=this.getInputOrProperty("R");!this.gate&&s?(e.cancelScheduledValues(0),e.setValueAtTime(0,t),e.linearRampToValueAtTime(1,t+o),e.linearRampToValueAtTime(n,t+o+r)):this.gate&&!s&&(e.cancelScheduledValues(0),e.setValueAtTime(e.value,t),e.linearRampToValueAtTime(0,t+a)),this.gate=s},l.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},i.createAudioNodeWrapper(l),l.title="ADSR",l.desc="Audio envelope",e.registerNodeType("audio/adsr",l),i.createAudioNodeWrapper(d),d.prototype.onExecute=function(){var t=this.getInputData(1);void 0!==t&&(this.audionode.delayTime.value=t)},d.title="Delay",d.desc="Audio delay",e.registerNodeType("audio/delay",d),c.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);void 0!==i&&(this.audionode[e.name].value=i)}}},c.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},i.createAudioNodeWrapper(c),c.title="BiquadFilter",c.desc="Audio filter",e.registerNodeType("audio/biquadfilter",c),_.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch(t){}}},_.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},_.prototype.onPause=function(){this.onStop()},_.prototype.onUnpause=function(){this.onStart()},_.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);void 0!==i&&(this.audionode[e.name].value=i)}}},_.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},i.createAudioNodeWrapper(_),_.title="Oscillator",_.desc="Oscillator",e.registerNodeType("audio/oscillator",_),g.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);void 0!==t&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)},g.prototype.onDrawForeground=function(t){if(this._last_buffer){var e=this._last_buffer,s=e.length/this.size[0],o=this.size[1];t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();var r=0;if(this.properties.continuous){t.moveTo(r,o);for(var n=0;n<e.length;n+=s)t.lineTo(r,o-e[0|n]/255*o),r++}else for(n=0;n<e.length;n+=s)t.moveTo(r+.5,o),t.lineTo(r+.5,o-e[0|n]/255*o),r++;if(t.stroke(),this.properties.mark>=0){var a=i.getAudioContext().sampleRate/e.length;(r=this.properties.mark/a*2/s)>=this.size[0]&&(r=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(r,o),t.lineTo(r,0),t.stroke()}}},g.title="Visualization",g.desc="Audio Visualization",e.registerNodeType("audio/visualization",g),f.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),this._freqs){var t=this.properties.band;void 0!==(s=this.getInputData(1))&&(t=s);var e=t/(i.getAudioContext().sampleRate/this._freqs.length)*2,s=0;if(e<0&&(s=this._freqs[0]),e>=this._freqs.length)s=this._freqs[this._freqs.length-1];else{var o=0|e,r=e-o;s=this._freqs[o]*(1-r)+this._freqs[o+1]*r}this.setOutputData(0,s/255*this.properties.amplitude)}},f.prototype.onGetInputs=function(){return[["band","number"]]},f.title="Signal",f.desc="extract the signal of some frequency",e.registerNodeType("audio/signal",f),v.prototype.onAdded=function(t){t.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},v["@code"]={widget:"code",type:"code"},v.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},v.prototype.onStop=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.onPause=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},v.prototype.onExecute=function(){},v.prototype.onRemoved=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.processCode=function(){try{var t=new Function("properties",this.properties.code);this._script=new t(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(t){console.error("Error in onaudioprocess code",t),this._callback=v._bypass_function,this.audionode.onaudioprocess=this._callback}},v.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},v.default_function=function(){this.onaudioprocess=function(t){for(var e=t.inputBuffer,i=t.outputBuffer,s=0;s<i.numberOfChannels;s++)for(var o=e.getChannelData(s),r=i.getChannelData(s),n=0;n<e.length;n++)r[n]=o[n]}},i.createAudioNodeWrapper(v),v.title="Script",v.desc="apply script to signal",e.registerNodeType("audio/script",v),m.title="Destination",m.desc="Audio output",e.registerNodeType("audio/destination",m)}(this),function(t){var e=t.LiteGraph;function i(){this.size=[60,20],this.addInput("send",e.ACTION),this.addOutput("received",e.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}function s(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",e.ACTION),this.addOutput("received",e.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],"undefined"==typeof SillyClient&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}i.title="WebSocket",i.desc="Send data through a websocket",i.prototype.onPropertyChanged=function(t,e){"url"==t&&this.connectSocket()},i.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){for(var t=this.properties.room,e=this.properties.only_send_changes,i=1;i<this.inputs.length;++i){var s=this.getInputData(i);if(null!=s){var o;try{o=JSON.stringify({type:0,room:t,channel:i,data:s})}catch(t){continue}e&&this._last_sent_data[i]==o||(this._last_sent_data[i]=o,this._ws.send(o))}}for(i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},i.prototype.connectSocket=function(){var t=this,i=this.properties.url;"ws"!=i.substr(0,2)&&(i="ws://"+i),this._ws=new WebSocket(i),this._ws.onopen=function(){console.log("ready"),t.boxcolor="#6C6"},this._ws.onmessage=function(i){t.boxcolor="#AFA";var s=JSON.parse(i.data);if(!s.room||s.room==t.properties.room)if(1==s.type)if(s.data.object_class&&e[s.data.object_class]){var o=null;try{o=new e[s.data.object_class](s.data),t.triggerSlot(0,o)}catch(t){return}}else t.triggerSlot(0,s.data);else t._last_received_data[s.channel||0]=s.data},this._ws.onerror=function(e){console.log("couldnt connect to websocket"),t.boxcolor="#E88"},this._ws.onclose=function(e){console.log("connection closed"),t.boxcolor="#000"}},i.prototype.send=function(t){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:t}))},i.prototype.onAction=function(t,e){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:t,data:e})},i.prototype.onGetInputs=function(){return[["in",0]]},i.prototype.onGetOutputs=function(){return[["out",0]]},e.registerNodeType("network/websocket",i),s.title="SillyClient",s.desc="Connects to SillyServer to broadcast messages",s.prototype.onPropertyChanged=function(t,e){"room"==t&&(this.room_widget.value=e),this.connectSocket()},s.prototype.setRoom=function(t){this.properties.room=t,this.room_widget.value=t,this.connectSocket()},s.prototype.onDrawForeground=function(){for(var t=1;t<this.inputs.length;++t)this.inputs[t].label="in_"+t;for(t=1;t<this.outputs.length;++t)this.outputs[t].label="out_"+t},s.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var t=this.properties.only_send_changes,e=1;e<this.inputs.length;++e){var i=this.getInputData(e),s=this._last_sent_data[e];if(null!=i){if(t){var o=!0;if(i&&i.length&&s&&s.length==i.length&&i.constructor!==String){for(var r=0;r<i.length;++r)if(s[r]!=i[r]){o=!1;break}}else this._last_sent_data[e]!=i&&(o=!1);if(o)continue}if(this._server.sendMessage({type:0,channel:e,data:i}),i.length&&i.constructor!==String)if(this._last_sent_data[e])for(this._last_sent_data[e].length=i.length,r=0;r<i.length;++r)this._last_sent_data[e][r]=i[r];else i.constructor===Array?this._last_sent_data[e]=i.concat():this._last_sent_data[e]=new i.constructor(i);else this._last_sent_data[e]=i}}for(e=1;e<this.outputs.length;++e)this.setOutputData(e,this._last_received_data[e]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},s.prototype.connectSocket=function(){var t=this;if("undefined"==typeof SillyClient)return this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),void(this._error=!0);if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),t.boxcolor="#6C6"},this._server.on_message=function(i,s){var o=null;try{o=JSON.parse(s)}catch(t){return}if(1==o.type)if(o.data.object_class&&e[o.data.object_class]){var r=null;try{r=new e[o.data.object_class](o.data),t.triggerSlot(0,r)}catch(t){return}}else t.triggerSlot(0,o.data);else t._last_received_data[o.channel||0]=o.data;t.boxcolor="#AFA"},this._server.on_error=function(e){console.log("couldnt connect to websocket"),t.boxcolor="#E88"},this._server.on_close=function(e){console.log("connection closed"),t.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(t){return console.error("SillyServer error: "+t),void(this._server=null)}this._final_url=this.properties.url+"/"+this.properties.room}},s.prototype.send=function(t){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,data:t})},s.prototype.onAction=function(t,e){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:t,data:e})},s.prototype.onGetInputs=function(){return[["in",0]]},s.prototype.onGetOutputs=function(){return[["out",0]]},e.registerNodeType("network/sillyclient",s)}(this)},155:t=>{var e,i,s=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function n(t){if(e===setTimeout)return setTimeout(t,0);if((e===o||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(i){try{return e.call(null,t,0)}catch(i){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:o}catch(t){e=o}try{i="function"==typeof clearTimeout?clearTimeout:r}catch(t){i=r}}();var a,u=[],h=!1,p=-1;function l(){h&&a&&(h=!1,a.length?u=a.concat(u):p=-1,u.length&&d())}function d(){if(!h){var t=n(l);h=!0;for(var e=u.length;e;){for(a=u,u=[];++p<e;)a&&a[p].run();p=-1,e=u.length}a=null,h=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===r||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function c(t,e){this.fun=t,this.array=e}function _(){}s.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];u.push(new c(t,e)),1!==u.length||h||n(d)},c.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=_,s.addListener=_,s.once=_,s.off=_,s.removeListener=_,s.removeAllListeners=_,s.emit=_,s.prependListener=_,s.prependOnceListener=_,s.listeners=function(t){return[]},s.binding=function(t){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(t){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}}},e={};function s(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i].call(r.exports,r,r.exports,s),r.exports}(()=>{"use strict";const t=s(842),e=document.getElementById("mycanvas");if(!(e instanceof HTMLCanvasElement))throw new Error('The element of id "mycanvas" is not a HTMLCanvasElement. Make sure a <canvas id="mycanvas"> element is present in the document.');window.addEventListener("load",(()=>{e.height=window.innerHeight-20,e.width=window.innerWidth-20;var i=new t.LGraph;new t.LGraphCanvas(e,i),t.LiteGraph.clearRegisteredTypes(),i.start()})),window.addEventListener("resize",(()=>{e.height=window.innerHeight-20,e.width=window.innerWidth-20}))})()})();